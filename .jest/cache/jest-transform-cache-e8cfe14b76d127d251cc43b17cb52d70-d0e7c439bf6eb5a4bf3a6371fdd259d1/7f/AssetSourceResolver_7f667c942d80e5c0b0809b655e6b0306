4855521000b15fe2c37eacd0fd45a68c
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var PixelRatio = require('../Utilities/PixelRatio');

var Platform = require('../Utilities/Platform');

var assetPathUtils = require('./assetPathUtils');

var invariant = require('invariant');

function getScaledAssetPath(asset) {
  var scale = AssetSourceResolver.pickScale(asset.scales, PixelRatio.get());
  var scaleSuffix = scale === 1 ? '' : '@' + scale + 'x';
  var assetDir = assetPathUtils.getBasePath(asset);
  return assetDir + '/' + asset.name + scaleSuffix + '.' + asset.type;
}

function getAssetPathInDrawableFolder(asset) {
  var scale = AssetSourceResolver.pickScale(asset.scales, PixelRatio.get());
  var drawbleFolder = assetPathUtils.getAndroidResourceFolderName(asset, scale);
  var fileName = assetPathUtils.getAndroidResourceIdentifier(asset);
  return drawbleFolder + '/' + fileName + '.' + asset.type;
}

var AssetSourceResolver = function () {
  function AssetSourceResolver(serverUrl, jsbundleUrl, asset) {
    (0, _classCallCheck2.default)(this, AssetSourceResolver);
    this.serverUrl = serverUrl;
    this.jsbundleUrl = jsbundleUrl;
    this.asset = asset;
  }

  (0, _createClass2.default)(AssetSourceResolver, [{
    key: "isLoadedFromServer",
    value: function isLoadedFromServer() {
      return !!this.serverUrl;
    }
  }, {
    key: "isLoadedFromFileSystem",
    value: function isLoadedFromFileSystem() {
      return !!(this.jsbundleUrl && this.jsbundleUrl.startsWith('file://'));
    }
  }, {
    key: "defaultAsset",
    value: function defaultAsset() {
      if (this.isLoadedFromServer()) {
        return this.assetServerURL();
      }

      if (Platform.OS === 'android') {
        return this.isLoadedFromFileSystem() ? this.drawableFolderInBundle() : this.resourceIdentifierWithoutScale();
      } else {
        return this.scaledAssetURLNearBundle();
      }
    }
  }, {
    key: "assetServerURL",
    value: function assetServerURL() {
      invariant(!!this.serverUrl, 'need server to load from');
      return this.fromSource(this.serverUrl + getScaledAssetPath(this.asset) + '?platform=' + Platform.OS + '&hash=' + this.asset.hash);
    }
  }, {
    key: "scaledAssetPath",
    value: function scaledAssetPath() {
      return this.fromSource(getScaledAssetPath(this.asset));
    }
  }, {
    key: "scaledAssetURLNearBundle",
    value: function scaledAssetURLNearBundle() {
      var path = this.jsbundleUrl || 'file://';
      return this.fromSource(path + getScaledAssetPath(this.asset));
    }
  }, {
    key: "resourceIdentifierWithoutScale",
    value: function resourceIdentifierWithoutScale() {
      invariant(Platform.OS === 'android', 'resource identifiers work on Android');
      return this.fromSource(assetPathUtils.getAndroidResourceIdentifier(this.asset));
    }
  }, {
    key: "drawableFolderInBundle",
    value: function drawableFolderInBundle() {
      var path = this.jsbundleUrl || 'file://';
      return this.fromSource(path + getAssetPathInDrawableFolder(this.asset));
    }
  }, {
    key: "fromSource",
    value: function fromSource(source) {
      return {
        __packager_asset: true,
        width: this.asset.width,
        height: this.asset.height,
        uri: source,
        scale: AssetSourceResolver.pickScale(this.asset.scales, PixelRatio.get())
      };
    }
  }], [{
    key: "pickScale",
    value: function pickScale(scales, deviceScale) {
      for (var i = 0; i < scales.length; i++) {
        if (scales[i] >= deviceScale) {
          return scales[i];
        }
      }

      return scales[scales.length - 1] || 1;
    }
  }]);
  return AssetSourceResolver;
}();

module.exports = AssetSourceResolver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFzc2V0U291cmNlUmVzb2x2ZXIuanMiXSwibmFtZXMiOlsiUGl4ZWxSYXRpbyIsInJlcXVpcmUiLCJQbGF0Zm9ybSIsImFzc2V0UGF0aFV0aWxzIiwiaW52YXJpYW50IiwiZ2V0U2NhbGVkQXNzZXRQYXRoIiwiYXNzZXQiLCJzY2FsZSIsIkFzc2V0U291cmNlUmVzb2x2ZXIiLCJwaWNrU2NhbGUiLCJzY2FsZXMiLCJnZXQiLCJzY2FsZVN1ZmZpeCIsImFzc2V0RGlyIiwiZ2V0QmFzZVBhdGgiLCJuYW1lIiwidHlwZSIsImdldEFzc2V0UGF0aEluRHJhd2FibGVGb2xkZXIiLCJkcmF3YmxlRm9sZGVyIiwiZ2V0QW5kcm9pZFJlc291cmNlRm9sZGVyTmFtZSIsImZpbGVOYW1lIiwiZ2V0QW5kcm9pZFJlc291cmNlSWRlbnRpZmllciIsInNlcnZlclVybCIsImpzYnVuZGxlVXJsIiwic3RhcnRzV2l0aCIsImlzTG9hZGVkRnJvbVNlcnZlciIsImFzc2V0U2VydmVyVVJMIiwiT1MiLCJpc0xvYWRlZEZyb21GaWxlU3lzdGVtIiwiZHJhd2FibGVGb2xkZXJJbkJ1bmRsZSIsInJlc291cmNlSWRlbnRpZmllcldpdGhvdXRTY2FsZSIsInNjYWxlZEFzc2V0VVJMTmVhckJ1bmRsZSIsImZyb21Tb3VyY2UiLCJoYXNoIiwicGF0aCIsInNvdXJjZSIsIl9fcGFja2FnZXJfYXNzZXQiLCJ3aWR0aCIsImhlaWdodCIsInVyaSIsImRldmljZVNjYWxlIiwiaSIsImxlbmd0aCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOzs7Ozs7OztBQVlBLElBQU1BLFVBQVUsR0FBR0MsT0FBTyxDQUFDLHlCQUFELENBQTFCOztBQUNBLElBQU1DLFFBQVEsR0FBR0QsT0FBTyxDQUFDLHVCQUFELENBQXhCOztBQUVBLElBQU1FLGNBQWMsR0FBR0YsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQUNBLElBQU1HLFNBQVMsR0FBR0gsT0FBTyxDQUFDLFdBQUQsQ0FBekI7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S0ssVUFBTCxDQUNMN0IsY0FBYyxDQUFDa0IsNEJBQWYsQ0FBNEMsS0FBS2YsS0FBakQsQ0FESyxDQUFQO0FBR0Q7Ozs2Q0FPNkM7QUFDNUMsVUFBTTRCLElBQUksR0FBRyxLQUFLWCxXQUFMLElBQW9CLFNBQWpDO0FBQ0EsYUFBTyxLQUFLUyxVQUFMLENBQWdCRSxJQUFJLEdBQUdqQiw0QkFBNEIsQ0FBQyxLQUFLWCxLQUFOLENBQW5ELENBQVA7QUFDRDs7OytCQUVVNkIsTSxFQUFxQztBQUM5QyxhQUFPO0FBQ0xDLFFBQUFBLGdCQUFnQixFQUFFLElBRGI7QUFFTEMsUUFBQUEsS0FBSyxFQUFFLEtBQUsvQixLQUFMLENBQVcrQixLQUZiO0FBR0xDLFFBQUFBLE1BQU0sRUFBRSxLQUFLaEMsS0FBTCxDQUFXZ0MsTUFIZDtBQUlMQyxRQUFBQSxHQUFHLEVBQUVKLE1BSkE7QUFLTDVCLFFBQUFBLEtBQUssRUFBRUMsbUJBQW1CLENBQUNDLFNBQXBCLENBQThCLEtBQUtILEtBQUwsQ0FBV0ksTUFBekMsRUFBaURWLFVBQVUsQ0FBQ1csR0FBWCxFQUFqRDtBQUxGLE9BQVA7QUFPRDs7OzhCQUVnQkQsTSxFQUF1QjhCLFcsRUFBNkI7QUFFbkUsV0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHL0IsTUFBTSxDQUFDZ0MsTUFBM0IsRUFBbUNELENBQUMsRUFBcEMsRUFBd0M7QUFDdEMsWUFBSS9CLE1BQU0sQ0FBQytCLENBQUQsQ0FBTixJQUFhRCxXQUFqQixFQUE4QjtBQUM1QixpQkFBTzlCLE1BQU0sQ0FBQytCLENBQUQsQ0FBYjtBQUNEO0FBQ0Y7O0FBS0QsYUFBTy9CLE1BQU0sQ0FBQ0EsTUFBTSxDQUFDZ0MsTUFBUCxHQUFnQixDQUFqQixDQUFOLElBQTZCLENBQXBDO0FBQ0Q7Ozs7O0FBR0hDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBDLG1CQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5leHBvcnQgdHlwZSBSZXNvbHZlZEFzc2V0U291cmNlID0ge3xcbiAgK19fcGFja2FnZXJfYXNzZXQ6IGJvb2xlYW4sXG4gICt3aWR0aDogP251bWJlcixcbiAgK2hlaWdodDogP251bWJlcixcbiAgK3VyaTogc3RyaW5nLFxuICArc2NhbGU6IG51bWJlcixcbnx9O1xuXG5pbXBvcnQgdHlwZSB7UGFja2FnZXJBc3NldH0gZnJvbSAnLi9Bc3NldFJlZ2lzdHJ5JztcblxuY29uc3QgUGl4ZWxSYXRpbyA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9QaXhlbFJhdGlvJyk7XG5jb25zdCBQbGF0Zm9ybSA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9QbGF0Zm9ybScpO1xuXG5jb25zdCBhc3NldFBhdGhVdGlscyA9IHJlcXVpcmUoJy4vYXNzZXRQYXRoVXRpbHMnKTtcbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ludmFyaWFudCcpO1xuXG4vKipcbiAqIFJldHVybnMgYSBwYXRoIGxpa2UgJ2Fzc2V0cy9Bd2Vzb21lTW9kdWxlL2ljb25AMngucG5nJ1xuICovXG5mdW5jdGlvbiBnZXRTY2FsZWRBc3NldFBhdGgoYXNzZXQpOiBzdHJpbmcge1xuICBjb25zdCBzY2FsZSA9IEFzc2V0U291cmNlUmVzb2x2ZXIucGlja1NjYWxlKGFzc2V0LnNjYWxlcywgUGl4ZWxSYXRpby5nZXQoKSk7XG4gIGNvbnN0IHNjYWxlU3VmZml4ID0gc2NhbGUgPT09IDEgPyAnJyA6ICdAJyArIHNjYWxlICsgJ3gnO1xuICBjb25zdCBhc3NldERpciA9IGFzc2V0UGF0aFV0aWxzLmdldEJhc2VQYXRoKGFzc2V0KTtcbiAgcmV0dXJuIGFzc2V0RGlyICsgJy8nICsgYXNzZXQubmFtZSArIHNjYWxlU3VmZml4ICsgJy4nICsgYXNzZXQudHlwZTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIGEgcGF0aCBsaWtlICdkcmF3YWJsZS1tZHBpL2ljb24ucG5nJ1xuICovXG5mdW5jdGlvbiBnZXRBc3NldFBhdGhJbkRyYXdhYmxlRm9sZGVyKGFzc2V0KTogc3RyaW5nIHtcbiAgY29uc3Qgc2NhbGUgPSBBc3NldFNvdXJjZVJlc29sdmVyLnBpY2tTY2FsZShhc3NldC5zY2FsZXMsIFBpeGVsUmF0aW8uZ2V0KCkpO1xuICBjb25zdCBkcmF3YmxlRm9sZGVyID0gYXNzZXRQYXRoVXRpbHMuZ2V0QW5kcm9pZFJlc291cmNlRm9sZGVyTmFtZShcbiAgICBhc3NldCxcbiAgICBzY2FsZSxcbiAgKTtcbiAgY29uc3QgZmlsZU5hbWUgPSBhc3NldFBhdGhVdGlscy5nZXRBbmRyb2lkUmVzb3VyY2VJZGVudGlmaWVyKGFzc2V0KTtcbiAgcmV0dXJuIGRyYXdibGVGb2xkZXIgKyAnLycgKyBmaWxlTmFtZSArICcuJyArIGFzc2V0LnR5cGU7XG59XG5cbmNsYXNzIEFzc2V0U291cmNlUmVzb2x2ZXIge1xuICBzZXJ2ZXJVcmw6ID9zdHJpbmc7XG4gIC8vIHdoZXJlIHRoZSBqc2J1bmRsZSBpcyBiZWluZyBydW4gZnJvbVxuICBqc2J1bmRsZVVybDogP3N0cmluZztcbiAgLy8gdGhlIGFzc2V0IHRvIHJlc29sdmVcbiAgYXNzZXQ6IFBhY2thZ2VyQXNzZXQ7XG5cbiAgY29uc3RydWN0b3Ioc2VydmVyVXJsOiA/c3RyaW5nLCBqc2J1bmRsZVVybDogP3N0cmluZywgYXNzZXQ6IFBhY2thZ2VyQXNzZXQpIHtcbiAgICB0aGlzLnNlcnZlclVybCA9IHNlcnZlclVybDtcbiAgICB0aGlzLmpzYnVuZGxlVXJsID0ganNidW5kbGVVcmw7XG4gICAgdGhpcy5hc3NldCA9IGFzc2V0O1xuICB9XG5cbiAgaXNMb2FkZWRGcm9tU2VydmVyKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMuc2VydmVyVXJsO1xuICB9XG5cbiAgaXNMb2FkZWRGcm9tRmlsZVN5c3RlbSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISEodGhpcy5qc2J1bmRsZVVybCAmJiB0aGlzLmpzYnVuZGxlVXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6Ly8nKSk7XG4gIH1cblxuICBkZWZhdWx0QXNzZXQoKTogUmVzb2x2ZWRBc3NldFNvdXJjZSB7XG4gICAgaWYgKHRoaXMuaXNMb2FkZWRGcm9tU2VydmVyKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLmFzc2V0U2VydmVyVVJMKCk7XG4gICAgfVxuXG4gICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHtcbiAgICAgIHJldHVybiB0aGlzLmlzTG9hZGVkRnJvbUZpbGVTeXN0ZW0oKVxuICAgICAgICA/IHRoaXMuZHJhd2FibGVGb2xkZXJJbkJ1bmRsZSgpXG4gICAgICAgIDogdGhpcy5yZXNvdXJjZUlkZW50aWZpZXJXaXRob3V0U2NhbGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuc2NhbGVkQXNzZXRVUkxOZWFyQnVuZGxlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gYWJzb2x1dGUgVVJMIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGZldGNoIHRoZSBhc3NldFxuICAgKiBmcm9tIHRoZSBkZXZzZXJ2ZXJcbiAgICovXG4gIGFzc2V0U2VydmVyVVJMKCk6IFJlc29sdmVkQXNzZXRTb3VyY2Uge1xuICAgIGludmFyaWFudCghIXRoaXMuc2VydmVyVXJsLCAnbmVlZCBzZXJ2ZXIgdG8gbG9hZCBmcm9tJyk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShcbiAgICAgIHRoaXMuc2VydmVyVXJsICtcbiAgICAgICAgZ2V0U2NhbGVkQXNzZXRQYXRoKHRoaXMuYXNzZXQpICtcbiAgICAgICAgJz9wbGF0Zm9ybT0nICtcbiAgICAgICAgUGxhdGZvcm0uT1MgK1xuICAgICAgICAnJmhhc2g9JyArXG4gICAgICAgIHRoaXMuYXNzZXQuaGFzaCxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIHRvIGp1c3QgdGhlIHNjYWxlZCBhc3NldCBmaWxlbmFtZVxuICAgKiBFLmcuICdhc3NldHMvQXdlc29tZU1vZHVsZS9pY29uQDJ4LnBuZydcbiAgICovXG4gIHNjYWxlZEFzc2V0UGF0aCgpOiBSZXNvbHZlZEFzc2V0U291cmNlIHtcbiAgICByZXR1cm4gdGhpcy5mcm9tU291cmNlKGdldFNjYWxlZEFzc2V0UGF0aCh0aGlzLmFzc2V0KSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzb2x2ZXMgdG8gd2hlcmUgdGhlIGJ1bmRsZSBpcyBydW5uaW5nIGZyb20sIHdpdGggYSBzY2FsZWQgYXNzZXQgZmlsZW5hbWVcbiAgICogRS5nLiAnZmlsZTovLy9zZGNhcmQvYnVuZGxlL2Fzc2V0cy9Bd2Vzb21lTW9kdWxlL2ljb25AMngucG5nJ1xuICAgKi9cbiAgc2NhbGVkQXNzZXRVUkxOZWFyQnVuZGxlKCk6IFJlc29sdmVkQXNzZXRTb3VyY2Uge1xuICAgIGNvbnN0IHBhdGggPSB0aGlzLmpzYnVuZGxlVXJsIHx8ICdmaWxlOi8vJztcbiAgICByZXR1cm4gdGhpcy5mcm9tU291cmNlKHBhdGggKyBnZXRTY2FsZWRBc3NldFBhdGgodGhpcy5hc3NldCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBkZWZhdWx0IGxvY2F0aW9uIG9mIGFzc2V0cyBidW5kbGVkIHdpdGggdGhlIGFwcCwgbG9jYXRlZCBieVxuICAgKiByZXNvdXJjZSBpZGVudGlmaWVyXG4gICAqIFRoZSBBbmRyb2lkIHJlc291cmNlIHN5c3RlbSBwaWNrcyB0aGUgY29ycmVjdCBzY2FsZS5cbiAgICogRS5nLiAnYXNzZXRzX2F3ZXNvbWVtb2R1bGVfaWNvbidcbiAgICovXG4gIHJlc291cmNlSWRlbnRpZmllcldpdGhvdXRTY2FsZSgpOiBSZXNvbHZlZEFzc2V0U291cmNlIHtcbiAgICBpbnZhcmlhbnQoXG4gICAgICBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnLFxuICAgICAgJ3Jlc291cmNlIGlkZW50aWZpZXJzIHdvcmsgb24gQW5kcm9pZCcsXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5mcm9tU291cmNlKFxuICAgICAgYXNzZXRQYXRoVXRpbHMuZ2V0QW5kcm9pZFJlc291cmNlSWRlbnRpZmllcih0aGlzLmFzc2V0KSxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIHRoZSBqc2J1bmRsZSBpcyBydW5uaW5nIGZyb20gYSBzaWRlbG9hZCBsb2NhdGlvbiwgdGhpcyByZXNvbHZlcyBhc3NldHNcbiAgICogcmVsYXRpdmUgdG8gaXRzIGxvY2F0aW9uXG4gICAqIEUuZy4gJ2ZpbGU6Ly8vc2RjYXJkL0F3ZXNvbWVNb2R1bGUvZHJhd2FibGUtbWRwaS9pY29uLnBuZydcbiAgICovXG4gIGRyYXdhYmxlRm9sZGVySW5CdW5kbGUoKTogUmVzb2x2ZWRBc3NldFNvdXJjZSB7XG4gICAgY29uc3QgcGF0aCA9IHRoaXMuanNidW5kbGVVcmwgfHwgJ2ZpbGU6Ly8nO1xuICAgIHJldHVybiB0aGlzLmZyb21Tb3VyY2UocGF0aCArIGdldEFzc2V0UGF0aEluRHJhd2FibGVGb2xkZXIodGhpcy5hc3NldCkpO1xuICB9XG5cbiAgZnJvbVNvdXJjZShzb3VyY2U6IHN0cmluZyk6IFJlc29sdmVkQXNzZXRTb3VyY2Uge1xuICAgIHJldHVybiB7XG4gICAgICBfX3BhY2thZ2VyX2Fzc2V0OiB0cnVlLFxuICAgICAgd2lkdGg6IHRoaXMuYXNzZXQud2lkdGgsXG4gICAgICBoZWlnaHQ6IHRoaXMuYXNzZXQuaGVpZ2h0LFxuICAgICAgdXJpOiBzb3VyY2UsXG4gICAgICBzY2FsZTogQXNzZXRTb3VyY2VSZXNvbHZlci5waWNrU2NhbGUodGhpcy5hc3NldC5zY2FsZXMsIFBpeGVsUmF0aW8uZ2V0KCkpLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgcGlja1NjYWxlKHNjYWxlczogQXJyYXk8bnVtYmVyPiwgZGV2aWNlU2NhbGU6IG51bWJlcik6IG51bWJlciB7XG4gICAgLy8gUGFja2FnZXIgZ3VhcmFudGVlcyB0aGF0IGBzY2FsZXNgIGFycmF5IGlzIHNvcnRlZFxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2NhbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoc2NhbGVzW2ldID49IGRldmljZVNjYWxlKSB7XG4gICAgICAgIHJldHVybiBzY2FsZXNbaV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSWYgbm90aGluZyBtYXRjaGVzLCBkZXZpY2Ugc2NhbGUgaXMgbGFyZ2VyIHRoYW4gYW55IGF2YWlsYWJsZVxuICAgIC8vIHNjYWxlcywgc28gd2UgcmV0dXJuIHRoZSBiaWdnZXN0IG9uZS4gVW5sZXNzIHRoZSBhcnJheSBpcyBlbXB0eSxcbiAgICAvLyBpbiB3aGljaCBjYXNlIHdlIGRlZmF1bHQgdG8gMVxuICAgIHJldHVybiBzY2FsZXNbc2NhbGVzLmxlbmd0aCAtIDFdIHx8IDE7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBBc3NldFNvdXJjZVJlc29sdmVyO1xuIl19