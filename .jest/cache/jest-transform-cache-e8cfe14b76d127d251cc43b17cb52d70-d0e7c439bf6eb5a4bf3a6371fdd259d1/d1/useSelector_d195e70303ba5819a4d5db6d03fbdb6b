38b292d4fc291fa7fb33a7622ff315eb
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.createSelectorHook = createSelectorHook;
exports.useSelector = void 0;

var _react = require("react");

var _invariant = _interopRequireDefault(require("invariant"));

var _useReduxContext2 = require("./useReduxContext");

var _Subscription = _interopRequireDefault(require("../utils/Subscription"));

var _Context = require("../components/Context");

var useIsomorphicLayoutEffect = typeof window !== 'undefined' ? _react.useLayoutEffect : _react.useEffect;

var refEquality = function refEquality(a, b) {
  return a === b;
};

function useSelectorWithStoreAndSubscription(selector, equalityFn, store, contextSub) {
  var _useReducer = (0, _react.useReducer)(function (s) {
    return s + 1;
  }, 0),
      forceRender = _useReducer[1];

  var subscription = (0, _react.useMemo)(function () {
    return new _Subscription["default"](store, contextSub);
  }, [store, contextSub]);
  var latestSubscriptionCallbackError = (0, _react.useRef)();
  var latestSelector = (0, _react.useRef)();
  var latestSelectedState = (0, _react.useRef)();
  var selectedState;

  try {
    if (selector !== latestSelector.current || latestSubscriptionCallbackError.current) {
      selectedState = selector(store.getState());
    } else {
      selectedState = latestSelectedState.current;
    }
  } catch (err) {
    var errorMessage = "An error occured while selecting the store state: " + err.message + ".";

    if (latestSubscriptionCallbackError.current) {
      errorMessage += "\nThe error may be correlated with this previous error:\n" + latestSubscriptionCallbackError.current.stack + "\n\nOriginal stack trace:";
    }

    throw new Error(errorMessage);
  }

  useIsomorphicLayoutEffect(function () {
    latestSelector.current = selector;
    latestSelectedState.current = selectedState;
    latestSubscriptionCallbackError.current = undefined;
  });
  useIsomorphicLayoutEffect(function () {
    function checkForUpdates() {
      try {
        var newSelectedState = latestSelector.current(store.getState());

        if (equalityFn(newSelectedState, latestSelectedState.current)) {
          return;
        }

        latestSelectedState.current = newSelectedState;
      } catch (err) {
        latestSubscriptionCallbackError.current = err;
      }

      forceRender({});
    }

    subscription.onStateChange = checkForUpdates;
    subscription.trySubscribe();
    checkForUpdates();
    return function () {
      return subscription.tryUnsubscribe();
    };
  }, [store, subscription]);
  return selectedState;
}

function createSelectorHook(context) {
  if (context === void 0) {
    context = _Context.ReactReduxContext;
  }

  var useReduxContext = context === _Context.ReactReduxContext ? _useReduxContext2.useReduxContext : function () {
    return (0, _react.useContext)(context);
  };
  return function useSelector(selector, equalityFn) {
    if (equalityFn === void 0) {
      equalityFn = refEquality;
    }

    (0, _invariant["default"])(selector, "You must pass a selector to useSelectors");

    var _useReduxContext = useReduxContext(),
        store = _useReduxContext.store,
        contextSub = _useReduxContext.subscription;

    return useSelectorWithStoreAndSubscription(selector, equalityFn, store, contextSub);
  };
}

var useSelector = createSelectorHook();
exports.useSelector = useSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVzZVNlbGVjdG9yLmpzIl0sIm5hbWVzIjpbIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiZXhwb3J0cyIsIl9fZXNNb2R1bGUiLCJjcmVhdGVTZWxlY3Rvckhvb2siLCJ1c2VTZWxlY3RvciIsIl9yZWFjdCIsIl9pbnZhcmlhbnQiLCJfdXNlUmVkdXhDb250ZXh0MiIsIl9TdWJzY3JpcHRpb24iLCJfQ29udGV4dCIsInVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QiLCJ3aW5kb3ciLCJ1c2VMYXlvdXRFZmZlY3QiLCJ1c2VFZmZlY3QiLCJyZWZFcXVhbGl0eSIsImEiLCJiIiwidXNlU2VsZWN0b3JXaXRoU3RvcmVBbmRTdWJzY3JpcHRpb24iLCJzZWxlY3RvciIsImVxdWFsaXR5Rm4iLCJzdG9yZSIsImNvbnRleHRTdWIiLCJfdXNlUmVkdWNlciIsInVzZVJlZHVjZXIiLCJzIiwiZm9yY2VSZW5kZXIiLCJzdWJzY3JpcHRpb24iLCJ1c2VNZW1vIiwibGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvciIsInVzZVJlZiIsImxhdGVzdFNlbGVjdG9yIiwibGF0ZXN0U2VsZWN0ZWRTdGF0ZSIsInNlbGVjdGVkU3RhdGUiLCJjdXJyZW50IiwiZ2V0U3RhdGUiLCJlcnIiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwic3RhY2siLCJFcnJvciIsInVuZGVmaW5lZCIsImNoZWNrRm9yVXBkYXRlcyIsIm5ld1NlbGVjdGVkU3RhdGUiLCJvblN0YXRlQ2hhbmdlIiwidHJ5U3Vic2NyaWJlIiwidHJ5VW5zdWJzY3JpYmUiLCJjb250ZXh0IiwiUmVhY3RSZWR1eENvbnRleHQiLCJ1c2VSZWR1eENvbnRleHQiLCJ1c2VDb250ZXh0IiwiX3VzZVJlZHV4Q29udGV4dCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBSUEsc0JBQXNCLEdBQUdDLE9BQU8sQ0FBQyw4Q0FBRCxDQUFwQzs7QUFFQUMsT0FBTyxDQUFDQyxVQUFSLEdBQXFCLElBQXJCO0FB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VCxDQUFxQmMsUUFBckIsRUFBK0JDLFVBQS9CLEVBQTJDO0FBQ2hELFFBQUlBLFVBQVUsS0FBSyxLQUFLLENBQXhCLEVBQTJCO0FBQ3pCQSxNQUFBQSxVQUFVLEdBQUdMLFdBQWI7QUFDRDs7QUFFRCxLQUFDLEdBQUdSLFVBQVUsQ0FBQyxTQUFELENBQWQsRUFBMkJZLFFBQTNCLEVBQXFDLDBDQUFyQzs7QUFFQSxRQUFJZ0MsZ0JBQWdCLEdBQUdGLGVBQWUsRUFBdEM7QUFBQSxRQUNJNUIsS0FBSyxHQUFHOEIsZ0JBQWdCLENBQUM5QixLQUQ3QjtBQUFBLFFBRUlDLFVBQVUsR0FBRzZCLGdCQUFnQixDQUFDeEIsWUFGbEM7O0FBSUEsV0FBT1QsbUNBQW1DLENBQUNDLFFBQUQsRUFBV0MsVUFBWCxFQUF1QkMsS0FBdkIsRUFBOEJDLFVBQTlCLENBQTFDO0FBQ0QsR0FaRDtBQWFEOztBQTBCRCxJQUFJakIsV0FBVyxHQUFHRCxrQkFBa0IsRUFBcEM7QUFDQUYsT0FBTyxDQUFDRyxXQUFSLEdBQXNCQSxXQUF0QiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG52YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoXCJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2ludGVyb3BSZXF1aXJlRGVmYXVsdFwiKTtcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHMuY3JlYXRlU2VsZWN0b3JIb29rID0gY3JlYXRlU2VsZWN0b3JIb29rO1xuZXhwb3J0cy51c2VTZWxlY3RvciA9IHZvaWQgMDtcblxudmFyIF9yZWFjdCA9IHJlcXVpcmUoXCJyZWFjdFwiKTtcblxudmFyIF9pbnZhcmlhbnQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJpbnZhcmlhbnRcIikpO1xuXG52YXIgX3VzZVJlZHV4Q29udGV4dDIgPSByZXF1aXJlKFwiLi91c2VSZWR1eENvbnRleHRcIik7XG5cbnZhciBfU3Vic2NyaXB0aW9uID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vdXRpbHMvU3Vic2NyaXB0aW9uXCIpKTtcblxudmFyIF9Db250ZXh0ID0gcmVxdWlyZShcIi4uL2NvbXBvbmVudHMvQ29udGV4dFwiKTtcblxuLy8gUmVhY3QgY3VycmVudGx5IHRocm93cyBhIHdhcm5pbmcgd2hlbiB1c2luZyB1c2VMYXlvdXRFZmZlY3Qgb24gdGhlIHNlcnZlci5cbi8vIFRvIGdldCBhcm91bmQgaXQsIHdlIGNhbiBjb25kaXRpb25hbGx5IHVzZUVmZmVjdCBvbiB0aGUgc2VydmVyIChuby1vcCkgYW5kXG4vLyB1c2VMYXlvdXRFZmZlY3QgaW4gdGhlIGJyb3dzZXIuIFdlIG5lZWQgdXNlTGF5b3V0RWZmZWN0IHRvIGVuc3VyZSB0aGUgc3RvcmVcbi8vIHN1YnNjcmlwdGlvbiBjYWxsYmFjayBhbHdheXMgaGFzIHRoZSBzZWxlY3RvciBmcm9tIHRoZSBsYXRlc3QgcmVuZGVyIGNvbW1pdFxuLy8gYXZhaWxhYmxlLCBvdGhlcndpc2UgYSBzdG9yZSB1cGRhdGUgbWF5IGhhcHBlbiBiZXR3ZWVuIHJlbmRlciBhbmQgdGhlIGVmZmVjdCxcbi8vIHdoaWNoIG1heSBjYXVzZSBtaXNzZWQgdXBkYXRlczsgd2UgYWxzbyBtdXN0IGVuc3VyZSB0aGUgc3RvcmUgc3Vic2NyaXB0aW9uXG4vLyBpcyBjcmVhdGVkIHN5bmNocm9ub3VzbHksIG90aGVyd2lzZSBhIHN0b3JlIHVwZGF0ZSBtYXkgb2NjdXIgYmVmb3JlIHRoZVxuLy8gc3Vic2NyaXB0aW9uIGlzIGNyZWF0ZWQgYW5kIGFuIGluY29uc2lzdGVudCBzdGF0ZSBtYXkgYmUgb2JzZXJ2ZWRcbnZhciB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgPyBfcmVhY3QudXNlTGF5b3V0RWZmZWN0IDogX3JlYWN0LnVzZUVmZmVjdDtcblxudmFyIHJlZkVxdWFsaXR5ID0gZnVuY3Rpb24gcmVmRXF1YWxpdHkoYSwgYikge1xuICByZXR1cm4gYSA9PT0gYjtcbn07XG5cbmZ1bmN0aW9uIHVzZVNlbGVjdG9yV2l0aFN0b3JlQW5kU3Vic2NyaXB0aW9uKHNlbGVjdG9yLCBlcXVhbGl0eUZuLCBzdG9yZSwgY29udGV4dFN1Yikge1xuICB2YXIgX3VzZVJlZHVjZXIgPSAoMCwgX3JlYWN0LnVzZVJlZHVjZXIpKGZ1bmN0aW9uIChzKSB7XG4gICAgcmV0dXJuIHMgKyAxO1xuICB9LCAwKSxcbiAgICAgIGZvcmNlUmVuZGVyID0gX3VzZVJlZHVjZXJbMV07XG5cbiAgdmFyIHN1YnNjcmlwdGlvbiA9ICgwLCBfcmVhY3QudXNlTWVtbykoZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBuZXcgX1N1YnNjcmlwdGlvbltcImRlZmF1bHRcIl0oc3RvcmUsIGNvbnRleHRTdWIpO1xuICB9LCBbc3RvcmUsIGNvbnRleHRTdWJdKTtcbiAgdmFyIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IgPSAoMCwgX3JlYWN0LnVzZVJlZikoKTtcbiAgdmFyIGxhdGVzdFNlbGVjdG9yID0gKDAsIF9yZWFjdC51c2VSZWYpKCk7XG4gIHZhciBsYXRlc3RTZWxlY3RlZFN0YXRlID0gKDAsIF9yZWFjdC51c2VSZWYpKCk7XG4gIHZhciBzZWxlY3RlZFN0YXRlO1xuXG4gIHRyeSB7XG4gICAgaWYgKHNlbGVjdG9yICE9PSBsYXRlc3RTZWxlY3Rvci5jdXJyZW50IHx8IGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudCkge1xuICAgICAgc2VsZWN0ZWRTdGF0ZSA9IHNlbGVjdG9yKHN0b3JlLmdldFN0YXRlKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWxlY3RlZFN0YXRlID0gbGF0ZXN0U2VsZWN0ZWRTdGF0ZS5jdXJyZW50O1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdmFyIGVycm9yTWVzc2FnZSA9IFwiQW4gZXJyb3Igb2NjdXJlZCB3aGlsZSBzZWxlY3RpbmcgdGhlIHN0b3JlIHN0YXRlOiBcIiArIGVyci5tZXNzYWdlICsgXCIuXCI7XG5cbiAgICBpZiAobGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvci5jdXJyZW50KSB7XG4gICAgICBlcnJvck1lc3NhZ2UgKz0gXCJcXG5UaGUgZXJyb3IgbWF5IGJlIGNvcnJlbGF0ZWQgd2l0aCB0aGlzIHByZXZpb3VzIGVycm9yOlxcblwiICsgbGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvci5jdXJyZW50LnN0YWNrICsgXCJcXG5cXG5PcmlnaW5hbCBzdGFjayB0cmFjZTpcIjtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgfVxuXG4gIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoZnVuY3Rpb24gKCkge1xuICAgIGxhdGVzdFNlbGVjdG9yLmN1cnJlbnQgPSBzZWxlY3RvcjtcbiAgICBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQgPSBzZWxlY3RlZFN0YXRlO1xuICAgIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudCA9IHVuZGVmaW5lZDtcbiAgfSk7XG4gIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIGNoZWNrRm9yVXBkYXRlcygpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciBuZXdTZWxlY3RlZFN0YXRlID0gbGF0ZXN0U2VsZWN0b3IuY3VycmVudChzdG9yZS5nZXRTdGF0ZSgpKTtcblxuICAgICAgICBpZiAoZXF1YWxpdHlGbihuZXdTZWxlY3RlZFN0YXRlLCBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGF0ZXN0U2VsZWN0ZWRTdGF0ZS5jdXJyZW50ID0gbmV3U2VsZWN0ZWRTdGF0ZTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyB3ZSBpZ25vcmUgYWxsIGVycm9ycyBoZXJlLCBzaW5jZSB3aGVuIHRoZSBjb21wb25lbnRcbiAgICAgICAgLy8gaXMgcmUtcmVuZGVyZWQsIHRoZSBzZWxlY3RvcnMgYXJlIGNhbGxlZCBhZ2FpbiwgYW5kXG4gICAgICAgIC8vIHdpbGwgdGhyb3cgYWdhaW4sIGlmIG5laXRoZXIgcHJvcHMgbm9yIHN0b3JlIHN0YXRlXG4gICAgICAgIC8vIGNoYW5nZWRcbiAgICAgICAgbGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvci5jdXJyZW50ID0gZXJyO1xuICAgICAgfVxuXG4gICAgICBmb3JjZVJlbmRlcih7fSk7XG4gICAgfVxuXG4gICAgc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UgPSBjaGVja0ZvclVwZGF0ZXM7XG4gICAgc3Vic2NyaXB0aW9uLnRyeVN1YnNjcmliZSgpO1xuICAgIGNoZWNrRm9yVXBkYXRlcygpO1xuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gc3Vic2NyaXB0aW9uLnRyeVVuc3Vic2NyaWJlKCk7XG4gICAgfTtcbiAgfSwgW3N0b3JlLCBzdWJzY3JpcHRpb25dKTtcbiAgcmV0dXJuIHNlbGVjdGVkU3RhdGU7XG59XG4vKipcbiAqIEhvb2sgZmFjdG9yeSwgd2hpY2ggY3JlYXRlcyBhIGB1c2VTZWxlY3RvcmAgaG9vayBib3VuZCB0byBhIGdpdmVuIGNvbnRleHQuXG4gKlxuICogQHBhcmFtIHtGdW5jdGlvbn0gW2NvbnRleHQ9UmVhY3RSZWR1eENvbnRleHRdIENvbnRleHQgcGFzc2VkIHRvIHlvdXIgYDxQcm92aWRlcj5gLlxuICogQHJldHVybnMge0Z1bmN0aW9ufSBBIGB1c2VTZWxlY3RvcmAgaG9vayBib3VuZCB0byB0aGUgc3BlY2lmaWVkIGNvbnRleHQuXG4gKi9cblxuXG5mdW5jdGlvbiBjcmVhdGVTZWxlY3Rvckhvb2soY29udGV4dCkge1xuICBpZiAoY29udGV4dCA9PT0gdm9pZCAwKSB7XG4gICAgY29udGV4dCA9IF9Db250ZXh0LlJlYWN0UmVkdXhDb250ZXh0O1xuICB9XG5cbiAgdmFyIHVzZVJlZHV4Q29udGV4dCA9IGNvbnRleHQgPT09IF9Db250ZXh0LlJlYWN0UmVkdXhDb250ZXh0ID8gX3VzZVJlZHV4Q29udGV4dDIudXNlUmVkdXhDb250ZXh0IDogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiAoMCwgX3JlYWN0LnVzZUNvbnRleHQpKGNvbnRleHQpO1xuICB9O1xuICByZXR1cm4gZnVuY3Rpb24gdXNlU2VsZWN0b3Ioc2VsZWN0b3IsIGVxdWFsaXR5Rm4pIHtcbiAgICBpZiAoZXF1YWxpdHlGbiA9PT0gdm9pZCAwKSB7XG4gICAgICBlcXVhbGl0eUZuID0gcmVmRXF1YWxpdHk7XG4gICAgfVxuXG4gICAgKDAsIF9pbnZhcmlhbnRbXCJkZWZhdWx0XCJdKShzZWxlY3RvciwgXCJZb3UgbXVzdCBwYXNzIGEgc2VsZWN0b3IgdG8gdXNlU2VsZWN0b3JzXCIpO1xuXG4gICAgdmFyIF91c2VSZWR1eENvbnRleHQgPSB1c2VSZWR1eENvbnRleHQoKSxcbiAgICAgICAgc3RvcmUgPSBfdXNlUmVkdXhDb250ZXh0LnN0b3JlLFxuICAgICAgICBjb250ZXh0U3ViID0gX3VzZVJlZHV4Q29udGV4dC5zdWJzY3JpcHRpb247XG5cbiAgICByZXR1cm4gdXNlU2VsZWN0b3JXaXRoU3RvcmVBbmRTdWJzY3JpcHRpb24oc2VsZWN0b3IsIGVxdWFsaXR5Rm4sIHN0b3JlLCBjb250ZXh0U3ViKTtcbiAgfTtcbn1cbi8qKlxuICogQSBob29rIHRvIGFjY2VzcyB0aGUgcmVkdXggc3RvcmUncyBzdGF0ZS4gVGhpcyBob29rIHRha2VzIGEgc2VsZWN0b3IgZnVuY3Rpb25cbiAqIGFzIGFuIGFyZ3VtZW50LiBUaGUgc2VsZWN0b3IgaXMgY2FsbGVkIHdpdGggdGhlIHN0b3JlIHN0YXRlLlxuICpcbiAqIFRoaXMgaG9vayB0YWtlcyBhbiBvcHRpb25hbCBlcXVhbGl0eSBjb21wYXJpc29uIGZ1bmN0aW9uIGFzIHRoZSBzZWNvbmQgcGFyYW1ldGVyXG4gKiB0aGF0IGFsbG93cyB5b3UgdG8gY3VzdG9taXplIHRoZSB3YXkgdGhlIHNlbGVjdGVkIHN0YXRlIGlzIGNvbXBhcmVkIHRvIGRldGVybWluZVxuICogd2hldGhlciB0aGUgY29tcG9uZW50IG5lZWRzIHRvIGJlIHJlLXJlbmRlcmVkLlxuICpcbiAqIEBwYXJhbSB7RnVuY3Rpb259IHNlbGVjdG9yIHRoZSBzZWxlY3RvciBmdW5jdGlvblxuICogQHBhcmFtIHtGdW5jdGlvbj19IGVxdWFsaXR5Rm4gdGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGRldGVybWluZSBlcXVhbGl0eVxuICpcbiAqIEByZXR1cm5zIHthbnl9IHRoZSBzZWxlY3RlZCBzdGF0ZVxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuICogaW1wb3J0IHsgdXNlU2VsZWN0b3IgfSBmcm9tICdyZWFjdC1yZWR1eCdcbiAqXG4gKiBleHBvcnQgY29uc3QgQ291bnRlckNvbXBvbmVudCA9ICgpID0+IHtcbiAqICAgY29uc3QgY291bnRlciA9IHVzZVNlbGVjdG9yKHN0YXRlID0+IHN0YXRlLmNvdW50ZXIpXG4gKiAgIHJldHVybiA8ZGl2Pntjb3VudGVyfTwvZGl2PlxuICogfVxuICovXG5cblxudmFyIHVzZVNlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3JIb29rKCk7XG5leHBvcnRzLnVzZVNlbGVjdG9yID0gdXNlU2VsZWN0b3I7Il19