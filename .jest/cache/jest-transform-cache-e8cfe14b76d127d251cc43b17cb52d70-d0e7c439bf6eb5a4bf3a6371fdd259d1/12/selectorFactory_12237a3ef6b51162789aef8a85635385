da6170e41f64f162a21ae977f1286432
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.impureFinalPropsSelectorFactory = impureFinalPropsSelectorFactory;
exports.pureFinalPropsSelectorFactory = pureFinalPropsSelectorFactory;
exports["default"] = finalPropsSelectorFactory;

var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));

var _verifySubselectors = _interopRequireDefault(require("./verifySubselectors"));

function impureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch) {
  return function impureFinalPropsSelector(state, ownProps) {
    return mergeProps(mapStateToProps(state, ownProps), mapDispatchToProps(dispatch, ownProps), ownProps);
  };
}

function pureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, _ref) {
  var areStatesEqual = _ref.areStatesEqual,
      areOwnPropsEqual = _ref.areOwnPropsEqual,
      areStatePropsEqual = _ref.areStatePropsEqual;
  var hasRunAtLeastOnce = false;
  var state;
  var ownProps;
  var stateProps;
  var dispatchProps;
  var mergedProps;

  function handleFirstCall(firstState, firstOwnProps) {
    state = firstState;
    ownProps = firstOwnProps;
    stateProps = mapStateToProps(state, ownProps);
    dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    hasRunAtLeastOnce = true;
    return mergedProps;
  }

  function handleNewPropsAndNewState() {
    stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewProps() {
    if (mapStateToProps.dependsOnOwnProps) stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewState() {
    var nextStateProps = mapStateToProps(state, ownProps);
    var statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps);
    stateProps = nextStateProps;
    if (statePropsChanged) mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleSubsequentCalls(nextState, nextOwnProps) {
    var propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps);
    var stateChanged = !areStatesEqual(nextState, state);
    state = nextState;
    ownProps = nextOwnProps;
    if (propsChanged && stateChanged) return handleNewPropsAndNewState();
    if (propsChanged) return handleNewProps();
    if (stateChanged) return handleNewState();
    return mergedProps;
  }

  return function pureFinalPropsSelector(nextState, nextOwnProps) {
    return hasRunAtLeastOnce ? handleSubsequentCalls(nextState, nextOwnProps) : handleFirstCall(nextState, nextOwnProps);
  };
}

function finalPropsSelectorFactory(dispatch, _ref2) {
  var initMapStateToProps = _ref2.initMapStateToProps,
      initMapDispatchToProps = _ref2.initMapDispatchToProps,
      initMergeProps = _ref2.initMergeProps,
      options = (0, _objectWithoutPropertiesLoose2["default"])(_ref2, ["initMapStateToProps", "initMapDispatchToProps", "initMergeProps"]);
  var mapStateToProps = initMapStateToProps(dispatch, options);
  var mapDispatchToProps = initMapDispatchToProps(dispatch, options);
  var mergeProps = initMergeProps(dispatch, options);

  if (process.env.NODE_ENV !== 'production') {
    (0, _verifySubselectors["default"])(mapStateToProps, mapDispatchToProps, mergeProps, options.displayName);
  }

  var selectorFactory = options.pure ? pureFinalPropsSelectorFactory : impureFinalPropsSelectorFactory;
  return selectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, options);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbGVjdG9yRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsInB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5IiwiZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsIl9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMiIsIl92ZXJpZnlTdWJzZWxlY3RvcnMiLCJtYXBTdGF0ZVRvUHJvcHMiLCJtYXBEaXNwYXRjaFRvUHJvcHMiLCJtZXJnZVByb3BzIiwiZGlzcGF0Y2giLCJpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3IiLCJzdGF0ZSIsIm93blByb3BzIiwiX3JlZiIsImFyZVN0YXRlc0VxdWFsIiwiYXJlT3duUHJvcHNFcXVhbCIsImFyZVN0YXRlUHJvcHNFcXVhbCIsImhhc1J1bkF0TGVhc3RPbmNlIiwic3RhdGVQcm9wcyIsImRpc3BhdGNoUHJvcHMiLCJtZXJnZWRQcm9wcyIsImhhbmRsZUZpcnN0Q2FsbCIsImZpcnN0U3RhdGUiLCJmaXJzdE93blByb3BzIiwiaGFuZGxlTmV3UHJvcHNBbmROZXdTdGF0ZSIsImRlcGVuZHNPbk93blByb3BzIiwiaGFuZGxlTmV3UHJvcHMiLCJoYW5kbGVOZXdTdGF0ZSIsIm5leHRTdGF0ZVByb3BzIiwic3RhdGVQcm9wc0NoYW5nZWQiLCJoYW5kbGVTdWJzZXF1ZW50Q2FsbHMiLCJuZXh0U3RhdGUiLCJuZXh0T3duUHJvcHMiLCJwcm9wc0NoYW5nZWQiLCJzdGF0ZUNoYW5nZWQiLCJwdXJlRmluYWxQcm9wc1NlbGVjdG9yIiwiX3JlZjIiLCJpbml0TWFwU3RhdGVUb1Byb3BzIiwiaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyIsImluaXRNZXJnZVByb3BzIiwib3B0aW9ucyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImRpc3BsYXlOYW1lIiwic2VsZWN0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bkMsRUFBNkMyQixLQUE3QyxFQUFvRDtBQUNsRCxNQUFJQyxtQkFBbUIsR0FBR0QsS0FBSyxDQUFDQyxtQkFBaEM7QUFBQSxNQUNJQyxzQkFBc0IsR0FBR0YsS0FBSyxDQUFDRSxzQkFEbkM7QUFBQSxNQUVJQyxjQUFjLEdBQUdILEtBQUssQ0FBQ0csY0FGM0I7QUFBQSxNQUdJQyxPQUFPLEdBQUcsQ0FBQyxHQUFHcEMsOEJBQThCLENBQUMsU0FBRCxDQUFsQyxFQUErQ2dDLEtBQS9DLEVBQXNELENBQUMscUJBQUQsRUFBd0Isd0JBQXhCLEVBQWtELGdCQUFsRCxDQUF0RCxDQUhkO0FBSUEsTUFBSTlCLGVBQWUsR0FBRytCLG1CQUFtQixDQUFDNUIsUUFBRCxFQUFXK0IsT0FBWCxDQUF6QztBQUNBLE1BQUlqQyxrQkFBa0IsR0FBRytCLHNCQUFzQixDQUFDN0IsUUFBRCxFQUFXK0IsT0FBWCxDQUEvQztBQUNBLE1BQUloQyxVQUFVLEdBQUcrQixjQUFjLENBQUM5QixRQUFELEVBQVcrQixPQUFYLENBQS9COztBQUVBLE1BQUlDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFaLEtBQXlCLFlBQTdCLEVBQTJDO0FBQ3pDLEtBQUMsR0FBR3RDLG1CQUFtQixDQUFDLFNBQUQsQ0FBdkIsRUFBb0NDLGVBQXBDLEVBQXFEQyxrQkFBckQsRUFBeUVDLFVBQXpFLEVBQXFGZ0MsT0FBTyxDQUFDSSxXQUE3RjtBQUNEOztBQUVELE1BQUlDLGVBQWUsR0FBR0wsT0FBTyxDQUFDTSxJQUFSLEdBQWU1Qyw2QkFBZixHQUErQ0QsK0JBQXJFO0FBQ0EsU0FBTzRDLGVBQWUsQ0FBQ3ZDLGVBQUQsRUFBa0JDLGtCQUFsQixFQUFzQ0MsVUFBdEMsRUFBa0RDLFFBQWxELEVBQTREK0IsT0FBNUQsQ0FBdEI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG52YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoXCJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2ludGVyb3BSZXF1aXJlRGVmYXVsdFwiKTtcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHMuaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSA9IGltcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3Rvcnk7XG5leHBvcnRzLnB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5ID0gcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3Rvcnk7XG5leHBvcnRzW1wiZGVmYXVsdFwiXSA9IGZpbmFsUHJvcHNTZWxlY3RvckZhY3Rvcnk7XG5cbnZhciBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJAYmFiZWwvcnVudGltZS9oZWxwZXJzL29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2VcIikpO1xuXG52YXIgX3ZlcmlmeVN1YnNlbGVjdG9ycyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vdmVyaWZ5U3Vic2VsZWN0b3JzXCIpKTtcblxuZnVuY3Rpb24gaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgZGlzcGF0Y2gpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIGltcHVyZUZpbmFsUHJvcHNTZWxlY3RvcihzdGF0ZSwgb3duUHJvcHMpIHtcbiAgICByZXR1cm4gbWVyZ2VQcm9wcyhtYXBTdGF0ZVRvUHJvcHMoc3RhdGUsIG93blByb3BzKSwgbWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvd25Qcm9wcyksIG93blByb3BzKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkobWFwU3RhdGVUb1Byb3BzLCBtYXBEaXNwYXRjaFRvUHJvcHMsIG1lcmdlUHJvcHMsIGRpc3BhdGNoLCBfcmVmKSB7XG4gIHZhciBhcmVTdGF0ZXNFcXVhbCA9IF9yZWYuYXJlU3RhdGVzRXF1YWwsXG4gICAgICBhcmVPd25Qcm9wc0VxdWFsID0gX3JlZi5hcmVPd25Qcm9wc0VxdWFsLFxuICAgICAgYXJlU3RhdGVQcm9wc0VxdWFsID0gX3JlZi5hcmVTdGF0ZVByb3BzRXF1YWw7XG4gIHZhciBoYXNSdW5BdExlYXN0T25jZSA9IGZhbHNlO1xuICB2YXIgc3RhdGU7XG4gIHZhciBvd25Qcm9wcztcbiAgdmFyIHN0YXRlUHJvcHM7XG4gIHZhciBkaXNwYXRjaFByb3BzO1xuICB2YXIgbWVyZ2VkUHJvcHM7XG5cbiAgZnVuY3Rpb24gaGFuZGxlRmlyc3RDYWxsKGZpcnN0U3RhdGUsIGZpcnN0T3duUHJvcHMpIHtcbiAgICBzdGF0ZSA9IGZpcnN0U3RhdGU7XG4gICAgb3duUHJvcHMgPSBmaXJzdE93blByb3BzO1xuICAgIHN0YXRlUHJvcHMgPSBtYXBTdGF0ZVRvUHJvcHMoc3RhdGUsIG93blByb3BzKTtcbiAgICBkaXNwYXRjaFByb3BzID0gbWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvd25Qcm9wcyk7XG4gICAgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzKHN0YXRlUHJvcHMsIGRpc3BhdGNoUHJvcHMsIG93blByb3BzKTtcbiAgICBoYXNSdW5BdExlYXN0T25jZSA9IHRydWU7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlTmV3UHJvcHNBbmROZXdTdGF0ZSgpIHtcbiAgICBzdGF0ZVByb3BzID0gbWFwU3RhdGVUb1Byb3BzKHN0YXRlLCBvd25Qcm9wcyk7XG4gICAgaWYgKG1hcERpc3BhdGNoVG9Qcm9wcy5kZXBlbmRzT25Pd25Qcm9wcykgZGlzcGF0Y2hQcm9wcyA9IG1hcERpc3BhdGNoVG9Qcm9wcyhkaXNwYXRjaCwgb3duUHJvcHMpO1xuICAgIG1lcmdlZFByb3BzID0gbWVyZ2VQcm9wcyhzdGF0ZVByb3BzLCBkaXNwYXRjaFByb3BzLCBvd25Qcm9wcyk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlTmV3UHJvcHMoKSB7XG4gICAgaWYgKG1hcFN0YXRlVG9Qcm9wcy5kZXBlbmRzT25Pd25Qcm9wcykgc3RhdGVQcm9wcyA9IG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpO1xuICAgIGlmIChtYXBEaXNwYXRjaFRvUHJvcHMuZGVwZW5kc09uT3duUHJvcHMpIGRpc3BhdGNoUHJvcHMgPSBtYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG93blByb3BzKTtcbiAgICBtZXJnZWRQcm9wcyA9IG1lcmdlUHJvcHMoc3RhdGVQcm9wcywgZGlzcGF0Y2hQcm9wcywgb3duUHJvcHMpO1xuICAgIHJldHVybiBtZXJnZWRQcm9wcztcbiAgfVxuXG4gIGZ1bmN0aW9uIGhhbmRsZU5ld1N0YXRlKCkge1xuICAgIHZhciBuZXh0U3RhdGVQcm9wcyA9IG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpO1xuICAgIHZhciBzdGF0ZVByb3BzQ2hhbmdlZCA9ICFhcmVTdGF0ZVByb3BzRXF1YWwobmV4dFN0YXRlUHJvcHMsIHN0YXRlUHJvcHMpO1xuICAgIHN0YXRlUHJvcHMgPSBuZXh0U3RhdGVQcm9wcztcbiAgICBpZiAoc3RhdGVQcm9wc0NoYW5nZWQpIG1lcmdlZFByb3BzID0gbWVyZ2VQcm9wcyhzdGF0ZVByb3BzLCBkaXNwYXRjaFByb3BzLCBvd25Qcm9wcyk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlU3Vic2VxdWVudENhbGxzKG5leHRTdGF0ZSwgbmV4dE93blByb3BzKSB7XG4gICAgdmFyIHByb3BzQ2hhbmdlZCA9ICFhcmVPd25Qcm9wc0VxdWFsKG5leHRPd25Qcm9wcywgb3duUHJvcHMpO1xuICAgIHZhciBzdGF0ZUNoYW5nZWQgPSAhYXJlU3RhdGVzRXF1YWwobmV4dFN0YXRlLCBzdGF0ZSk7XG4gICAgc3RhdGUgPSBuZXh0U3RhdGU7XG4gICAgb3duUHJvcHMgPSBuZXh0T3duUHJvcHM7XG4gICAgaWYgKHByb3BzQ2hhbmdlZCAmJiBzdGF0ZUNoYW5nZWQpIHJldHVybiBoYW5kbGVOZXdQcm9wc0FuZE5ld1N0YXRlKCk7XG4gICAgaWYgKHByb3BzQ2hhbmdlZCkgcmV0dXJuIGhhbmRsZU5ld1Byb3BzKCk7XG4gICAgaWYgKHN0YXRlQ2hhbmdlZCkgcmV0dXJuIGhhbmRsZU5ld1N0YXRlKCk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIHB1cmVGaW5hbFByb3BzU2VsZWN0b3IobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpIHtcbiAgICByZXR1cm4gaGFzUnVuQXRMZWFzdE9uY2UgPyBoYW5kbGVTdWJzZXF1ZW50Q2FsbHMobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpIDogaGFuZGxlRmlyc3RDYWxsKG5leHRTdGF0ZSwgbmV4dE93blByb3BzKTtcbiAgfTtcbn0gLy8gVE9ETzogQWRkIG1vcmUgY29tbWVudHNcbi8vIElmIHB1cmUgaXMgdHJ1ZSwgdGhlIHNlbGVjdG9yIHJldHVybmVkIGJ5IHNlbGVjdG9yRmFjdG9yeSB3aWxsIG1lbW9pemUgaXRzIHJlc3VsdHMsXG4vLyBhbGxvd2luZyBjb25uZWN0QWR2YW5jZWQncyBzaG91bGRDb21wb25lbnRVcGRhdGUgdG8gcmV0dXJuIGZhbHNlIGlmIGZpbmFsXG4vLyBwcm9wcyBoYXZlIG5vdCBjaGFuZ2VkLiBJZiBmYWxzZSwgdGhlIHNlbGVjdG9yIHdpbGwgYWx3YXlzIHJldHVybiBhIG5ld1xuLy8gb2JqZWN0IGFuZCBzaG91bGRDb21wb25lbnRVcGRhdGUgd2lsbCBhbHdheXMgcmV0dXJuIHRydWUuXG5cblxuZnVuY3Rpb24gZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeShkaXNwYXRjaCwgX3JlZjIpIHtcbiAgdmFyIGluaXRNYXBTdGF0ZVRvUHJvcHMgPSBfcmVmMi5pbml0TWFwU3RhdGVUb1Byb3BzLFxuICAgICAgaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyA9IF9yZWYyLmluaXRNYXBEaXNwYXRjaFRvUHJvcHMsXG4gICAgICBpbml0TWVyZ2VQcm9wcyA9IF9yZWYyLmluaXRNZXJnZVByb3BzLFxuICAgICAgb3B0aW9ucyA9ICgwLCBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTJbXCJkZWZhdWx0XCJdKShfcmVmMiwgW1wiaW5pdE1hcFN0YXRlVG9Qcm9wc1wiLCBcImluaXRNYXBEaXNwYXRjaFRvUHJvcHNcIiwgXCJpbml0TWVyZ2VQcm9wc1wiXSk7XG4gIHZhciBtYXBTdGF0ZVRvUHJvcHMgPSBpbml0TWFwU3RhdGVUb1Byb3BzKGRpc3BhdGNoLCBvcHRpb25zKTtcbiAgdmFyIG1hcERpc3BhdGNoVG9Qcm9wcyA9IGluaXRNYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG9wdGlvbnMpO1xuICB2YXIgbWVyZ2VQcm9wcyA9IGluaXRNZXJnZVByb3BzKGRpc3BhdGNoLCBvcHRpb25zKTtcblxuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xuICAgICgwLCBfdmVyaWZ5U3Vic2VsZWN0b3JzW1wiZGVmYXVsdFwiXSkobWFwU3RhdGVUb1Byb3BzLCBtYXBEaXNwYXRjaFRvUHJvcHMsIG1lcmdlUHJvcHMsIG9wdGlvbnMuZGlzcGxheU5hbWUpO1xuICB9XG5cbiAgdmFyIHNlbGVjdG9yRmFjdG9yeSA9IG9wdGlvbnMucHVyZSA/IHB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5IDogaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeTtcbiAgcmV0dXJuIHNlbGVjdG9yRmFjdG9yeShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgZGlzcGF0Y2gsIG9wdGlvbnMpO1xufSJdfQ==