667b93e7eba1a8705db26feecd712cdf
'use strict';

var asap = require('asap/raw');

function noop() {}

var LAST_ERROR = null;
var IS_ERROR = {};

function getThen(obj) {
  try {
    return obj.then;
  } catch (ex) {
    LAST_ERROR = ex;
    return IS_ERROR;
  }
}

function tryCallOne(fn, a) {
  try {
    return fn(a);
  } catch (ex) {
    LAST_ERROR = ex;
    return IS_ERROR;
  }
}

function tryCallTwo(fn, a, b) {
  try {
    fn(a, b);
  } catch (ex) {
    LAST_ERROR = ex;
    return IS_ERROR;
  }
}

module.exports = Promise;

function Promise(fn) {
  if (typeof this !== 'object') {
    throw new TypeError('Promises must be constructed via new');
  }

  if (typeof fn !== 'function') {
    throw new TypeError('Promise constructor\'s argument is not a function');
  }

  this._40 = 0;
  this._65 = 0;
  this._55 = null;
  this._72 = null;
  if (fn === noop) return;
  doResolve(fn, this);
}

Promise._37 = null;
Promise._87 = null;
Promise._61 = noop;

Promise.prototype.then = function (onFulfilled, onRejected) {
  if (this.constructor !== Promise) {
    return safeThen(this, onFulfilled, onRejected);
  }

  var res = new Promise(noop);
  handle(this, new Handler(onFulfilled, onRejected, res));
  return res;
};

function safeThen(self, onFulfilled, onRejected) {
  return new self.constructor(function (resolve, reject) {
    var res = new Promise(noop);
    res.then(resolve, reject);
    handle(self, new Handler(onFulfilled, onRejected, res));
  });
}

function handle(self, deferred) {
  while (self._65 === 3) {
    self = self._55;
  }

  if (Promise._37) {
    Promise._37(self);
  }

  if (self._65 === 0) {
    if (self._40 === 0) {
      self._40 = 1;
      self._72 = deferred;
      return;
    }

    if (self._40 === 1) {
      self._40 = 2;
      self._72 = [self._72, deferred];
      return;
    }

    self._72.push(deferred);

    return;
  }

  handleResolved(self, deferred);
}

function handleResolved(self, deferred) {
  asap(function () {
    var cb = self._65 === 1 ? deferred.onFulfilled : deferred.onRejected;

    if (cb === null) {
      if (self._65 === 1) {
        resolve(deferred.promise, self._55);
      } else {
        reject(deferred.promise, self._55);
      }

      return;
    }

    var ret = tryCallOne(cb, self._55);

    if (ret === IS_ERROR) {
      reject(deferred.promise, LAST_ERROR);
    } else {
      resolve(deferred.promise, ret);
    }
  });
}

function resolve(self, newValue) {
  if (newValue === self) {
    return reject(self, new TypeError('A promise cannot be resolved with itself.'));
  }

  if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
    var then = getThen(newValue);

    if (then === IS_ERROR) {
      return reject(self, LAST_ERROR);
    }

    if (then === self.then && newValue instanceof Promise) {
      self._65 = 3;
      self._55 = newValue;
      finale(self);
      return;
    } else if (typeof then === 'function') {
      doResolve(then.bind(newValue), self);
      return;
    }
  }

  self._65 = 1;
  self._55 = newValue;
  finale(self);
}

function reject(self, newValue) {
  self._65 = 2;
  self._55 = newValue;

  if (Promise._87) {
    Promise._87(self, newValue);
  }

  finale(self);
}

function finale(self) {
  if (self._40 === 1) {
    handle(self, self._72);
    self._72 = null;
  }

  if (self._40 === 2) {
    for (var i = 0; i < self._72.length; i++) {
      handle(self, self._72[i]);
    }

    self._72 = null;
  }
}

function Handler(onFulfilled, onRejected, promise) {
  this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;
  this.onRejected = typeof onRejected === 'function' ? onRejected : null;
  this.promise = promise;
}

function doResolve(fn, promise) {
  var done = false;
  var res = tryCallTwo(fn, function (value) {
    if (done) return;
    done = true;
    resolve(promise, value);
  }, function (reason) {
    if (done) return;
    done = true;
    reject(promise, reason);
  });

  if (!done && res === IS_ERROR) {
    done = true;
    reject(promise, LAST_ERROR);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUuanMiXSwibmFtZXMiOlsiYXNhcCIsInJlcXVpcmUiLCJub29wIiwiTEFTVF9FUlJPUiIsIklTX0VSUk9SIiwiZ2V0VGhlbiIsIm9iaiIsInRoZW4iLCJleCIsInRyeUNhbGxPbmUiLCJmbiIsImEiLCJ0cnlDYWxsVHdvIiwiYiIsIm1vZHVsZSIsImV4cG9ydHMiLCJQcm9taXNlIiwiVHlwZUVycm9yIiwiXzQwIiwiXzY1IiwiXzU1IiwiXzcyIiwiZG9SZXNvbHZlIiwiXzM3IiwiXzg3IiwiXzYxIiwicHJvdG90eXBlIiwib25GdWxmaWxsZWQiLCJvblJlamVjdGVkIiwiY29uc3RydWN0b3IiLCJzYWZlVGhlbiIsInJlcyIsImhhbmRsZSIsIkhhbmRsZXIiLCJzZWxmIiwicmVzb2x2ZSIsInJlamVjdCIsImRlZmVycmVkIiwicHVzaCIsImhhbmRsZVJlc29sdmVkIiwiY2IiLCJwcm9taXNlIiwicmV0IiwibmV3VmFsdWUiLCJmaW5hbGUiLCJiaW5kIiwiaSIsImxlbmd0aCIsImRvbmUiLCJ2YWx1ZSIsInJlYXNvbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBSUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFsQjs7QUFFQSxTQUFTQyxJQUFULEdBQWdCLENBQUU7O0FBbUJsQixJQUFJQyxVQUFVLEdBQUcsSUFBakI7QUFDQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjs7QUFDQSxTQUFTQyxPQUFULENBQWlCQyxHQUFqQixFQUFzQjtBQUNwQixNQUFJO0FBQ0YsV0FBT0EsR0FBRyxDQUFDQyxJQUFYO0FBQ0QsR0FGRCxDQUVFLE9BQU9DLEVBQVAsRUFBVztBQUNYTCxJQUFBQSxVQUFVLEdBQUdLLEVBQWI7QUFDQSxXQUFPSixRQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTSyxVQUFULENBQW9CQyxFQUFwQixFQUF3QkMsQ0FBeEIsRUFBMkI7QUFDekIsTUFBSTtBQUNGLFdBQU9ELEVBQUUsQ0FBQ0MsQ0FBRCxDQUFUO0FBQ0QsR0FGRCxDQUVF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QW9DQSxXQUFwQyxHQUFrRCxJQUFyRTtBQUNBLE9BQUtDLFVBQUwsR0FBa0IsT0FBT0EsVUFBUCxLQUFzQixVQUF0QixHQUFtQ0EsVUFBbkMsR0FBZ0QsSUFBbEU7QUFDQSxPQUFLYSxPQUFMLEdBQWVBLE9BQWY7QUFDRDs7QUFRRCxTQUFTbkIsU0FBVCxDQUFtQlosRUFBbkIsRUFBdUIrQixPQUF2QixFQUFnQztBQUM5QixNQUFJTyxJQUFJLEdBQUcsS0FBWDtBQUNBLE1BQUlqQixHQUFHLEdBQUduQixVQUFVLENBQUNGLEVBQUQsRUFBSyxVQUFVdUMsS0FBVixFQUFpQjtBQUN4QyxRQUFJRCxJQUFKLEVBQVU7QUFDVkEsSUFBQUEsSUFBSSxHQUFHLElBQVA7QUFDQWIsSUFBQUEsT0FBTyxDQUFDTSxPQUFELEVBQVVRLEtBQVYsQ0FBUDtBQUNELEdBSm1CLEVBSWpCLFVBQVVDLE1BQVYsRUFBa0I7QUFDbkIsUUFBSUYsSUFBSixFQUFVO0FBQ1ZBLElBQUFBLElBQUksR0FBRyxJQUFQO0FBQ0FaLElBQUFBLE1BQU0sQ0FBQ0ssT0FBRCxFQUFVUyxNQUFWLENBQU47QUFDRCxHQVJtQixDQUFwQjs7QUFTQSxNQUFJLENBQUNGLElBQUQsSUFBU2pCLEdBQUcsS0FBSzNCLFFBQXJCLEVBQStCO0FBQzdCNEMsSUFBQUEsSUFBSSxHQUFHLElBQVA7QUFDQVosSUFBQUEsTUFBTSxDQUFDSyxPQUFELEVBQVV0QyxVQUFWLENBQU47QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgYXNhcCA9IHJlcXVpcmUoJ2FzYXAvcmF3Jyk7XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG4vLyBTdGF0ZXM6XG4vL1xuLy8gMCAtIHBlbmRpbmdcbi8vIDEgLSBmdWxmaWxsZWQgd2l0aCBfdmFsdWVcbi8vIDIgLSByZWplY3RlZCB3aXRoIF92YWx1ZVxuLy8gMyAtIGFkb3B0ZWQgdGhlIHN0YXRlIG9mIGFub3RoZXIgcHJvbWlzZSwgX3ZhbHVlXG4vL1xuLy8gb25jZSB0aGUgc3RhdGUgaXMgbm8gbG9uZ2VyIHBlbmRpbmcgKDApIGl0IGlzIGltbXV0YWJsZVxuXG4vLyBBbGwgYF9gIHByZWZpeGVkIHByb3BlcnRpZXMgd2lsbCBiZSByZWR1Y2VkIHRvIGBfe3JhbmRvbSBudW1iZXJ9YFxuLy8gYXQgYnVpbGQgdGltZSB0byBvYmZ1c2NhdGUgdGhlbSBhbmQgZGlzY291cmFnZSB0aGVpciB1c2UuXG4vLyBXZSBkb24ndCB1c2Ugc3ltYm9scyBvciBPYmplY3QuZGVmaW5lUHJvcGVydHkgdG8gZnVsbHkgaGlkZSB0aGVtXG4vLyBiZWNhdXNlIHRoZSBwZXJmb3JtYW5jZSBpc24ndCBnb29kIGVub3VnaC5cblxuXG4vLyB0byBhdm9pZCB1c2luZyB0cnkvY2F0Y2ggaW5zaWRlIGNyaXRpY2FsIGZ1bmN0aW9ucywgd2Vcbi8vIGV4dHJhY3QgdGhlbSB0byBoZXJlLlxudmFyIExBU1RfRVJST1IgPSBudWxsO1xudmFyIElTX0VSUk9SID0ge307XG5mdW5jdGlvbiBnZXRUaGVuKG9iaikge1xuICB0cnkge1xuICAgIHJldHVybiBvYmoudGhlbjtcbiAgfSBjYXRjaCAoZXgpIHtcbiAgICBMQVNUX0VSUk9SID0gZXg7XG4gICAgcmV0dXJuIElTX0VSUk9SO1xuICB9XG59XG5cbmZ1bmN0aW9uIHRyeUNhbGxPbmUoZm4sIGEpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gZm4oYSk7XG4gIH0gY2F0Y2ggKGV4KSB7XG4gICAgTEFTVF9FUlJPUiA9IGV4O1xuICAgIHJldHVybiBJU19FUlJPUjtcbiAgfVxufVxuZnVuY3Rpb24gdHJ5Q2FsbFR3byhmbiwgYSwgYikge1xuICB0cnkge1xuICAgIGZuKGEsIGIpO1xuICB9IGNhdGNoIChleCkge1xuICAgIExBU1RfRVJST1IgPSBleDtcbiAgICByZXR1cm4gSVNfRVJST1I7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlO1xuXG5mdW5jdGlvbiBQcm9taXNlKGZuKSB7XG4gIGlmICh0eXBlb2YgdGhpcyAhPT0gJ29iamVjdCcpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQcm9taXNlcyBtdXN0IGJlIGNvbnN0cnVjdGVkIHZpYSBuZXcnKTtcbiAgfVxuICBpZiAodHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUHJvbWlzZSBjb25zdHJ1Y3RvclxcJ3MgYXJndW1lbnQgaXMgbm90IGEgZnVuY3Rpb24nKTtcbiAgfVxuICB0aGlzLl80MCA9IDA7XG4gIHRoaXMuXzY1ID0gMDtcbiAgdGhpcy5fNTUgPSBudWxsO1xuICB0aGlzLl83MiA9IG51bGw7XG4gIGlmIChmbiA9PT0gbm9vcCkgcmV0dXJuO1xuICBkb1Jlc29sdmUoZm4sIHRoaXMpO1xufVxuUHJvbWlzZS5fMzcgPSBudWxsO1xuUHJvbWlzZS5fODcgPSBudWxsO1xuUHJvbWlzZS5fNjEgPSBub29wO1xuXG5Qcm9taXNlLnByb3RvdHlwZS50aGVuID0gZnVuY3Rpb24ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpIHtcbiAgaWYgKHRoaXMuY29uc3RydWN0b3IgIT09IFByb21pc2UpIHtcbiAgICByZXR1cm4gc2FmZVRoZW4odGhpcywgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpO1xuICB9XG4gIHZhciByZXMgPSBuZXcgUHJvbWlzZShub29wKTtcbiAgaGFuZGxlKHRoaXMsIG5ldyBIYW5kbGVyKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCByZXMpKTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbmZ1bmN0aW9uIHNhZmVUaGVuKHNlbGYsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7XG4gIHJldHVybiBuZXcgc2VsZi5jb25zdHJ1Y3RvcihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgdmFyIHJlcyA9IG5ldyBQcm9taXNlKG5vb3ApO1xuICAgIHJlcy50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgaGFuZGxlKHNlbGYsIG5ldyBIYW5kbGVyKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCByZXMpKTtcbiAgfSk7XG59XG5mdW5jdGlvbiBoYW5kbGUoc2VsZiwgZGVmZXJyZWQpIHtcbiAgd2hpbGUgKHNlbGYuXzY1ID09PSAzKSB7XG4gICAgc2VsZiA9IHNlbGYuXzU1O1xuICB9XG4gIGlmIChQcm9taXNlLl8zNykge1xuICAgIFByb21pc2UuXzM3KHNlbGYpO1xuICB9XG4gIGlmIChzZWxmLl82NSA9PT0gMCkge1xuICAgIGlmIChzZWxmLl80MCA9PT0gMCkge1xuICAgICAgc2VsZi5fNDAgPSAxO1xuICAgICAgc2VsZi5fNzIgPSBkZWZlcnJlZDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHNlbGYuXzQwID09PSAxKSB7XG4gICAgICBzZWxmLl80MCA9IDI7XG4gICAgICBzZWxmLl83MiA9IFtzZWxmLl83MiwgZGVmZXJyZWRdO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzZWxmLl83Mi5wdXNoKGRlZmVycmVkKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaGFuZGxlUmVzb2x2ZWQoc2VsZiwgZGVmZXJyZWQpO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVSZXNvbHZlZChzZWxmLCBkZWZlcnJlZCkge1xuICBhc2FwKGZ1bmN0aW9uKCkge1xuICAgIHZhciBjYiA9IHNlbGYuXzY1ID09PSAxID8gZGVmZXJyZWQub25GdWxmaWxsZWQgOiBkZWZlcnJlZC5vblJlamVjdGVkO1xuICAgIGlmIChjYiA9PT0gbnVsbCkge1xuICAgICAgaWYgKHNlbGYuXzY1ID09PSAxKSB7XG4gICAgICAgIHJlc29sdmUoZGVmZXJyZWQucHJvbWlzZSwgc2VsZi5fNTUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVqZWN0KGRlZmVycmVkLnByb21pc2UsIHNlbGYuXzU1KTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHJldCA9IHRyeUNhbGxPbmUoY2IsIHNlbGYuXzU1KTtcbiAgICBpZiAocmV0ID09PSBJU19FUlJPUikge1xuICAgICAgcmVqZWN0KGRlZmVycmVkLnByb21pc2UsIExBU1RfRVJST1IpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNvbHZlKGRlZmVycmVkLnByb21pc2UsIHJldCk7XG4gICAgfVxuICB9KTtcbn1cbmZ1bmN0aW9uIHJlc29sdmUoc2VsZiwgbmV3VmFsdWUpIHtcbiAgLy8gUHJvbWlzZSBSZXNvbHV0aW9uIFByb2NlZHVyZTogaHR0cHM6Ly9naXRodWIuY29tL3Byb21pc2VzLWFwbHVzL3Byb21pc2VzLXNwZWMjdGhlLXByb21pc2UtcmVzb2x1dGlvbi1wcm9jZWR1cmVcbiAgaWYgKG5ld1ZhbHVlID09PSBzZWxmKSB7XG4gICAgcmV0dXJuIHJlamVjdChcbiAgICAgIHNlbGYsXG4gICAgICBuZXcgVHlwZUVycm9yKCdBIHByb21pc2UgY2Fubm90IGJlIHJlc29sdmVkIHdpdGggaXRzZWxmLicpXG4gICAgKTtcbiAgfVxuICBpZiAoXG4gICAgbmV3VmFsdWUgJiZcbiAgICAodHlwZW9mIG5ld1ZhbHVlID09PSAnb2JqZWN0JyB8fCB0eXBlb2YgbmV3VmFsdWUgPT09ICdmdW5jdGlvbicpXG4gICkge1xuICAgIHZhciB0aGVuID0gZ2V0VGhlbihuZXdWYWx1ZSk7XG4gICAgaWYgKHRoZW4gPT09IElTX0VSUk9SKSB7XG4gICAgICByZXR1cm4gcmVqZWN0KHNlbGYsIExBU1RfRVJST1IpO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICB0aGVuID09PSBzZWxmLnRoZW4gJiZcbiAgICAgIG5ld1ZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZVxuICAgICkge1xuICAgICAgc2VsZi5fNjUgPSAzO1xuICAgICAgc2VsZi5fNTUgPSBuZXdWYWx1ZTtcbiAgICAgIGZpbmFsZShzZWxmKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGVuID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBkb1Jlc29sdmUodGhlbi5iaW5kKG5ld1ZhbHVlKSwgc2VsZik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIHNlbGYuXzY1ID0gMTtcbiAgc2VsZi5fNTUgPSBuZXdWYWx1ZTtcbiAgZmluYWxlKHNlbGYpO1xufVxuXG5mdW5jdGlvbiByZWplY3Qoc2VsZiwgbmV3VmFsdWUpIHtcbiAgc2VsZi5fNjUgPSAyO1xuICBzZWxmLl81NSA9IG5ld1ZhbHVlO1xuICBpZiAoUHJvbWlzZS5fODcpIHtcbiAgICBQcm9taXNlLl84NyhzZWxmLCBuZXdWYWx1ZSk7XG4gIH1cbiAgZmluYWxlKHNlbGYpO1xufVxuZnVuY3Rpb24gZmluYWxlKHNlbGYpIHtcbiAgaWYgKHNlbGYuXzQwID09PSAxKSB7XG4gICAgaGFuZGxlKHNlbGYsIHNlbGYuXzcyKTtcbiAgICBzZWxmLl83MiA9IG51bGw7XG4gIH1cbiAgaWYgKHNlbGYuXzQwID09PSAyKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxmLl83Mi5sZW5ndGg7IGkrKykge1xuICAgICAgaGFuZGxlKHNlbGYsIHNlbGYuXzcyW2ldKTtcbiAgICB9XG4gICAgc2VsZi5fNzIgPSBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIEhhbmRsZXIob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIHByb21pc2Upe1xuICB0aGlzLm9uRnVsZmlsbGVkID0gdHlwZW9mIG9uRnVsZmlsbGVkID09PSAnZnVuY3Rpb24nID8gb25GdWxmaWxsZWQgOiBudWxsO1xuICB0aGlzLm9uUmVqZWN0ZWQgPSB0eXBlb2Ygb25SZWplY3RlZCA9PT0gJ2Z1bmN0aW9uJyA/IG9uUmVqZWN0ZWQgOiBudWxsO1xuICB0aGlzLnByb21pc2UgPSBwcm9taXNlO1xufVxuXG4vKipcbiAqIFRha2UgYSBwb3RlbnRpYWxseSBtaXNiZWhhdmluZyByZXNvbHZlciBmdW5jdGlvbiBhbmQgbWFrZSBzdXJlXG4gKiBvbkZ1bGZpbGxlZCBhbmQgb25SZWplY3RlZCBhcmUgb25seSBjYWxsZWQgb25jZS5cbiAqXG4gKiBNYWtlcyBubyBndWFyYW50ZWVzIGFib3V0IGFzeW5jaHJvbnkuXG4gKi9cbmZ1bmN0aW9uIGRvUmVzb2x2ZShmbiwgcHJvbWlzZSkge1xuICB2YXIgZG9uZSA9IGZhbHNlO1xuICB2YXIgcmVzID0gdHJ5Q2FsbFR3byhmbiwgZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgaWYgKGRvbmUpIHJldHVybjtcbiAgICBkb25lID0gdHJ1ZTtcbiAgICByZXNvbHZlKHByb21pc2UsIHZhbHVlKTtcbiAgfSwgZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIGlmIChkb25lKSByZXR1cm47XG4gICAgZG9uZSA9IHRydWU7XG4gICAgcmVqZWN0KHByb21pc2UsIHJlYXNvbik7XG4gIH0pO1xuICBpZiAoIWRvbmUgJiYgcmVzID09PSBJU19FUlJPUikge1xuICAgIGRvbmUgPSB0cnVlO1xuICAgIHJlamVjdChwcm9taXNlLCBMQVNUX0VSUk9SKTtcbiAgfVxufVxuIl19