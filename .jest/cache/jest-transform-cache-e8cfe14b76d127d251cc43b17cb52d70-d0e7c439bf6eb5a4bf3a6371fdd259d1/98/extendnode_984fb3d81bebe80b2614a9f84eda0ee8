199d052df42a846bfabef7b0671622d3
"use strict";

var Buffer = require("buffer").Buffer;

module.exports = function (iconv) {
  var original = undefined;
  iconv.supportsNodeEncodingsExtension = !(Buffer.from || new Buffer(0) instanceof Uint8Array);

  iconv.extendNodeEncodings = function extendNodeEncodings() {
    if (original) return;
    original = {};

    if (!iconv.supportsNodeEncodingsExtension) {
      console.error("ACTION NEEDED: require('iconv-lite').extendNodeEncodings() is not supported in your version of Node");
      console.error("See more info at https://github.com/ashtuchkin/iconv-lite/wiki/Node-v4-compatibility");
      return;
    }

    var nodeNativeEncodings = {
      'hex': true,
      'utf8': true,
      'utf-8': true,
      'ascii': true,
      'binary': true,
      'base64': true,
      'ucs2': true,
      'ucs-2': true,
      'utf16le': true,
      'utf-16le': true
    };

    Buffer.isNativeEncoding = function (enc) {
      return enc && nodeNativeEncodings[enc.toLowerCase()];
    };

    var SlowBuffer = require('buffer').SlowBuffer;

    original.SlowBufferToString = SlowBuffer.prototype.toString;

    SlowBuffer.prototype.toString = function (encoding, start, end) {
      encoding = String(encoding || 'utf8').toLowerCase();
      if (Buffer.isNativeEncoding(encoding)) return original.SlowBufferToString.call(this, encoding, start, end);
      if (typeof start == 'undefined') start = 0;
      if (typeof end == 'undefined') end = this.length;
      return iconv.decode(this.slice(start, end), encoding);
    };

    original.SlowBufferWrite = SlowBuffer.prototype.write;

    SlowBuffer.prototype.write = function (string, offset, length, encoding) {
      if (isFinite(offset)) {
        if (!isFinite(length)) {
          encoding = length;
          length = undefined;
        }
      } else {
        var swap = encoding;
        encoding = offset;
        offset = length;
        length = swap;
      }

      offset = +offset || 0;
      var remaining = this.length - offset;

      if (!length) {
        length = remaining;
      } else {
        length = +length;

        if (length > remaining) {
          length = remaining;
        }
      }

      encoding = String(encoding || 'utf8').toLowerCase();
      if (Buffer.isNativeEncoding(encoding)) return original.SlowBufferWrite.call(this, string, offset, length, encoding);
      if (string.length > 0 && (length < 0 || offset < 0)) throw new RangeError('attempt to write beyond buffer bounds');
      var buf = iconv.encode(string, encoding);
      if (buf.length < length) length = buf.length;
      buf.copy(this, offset, 0, length);
      return length;
    };

    original.BufferIsEncoding = Buffer.isEncoding;

    Buffer.isEncoding = function (encoding) {
      return Buffer.isNativeEncoding(encoding) || iconv.encodingExists(encoding);
    };

    original.BufferByteLength = Buffer.byteLength;

    Buffer.byteLength = SlowBuffer.byteLength = function (str, encoding) {
      encoding = String(encoding || 'utf8').toLowerCase();
      if (Buffer.isNativeEncoding(encoding)) return original.BufferByteLength.call(this, str, encoding);
      return iconv.encode(str, encoding).length;
    };

    original.BufferToString = Buffer.prototype.toString;

    Buffer.prototype.toString = function (encoding, start, end) {
      encoding = String(encoding || 'utf8').toLowerCase();
      if (Buffer.isNativeEncoding(encoding)) return original.BufferToString.call(this, encoding, start, end);
      if (typeof start == 'undefined') start = 0;
      if (typeof end == 'undefined') end = this.length;
      return iconv.decode(this.slice(start, end), encoding);
    };

    original.BufferWrite = Buffer.prototype.write;

    Buffer.prototype.write = function (string, offset, length, encoding) {
      var _offset = offset,
          _length = length,
          _encoding = encoding;

      if (isFinite(offset)) {
        if (!isFinite(length)) {
          encoding = length;
          length = undefined;
        }
      } else {
        var swap = encoding;
        encoding = offset;
        offset = length;
        length = swap;
      }

      encoding = String(encoding || 'utf8').toLowerCase();
      if (Buffer.isNativeEncoding(encoding)) return original.BufferWrite.call(this, string, _offset, _length, _encoding);
      offset = +offset || 0;
      var remaining = this.length - offset;

      if (!length) {
        length = remaining;
      } else {
        length = +length;

        if (length > remaining) {
          length = remaining;
        }
      }

      if (string.length > 0 && (length < 0 || offset < 0)) throw new RangeError('attempt to write beyond buffer bounds');
      var buf = iconv.encode(string, encoding);
      if (buf.length < length) length = buf.length;
      buf.copy(this, offset, 0, length);
      return length;
    };

    if (iconv.supportsStreams) {
      var Readable = require('stream').Readable;

      original.ReadableSetEncoding = Readable.prototype.setEncoding;

      Readable.prototype.setEncoding = function setEncoding(enc, options) {
        this._readableState.decoder = iconv.getDecoder(enc, options);
        this._readableState.encoding = enc;
      };

      Readable.prototype.collect = iconv._collect;
    }
  };

  iconv.undoExtendNodeEncodings = function undoExtendNodeEncodings() {
    if (!iconv.supportsNodeEncodingsExtension) return;
    if (!original) throw new Error("require('iconv-lite').undoExtendNodeEncodings(): Nothing to undo; extendNodeEncodings() is not called.");
    delete Buffer.isNativeEncoding;

    var SlowBuffer = require('buffer').SlowBuffer;

    SlowBuffer.prototype.toString = original.SlowBufferToString;
    SlowBuffer.prototype.write = original.SlowBufferWrite;
    Buffer.isEncoding = original.BufferIsEncoding;
    Buffer.byteLength = original.BufferByteLength;
    Buffer.prototype.toString = original.BufferToString;
    Buffer.prototype.write = original.BufferWrite;

    if (iconv.supportsStreams) {
      var Readable = require('stream').Readable;

      Readable.prototype.setEncoding = original.ReadableSetEncoding;
      delete Readable.prototype.collect;
    }

    original = undefined;
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dGVuZC1ub2RlLmpzIl0sIm5hbWVzIjpbIkJ1ZmZlciIsInJlcXVpcmUiLCJtb2R1bGUiLCJleHBvcnRzIiwiaWNvbnYiLCJvcmlnaW5hbCIsInVuZGVmaW5lZCIsInN1cHBvcnRzTm9kZUVuY29kaW5nc0V4dGVuc2lvbiIsImZyb20iLCJVaW50OEFycmF5IiwiZXh0ZW5kTm9kZUVuY29kaW5ncyIsImNvbnNvbGUiLCJlcnJvciIsIm5vZGVOYXRpdmVFbmNvZGluZ3MiLCJpc05hdGl2ZUVuY29kaW5nIiwiZW5jIiwidG9Mb3dlckNhc2UiLCJTbG93QnVmZmVyIiwiU2xvd0J1ZmZlclRvU3RyaW5nIiwicHJvdG90eXBlIiwidG9TdHJpbmciLCJlbmNvZGluZyIsInN0YXJ0IiwiZW5kIiwiU3RyaW5nIiwiY2FsbCIsImxlbmd0aCIsImRlY29kZSIsInNsaWNlIiwiU2xvd0J1ZmZlcldyaXRlIiwid3JpdGUiLCJzdHJpbmciLCJvZmZzZXQiLCJpc0Zpbml0ZSIsInN3YXAiLCJyZW1haW5pbmciLCJSYW5nZUVycm9yIiwiYnVmIiwiZW5jb2RlIiwiY29weSIsIkJ1ZmZlcklzRW5jb2RpbmciLCJpc0VuY29kaW5nIiwiZW5jb2RpbmdFeGlzdHMiLCJCdWZmZXJCeXRlTGVuZ3RoIiwiYnl0ZUxlbmd0aCIsInN0ciIsIkJ1ZmZlclRvU3RyaW5nIiwiQnVmZmVyV3JpdGUiLCJfb2Zmc2V0IiwiX2xlbmd0aCIsIl9lbmNvZGluZyIsInN1cHBvcnRzU3RyZWFtcyIsIlJlYWRhYmxlIiwiUmVhZGFibGVTZXRFbmNvZGluZyIsInNldEVuY29kaW5nIiwib3B0aW9ucyIsIl9yZWFkYWJsZVN0YXRlIiwiZGVjb2RlciIsImdldERlY29kZXIiLCJjb2xsZWN0IiwiX2NvbGxlY3QiLCJ1bmRvRXh0ZW5kTm9kZUVuY29kaW5ncyIsIkVycm9yIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JELE1BQS9C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QUM0QyxVQUFQLEdBQW9CdkMsUUFBUSxDQUFDc0MsZ0JBQTdCO0FBQ0EzQyxJQUFBQSxNQUFNLENBQUNtQixTQUFQLENBQWlCQyxRQUFqQixHQUE0QmYsUUFBUSxDQUFDeUMsY0FBckM7QUFDQTlDLElBQUFBLE1BQU0sQ0FBQ21CLFNBQVAsQ0FBaUJXLEtBQWpCLEdBQXlCekIsUUFBUSxDQUFDMEMsV0FBbEM7O0FBRUEsUUFBSTNDLEtBQUssQ0FBQytDLGVBQVYsRUFBMkI7QUFDdkIsVUFBSUMsUUFBUSxHQUFHbkQsT0FBTyxDQUFDLFFBQUQsQ0FBUCxDQUFrQm1ELFFBQWpDOztBQUVBQSxNQUFBQSxRQUFRLENBQUNqQyxTQUFULENBQW1CbUMsV0FBbkIsR0FBaUNqRCxRQUFRLENBQUNnRCxtQkFBMUM7QUFDQSxhQUFPRCxRQUFRLENBQUNqQyxTQUFULENBQW1Cd0MsT0FBMUI7QUFDSDs7QUFFRHRELElBQUFBLFFBQVEsR0FBR0MsU0FBWDtBQUNILEdBMUJEO0FBMkJILENBbE5EIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgQnVmZmVyID0gcmVxdWlyZShcImJ1ZmZlclwiKS5CdWZmZXI7XG4vLyBOb3RlOiBub3QgcG9seWZpbGxlZCB3aXRoIHNhZmVyLWJ1ZmZlciBvbiBhIHB1cnBvc2UsIGFzIG92ZXJyaWRlcyBCdWZmZXJcblxuLy8gPT0gRXh0ZW5kIE5vZGUgcHJpbWl0aXZlcyB0byB1c2UgaWNvbnYtbGl0ZSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoaWNvbnYpIHtcbiAgICB2YXIgb3JpZ2luYWwgPSB1bmRlZmluZWQ7IC8vIFBsYWNlIHRvIGtlZXAgb3JpZ2luYWwgbWV0aG9kcy5cblxuICAgIC8vIE5vZGUgYXV0aG9ycyByZXdyb3RlIEJ1ZmZlciBpbnRlcm5hbHMgdG8gbWFrZSBpdCBjb21wYXRpYmxlIHdpdGhcbiAgICAvLyBVaW50OEFycmF5IGFuZCB3ZSBjYW5ub3QgcGF0Y2gga2V5IGZ1bmN0aW9ucyBzaW5jZSB0aGVuLlxuICAgIC8vIE5vdGU6IHRoaXMgZG9lcyB1c2Ugb2xkZXIgQnVmZmVyIEFQSSBvbiBhIHB1cnBvc2VcbiAgICBpY29udi5zdXBwb3J0c05vZGVFbmNvZGluZ3NFeHRlbnNpb24gPSAhKEJ1ZmZlci5mcm9tIHx8IG5ldyBCdWZmZXIoMCkgaW5zdGFuY2VvZiBVaW50OEFycmF5KTtcblxuICAgIGljb252LmV4dGVuZE5vZGVFbmNvZGluZ3MgPSBmdW5jdGlvbiBleHRlbmROb2RlRW5jb2RpbmdzKCkge1xuICAgICAgICBpZiAob3JpZ2luYWwpIHJldHVybjtcbiAgICAgICAgb3JpZ2luYWwgPSB7fTtcblxuICAgICAgICBpZiAoIWljb252LnN1cHBvcnRzTm9kZUVuY29kaW5nc0V4dGVuc2lvbikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkFDVElPTiBORUVERUQ6IHJlcXVpcmUoJ2ljb252LWxpdGUnKS5leHRlbmROb2RlRW5jb2RpbmdzKCkgaXMgbm90IHN1cHBvcnRlZCBpbiB5b3VyIHZlcnNpb24gb2YgTm9kZVwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJTZWUgbW9yZSBpbmZvIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9hc2h0dWNoa2luL2ljb252LWxpdGUvd2lraS9Ob2RlLXY0LWNvbXBhdGliaWxpdHlcIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgbm9kZU5hdGl2ZUVuY29kaW5ncyA9IHtcbiAgICAgICAgICAgICdoZXgnOiB0cnVlLCAndXRmOCc6IHRydWUsICd1dGYtOCc6IHRydWUsICdhc2NpaSc6IHRydWUsICdiaW5hcnknOiB0cnVlLCBcbiAgICAgICAgICAgICdiYXNlNjQnOiB0cnVlLCAndWNzMic6IHRydWUsICd1Y3MtMic6IHRydWUsICd1dGYxNmxlJzogdHJ1ZSwgJ3V0Zi0xNmxlJzogdHJ1ZSxcbiAgICAgICAgfTtcblxuICAgICAgICBCdWZmZXIuaXNOYXRpdmVFbmNvZGluZyA9IGZ1bmN0aW9uKGVuYykge1xuICAgICAgICAgICAgcmV0dXJuIGVuYyAmJiBub2RlTmF0aXZlRW5jb2RpbmdzW2VuYy50b0xvd2VyQ2FzZSgpXTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIC0tIFNsb3dCdWZmZXIgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgdmFyIFNsb3dCdWZmZXIgPSByZXF1aXJlKCdidWZmZXInKS5TbG93QnVmZmVyO1xuXG4gICAgICAgIG9yaWdpbmFsLlNsb3dCdWZmZXJUb1N0cmluZyA9IFNsb3dCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nO1xuICAgICAgICBTbG93QnVmZmVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKGVuY29kaW5nLCBzdGFydCwgZW5kKSB7XG4gICAgICAgICAgICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZyB8fCAndXRmOCcpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgICAgIC8vIFVzZSBuYXRpdmUgY29udmVyc2lvbiB3aGVuIHBvc3NpYmxlXG4gICAgICAgICAgICBpZiAoQnVmZmVyLmlzTmF0aXZlRW5jb2RpbmcoZW5jb2RpbmcpKVxuICAgICAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbC5TbG93QnVmZmVyVG9TdHJpbmcuY2FsbCh0aGlzLCBlbmNvZGluZywgc3RhcnQsIGVuZCk7XG5cbiAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgdXNlIG91ciBkZWNvZGluZyBtZXRob2QuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHN0YXJ0ID09ICd1bmRlZmluZWQnKSBzdGFydCA9IDA7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGVuZCA9PSAndW5kZWZpbmVkJykgZW5kID0gdGhpcy5sZW5ndGg7XG4gICAgICAgICAgICByZXR1cm4gaWNvbnYuZGVjb2RlKHRoaXMuc2xpY2Uoc3RhcnQsIGVuZCksIGVuY29kaW5nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9yaWdpbmFsLlNsb3dCdWZmZXJXcml0ZSA9IFNsb3dCdWZmZXIucHJvdG90eXBlLndyaXRlO1xuICAgICAgICBTbG93QnVmZmVyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKSB7XG4gICAgICAgICAgICAvLyBTdXBwb3J0IGJvdGggKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKVxuICAgICAgICAgICAgLy8gYW5kIHRoZSBsZWdhY3kgKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldCwgbGVuZ3RoKVxuICAgICAgICAgICAgaWYgKGlzRmluaXRlKG9mZnNldCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzRmluaXRlKGxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZW5jb2RpbmcgPSBsZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgeyAgLy8gbGVnYWN5XG4gICAgICAgICAgICAgICAgdmFyIHN3YXAgPSBlbmNvZGluZztcbiAgICAgICAgICAgICAgICBlbmNvZGluZyA9IG9mZnNldDtcbiAgICAgICAgICAgICAgICBvZmZzZXQgPSBsZW5ndGg7XG4gICAgICAgICAgICAgICAgbGVuZ3RoID0gc3dhcDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgb2Zmc2V0ID0gK29mZnNldCB8fCAwO1xuICAgICAgICAgICAgdmFyIHJlbWFpbmluZyA9IHRoaXMubGVuZ3RoIC0gb2Zmc2V0O1xuICAgICAgICAgICAgaWYgKCFsZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBsZW5ndGggPSByZW1haW5pbmc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxlbmd0aCA9ICtsZW5ndGg7XG4gICAgICAgICAgICAgICAgaWYgKGxlbmd0aCA+IHJlbWFpbmluZykge1xuICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSByZW1haW5pbmc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZW5jb2RpbmcgPSBTdHJpbmcoZW5jb2RpbmcgfHwgJ3V0ZjgnKS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgICAgICAvLyBVc2UgbmF0aXZlIGNvbnZlcnNpb24gd2hlbiBwb3NzaWJsZVxuICAgICAgICAgICAgaWYgKEJ1ZmZlci5pc05hdGl2ZUVuY29kaW5nKGVuY29kaW5nKSlcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwuU2xvd0J1ZmZlcldyaXRlLmNhbGwodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpO1xuXG4gICAgICAgICAgICBpZiAoc3RyaW5nLmxlbmd0aCA+IDAgJiYgKGxlbmd0aCA8IDAgfHwgb2Zmc2V0IDwgMCkpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ2F0dGVtcHQgdG8gd3JpdGUgYmV5b25kIGJ1ZmZlciBib3VuZHMnKTtcblxuICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCB1c2Ugb3VyIGVuY29kaW5nIG1ldGhvZC5cbiAgICAgICAgICAgIHZhciBidWYgPSBpY29udi5lbmNvZGUoc3RyaW5nLCBlbmNvZGluZyk7XG4gICAgICAgICAgICBpZiAoYnVmLmxlbmd0aCA8IGxlbmd0aCkgbGVuZ3RoID0gYnVmLmxlbmd0aDtcbiAgICAgICAgICAgIGJ1Zi5jb3B5KHRoaXMsIG9mZnNldCwgMCwgbGVuZ3RoKTtcbiAgICAgICAgICAgIHJldHVybiBsZW5ndGg7XG4gICAgICAgIH1cblxuICAgICAgICAvLyAtLSBCdWZmZXIgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICAgICAgb3JpZ2luYWwuQnVmZmVySXNFbmNvZGluZyA9IEJ1ZmZlci5pc0VuY29kaW5nO1xuICAgICAgICBCdWZmZXIuaXNFbmNvZGluZyA9IGZ1bmN0aW9uKGVuY29kaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gQnVmZmVyLmlzTmF0aXZlRW5jb2RpbmcoZW5jb2RpbmcpIHx8IGljb252LmVuY29kaW5nRXhpc3RzKGVuY29kaW5nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9yaWdpbmFsLkJ1ZmZlckJ5dGVMZW5ndGggPSBCdWZmZXIuYnl0ZUxlbmd0aDtcbiAgICAgICAgQnVmZmVyLmJ5dGVMZW5ndGggPSBTbG93QnVmZmVyLmJ5dGVMZW5ndGggPSBmdW5jdGlvbihzdHIsIGVuY29kaW5nKSB7XG4gICAgICAgICAgICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZyB8fCAndXRmOCcpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgICAgIC8vIFVzZSBuYXRpdmUgY29udmVyc2lvbiB3aGVuIHBvc3NpYmxlXG4gICAgICAgICAgICBpZiAoQnVmZmVyLmlzTmF0aXZlRW5jb2RpbmcoZW5jb2RpbmcpKVxuICAgICAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbC5CdWZmZXJCeXRlTGVuZ3RoLmNhbGwodGhpcywgc3RyLCBlbmNvZGluZyk7XG5cbiAgICAgICAgICAgIC8vIFNsb3csIEkga25vdywgYnV0IHdlIGRvbid0IGhhdmUgYSBiZXR0ZXIgd2F5IHlldC5cbiAgICAgICAgICAgIHJldHVybiBpY29udi5lbmNvZGUoc3RyLCBlbmNvZGluZykubGVuZ3RoO1xuICAgICAgICB9XG5cbiAgICAgICAgb3JpZ2luYWwuQnVmZmVyVG9TdHJpbmcgPSBCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nO1xuICAgICAgICBCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oZW5jb2RpbmcsIHN0YXJ0LCBlbmQpIHtcbiAgICAgICAgICAgIGVuY29kaW5nID0gU3RyaW5nKGVuY29kaW5nIHx8ICd1dGY4JykudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgLy8gVXNlIG5hdGl2ZSBjb252ZXJzaW9uIHdoZW4gcG9zc2libGVcbiAgICAgICAgICAgIGlmIChCdWZmZXIuaXNOYXRpdmVFbmNvZGluZyhlbmNvZGluZykpXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsLkJ1ZmZlclRvU3RyaW5nLmNhbGwodGhpcywgZW5jb2RpbmcsIHN0YXJ0LCBlbmQpO1xuXG4gICAgICAgICAgICAvLyBPdGhlcndpc2UsIHVzZSBvdXIgZGVjb2RpbmcgbWV0aG9kLlxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PSAndW5kZWZpbmVkJykgc3RhcnQgPSAwO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBlbmQgPT0gJ3VuZGVmaW5lZCcpIGVuZCA9IHRoaXMubGVuZ3RoO1xuICAgICAgICAgICAgcmV0dXJuIGljb252LmRlY29kZSh0aGlzLnNsaWNlKHN0YXJ0LCBlbmQpLCBlbmNvZGluZyk7XG4gICAgICAgIH1cblxuICAgICAgICBvcmlnaW5hbC5CdWZmZXJXcml0ZSA9IEJ1ZmZlci5wcm90b3R5cGUud3JpdGU7XG4gICAgICAgIEJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbihzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykge1xuICAgICAgICAgICAgdmFyIF9vZmZzZXQgPSBvZmZzZXQsIF9sZW5ndGggPSBsZW5ndGgsIF9lbmNvZGluZyA9IGVuY29kaW5nO1xuICAgICAgICAgICAgLy8gU3VwcG9ydCBib3RoIChzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZylcbiAgICAgICAgICAgIC8vIGFuZCB0aGUgbGVnYWN5IChzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXQsIGxlbmd0aClcbiAgICAgICAgICAgIGlmIChpc0Zpbml0ZShvZmZzZXQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc0Zpbml0ZShsZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGVuY29kaW5nID0gbGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHsgIC8vIGxlZ2FjeVxuICAgICAgICAgICAgICAgIHZhciBzd2FwID0gZW5jb2Rpbmc7XG4gICAgICAgICAgICAgICAgZW5jb2RpbmcgPSBvZmZzZXQ7XG4gICAgICAgICAgICAgICAgb2Zmc2V0ID0gbGVuZ3RoO1xuICAgICAgICAgICAgICAgIGxlbmd0aCA9IHN3YXA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVuY29kaW5nID0gU3RyaW5nKGVuY29kaW5nIHx8ICd1dGY4JykudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgLy8gVXNlIG5hdGl2ZSBjb252ZXJzaW9uIHdoZW4gcG9zc2libGVcbiAgICAgICAgICAgIGlmIChCdWZmZXIuaXNOYXRpdmVFbmNvZGluZyhlbmNvZGluZykpXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsLkJ1ZmZlcldyaXRlLmNhbGwodGhpcywgc3RyaW5nLCBfb2Zmc2V0LCBfbGVuZ3RoLCBfZW5jb2RpbmcpO1xuXG4gICAgICAgICAgICBvZmZzZXQgPSArb2Zmc2V0IHx8IDA7XG4gICAgICAgICAgICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQ7XG4gICAgICAgICAgICBpZiAoIWxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlbWFpbmluZztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGVuZ3RoID0gK2xlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlbWFpbmluZztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzdHJpbmcubGVuZ3RoID4gMCAmJiAobGVuZ3RoIDwgMCB8fCBvZmZzZXQgPCAwKSlcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignYXR0ZW1wdCB0byB3cml0ZSBiZXlvbmQgYnVmZmVyIGJvdW5kcycpO1xuXG4gICAgICAgICAgICAvLyBPdGhlcndpc2UsIHVzZSBvdXIgZW5jb2RpbmcgbWV0aG9kLlxuICAgICAgICAgICAgdmFyIGJ1ZiA9IGljb252LmVuY29kZShzdHJpbmcsIGVuY29kaW5nKTtcbiAgICAgICAgICAgIGlmIChidWYubGVuZ3RoIDwgbGVuZ3RoKSBsZW5ndGggPSBidWYubGVuZ3RoO1xuICAgICAgICAgICAgYnVmLmNvcHkodGhpcywgb2Zmc2V0LCAwLCBsZW5ndGgpO1xuICAgICAgICAgICAgcmV0dXJuIGxlbmd0aDtcblxuICAgICAgICAgICAgLy8gVE9ETzogU2V0IF9jaGFyc1dyaXR0ZW4uXG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIC0tIFJlYWRhYmxlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgaWYgKGljb252LnN1cHBvcnRzU3RyZWFtcykge1xuICAgICAgICAgICAgdmFyIFJlYWRhYmxlID0gcmVxdWlyZSgnc3RyZWFtJykuUmVhZGFibGU7XG5cbiAgICAgICAgICAgIG9yaWdpbmFsLlJlYWRhYmxlU2V0RW5jb2RpbmcgPSBSZWFkYWJsZS5wcm90b3R5cGUuc2V0RW5jb2Rpbmc7XG4gICAgICAgICAgICBSZWFkYWJsZS5wcm90b3R5cGUuc2V0RW5jb2RpbmcgPSBmdW5jdGlvbiBzZXRFbmNvZGluZyhlbmMsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAvLyBVc2Ugb3VyIG93biBkZWNvZGVyLCBpdCBoYXMgdGhlIHNhbWUgaW50ZXJmYWNlLlxuICAgICAgICAgICAgICAgIC8vIFdlIGNhbm5vdCB1c2Ugb3JpZ2luYWwgZnVuY3Rpb24gYXMgaXQgZG9lc24ndCBoYW5kbGUgQk9NLXMuXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5kZWNvZGVyID0gaWNvbnYuZ2V0RGVjb2RlcihlbmMsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUuZW5jb2RpbmcgPSBlbmM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIFJlYWRhYmxlLnByb3RvdHlwZS5jb2xsZWN0ID0gaWNvbnYuX2NvbGxlY3Q7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBSZW1vdmUgaWNvbnYtbGl0ZSBOb2RlIHByaW1pdGl2ZSBleHRlbnNpb25zLlxuICAgIGljb252LnVuZG9FeHRlbmROb2RlRW5jb2RpbmdzID0gZnVuY3Rpb24gdW5kb0V4dGVuZE5vZGVFbmNvZGluZ3MoKSB7XG4gICAgICAgIGlmICghaWNvbnYuc3VwcG9ydHNOb2RlRW5jb2RpbmdzRXh0ZW5zaW9uKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBpZiAoIW9yaWdpbmFsKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicmVxdWlyZSgnaWNvbnYtbGl0ZScpLnVuZG9FeHRlbmROb2RlRW5jb2RpbmdzKCk6IE5vdGhpbmcgdG8gdW5kbzsgZXh0ZW5kTm9kZUVuY29kaW5ncygpIGlzIG5vdCBjYWxsZWQuXCIpXG5cbiAgICAgICAgZGVsZXRlIEJ1ZmZlci5pc05hdGl2ZUVuY29kaW5nO1xuXG4gICAgICAgIHZhciBTbG93QnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuU2xvd0J1ZmZlcjtcblxuICAgICAgICBTbG93QnVmZmVyLnByb3RvdHlwZS50b1N0cmluZyA9IG9yaWdpbmFsLlNsb3dCdWZmZXJUb1N0cmluZztcbiAgICAgICAgU2xvd0J1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBvcmlnaW5hbC5TbG93QnVmZmVyV3JpdGU7XG5cbiAgICAgICAgQnVmZmVyLmlzRW5jb2RpbmcgPSBvcmlnaW5hbC5CdWZmZXJJc0VuY29kaW5nO1xuICAgICAgICBCdWZmZXIuYnl0ZUxlbmd0aCA9IG9yaWdpbmFsLkJ1ZmZlckJ5dGVMZW5ndGg7XG4gICAgICAgIEJ1ZmZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBvcmlnaW5hbC5CdWZmZXJUb1N0cmluZztcbiAgICAgICAgQnVmZmVyLnByb3RvdHlwZS53cml0ZSA9IG9yaWdpbmFsLkJ1ZmZlcldyaXRlO1xuXG4gICAgICAgIGlmIChpY29udi5zdXBwb3J0c1N0cmVhbXMpIHtcbiAgICAgICAgICAgIHZhciBSZWFkYWJsZSA9IHJlcXVpcmUoJ3N0cmVhbScpLlJlYWRhYmxlO1xuXG4gICAgICAgICAgICBSZWFkYWJsZS5wcm90b3R5cGUuc2V0RW5jb2RpbmcgPSBvcmlnaW5hbC5SZWFkYWJsZVNldEVuY29kaW5nO1xuICAgICAgICAgICAgZGVsZXRlIFJlYWRhYmxlLnByb3RvdHlwZS5jb2xsZWN0O1xuICAgICAgICB9XG5cbiAgICAgICAgb3JpZ2luYWwgPSB1bmRlZmluZWQ7XG4gICAgfVxufVxuIl19