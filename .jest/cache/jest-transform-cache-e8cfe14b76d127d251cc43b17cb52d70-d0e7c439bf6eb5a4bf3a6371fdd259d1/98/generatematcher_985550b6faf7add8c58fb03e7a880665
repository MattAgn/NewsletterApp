b2b18d95fca5a46228a7e1ae5b9d8cd7
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _extends3 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _glob = require('glob-to-regexp');

var pathToRegexp = require('path-to-regexp');

var querystring = require('querystring');

var _require = require('./request-utils'),
    headerUtils = _require.headers,
    getPath = _require.getPath,
    getQuery = _require.getQuery,
    normalizeUrl = _require.normalizeUrl;

var stringMatchers = {
  begin: function begin(targetString) {
    return function (url) {
      return url.indexOf(targetString) === 0;
    };
  },
  end: function end(targetString) {
    return function (url) {
      return url.substr(-targetString.length) === targetString;
    };
  },
  glob: function glob(targetString) {
    var urlRX = _glob(targetString);

    return function (url) {
      return urlRX.test(url);
    };
  },
  express: function express(targetString) {
    var urlRX = pathToRegexp(targetString);
    return function (url) {
      return urlRX.test(getPath(url));
    };
  },
  path: function path(targetString) {
    return function (url) {
      return getPath(url) === targetString;
    };
  }
};

var getHeaderMatcher = function getHeaderMatcher(_ref) {
  var expectedHeaders = _ref.headers;
  var expectation = headerUtils.toLowerCase(expectedHeaders);
  return function (url, _ref2) {
    var _ref2$headers = _ref2.headers,
        headers = _ref2$headers === void 0 ? {} : _ref2$headers;
    var lowerCaseHeaders = headerUtils.toLowerCase(headerUtils.normalize(headers));
    return Object.keys(expectation).every(function (headerName) {
      return headerUtils.equal(lowerCaseHeaders[headerName], expectation[headerName]);
    });
  };
};

var getMethodMatcher = function getMethodMatcher(_ref3) {
  var expectedMethod = _ref3.method;
  return function (url, _ref4) {
    var method = _ref4.method;
    return expectedMethod === (method ? method.toLowerCase() : 'get');
  };
};

var getQueryStringMatcher = function getQueryStringMatcher(_ref5) {
  var expectedQuery = _ref5.query;
  var keys = Object.keys(expectedQuery);
  return function (url) {
    var query = querystring.parse(getQuery(url));
    return keys.every(function (key) {
      return query[key] === expectedQuery[key];
    });
  };
};

var getParamsMatcher = function getParamsMatcher(_ref6) {
  var expectedParams = _ref6.params,
      matcher = _ref6.matcher;

  if (!/express:/.test(matcher)) {
    throw new Error('fetch-mock: matching on params is only possible when using an express: matcher');
  }

  var expectedKeys = Object.keys(expectedParams);
  var keys = [];
  var re = pathToRegexp(matcher.replace(/^express:/, ''), keys);
  return function (url) {
    var vals = re.exec(getPath(url)) || [];
    vals.shift();
    var params = keys.reduce(function (map, _ref7, i) {
      var name = _ref7.name;
      return vals[i] ? (0, _extends3.default)(map, (0, _defineProperty2.default)({}, name, vals[i])) : map;
    }, {});
    return expectedKeys.every(function (key) {
      return params[key] === expectedParams[key];
    });
  };
};

var getFunctionMatcher = function getFunctionMatcher(_ref8) {
  var matcher = _ref8.matcher,
      _ref8$functionMatcher = _ref8.functionMatcher,
      functionMatcher = _ref8$functionMatcher === void 0 ? function () {
    return true;
  } : _ref8$functionMatcher;
  return typeof matcher === 'function' ? matcher : functionMatcher;
};

var getUrlMatcher = function getUrlMatcher(route) {
  var matcher = route.matcher,
      query = route.query;

  if (typeof matcher === 'function') {
    return function () {
      return true;
    };
  }

  if (matcher instanceof RegExp) {
    return function (url) {
      return matcher.test(url);
    };
  }

  if (matcher === '*') {
    return function () {
      return true;
    };
  }

  for (var shorthand in stringMatchers) {
    if (matcher.indexOf(shorthand + ':') === 0) {
      var url = matcher.replace(new RegExp("^" + shorthand + ":"), '');
      return stringMatchers[shorthand](url);
    }
  }

  var expectedUrl = normalizeUrl(matcher);

  if (route.identifier === matcher) {
    route.identifier = expectedUrl;
  }

  return function (url) {
    if (query && expectedUrl.indexOf('?')) {
      return url.indexOf(expectedUrl) === 0;
    }

    return normalizeUrl(url) === expectedUrl;
  };
};

module.exports = function (route) {
  var matchers = [route.query && getQueryStringMatcher(route), route.method && getMethodMatcher(route), route.headers && getHeaderMatcher(route), route.params && getParamsMatcher(route), getFunctionMatcher(route), getUrlMatcher(route)].filter(function (matcher) {
    return !!matcher;
  });
  return function (url) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    var request = arguments.length > 2 ? arguments[2] : undefined;
    return matchers.every(function (matcher) {
      return matcher(url, options, request);
    });
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdlbmVyYXRlLW1hdGNoZXIuanMiXSwibmFtZXMiOlsiZ2xvYiIsInJlcXVpcmUiLCJwYXRoVG9SZWdleHAiLCJxdWVyeXN0cmluZyIsImhlYWRlclV0aWxzIiwiaGVhZGVycyIsImdldFBhdGgiLCJnZXRRdWVyeSIsIm5vcm1hbGl6ZVVybCIsInN0cmluZ01hdGNoZXJzIiwiYmVnaW4iLCJ0YXJnZXRTdHJpbmciLCJ1cmwiLCJpbmRleE9mIiwiZW5kIiwic3Vic3RyIiwibGVuZ3RoIiwidXJsUlgiLCJ0ZXN0IiwiZXhwcmVzcyIsInBhdGgiLCJnZXRIZWFkZXJNYXRjaGVyIiwiZXhwZWN0ZWRIZWFkZXJzIiwiZXhwZWN0YXRpb24iLCJ0b0xvd2VyQ2FzZSIsImxvd2VyQ2FzZUhlYWRlcnMiLCJub3JtYWxpemUiLCJPYmplY3QiLCJrZXlzIiwiZXZlcnkiLCJoZWFkZXJOYW1lIiwiZXF1YWwiLCJnZXRNZXRob2RNYXRjaGVyIiwiZXhwZWN0ZWRNZXRob2QiLCJtZXRob2QiLCJnZXRRdWVyeVN0cmluZ01hdGNoZXIiLCJleHBlY3RlZFF1ZXJ5IiwicXVlcnkiLCJwYXJzZSIsImtleSIsImdldFBhcmFtc01hdGNoZXIiLCJleHBlY3RlZFBhcmFtcyIsInBhcmFtcyIsIm1hdGNoZXIiLCJFcnJvciIsImV4cGVjdGVkS2V5cyIsInJlIiwicmVwbGFjZSIsInZhbHMiLCJleGVjIiwic2hpZnQiLCJyZWR1Y2UiLCJtYXAiLCJpIiwibmFtZSIsImdldEZ1bmN0aW9uTWF0Y2hlciIsImZ1bmN0aW9uTWF0Y2hlciIsImdldFVybE1hdGNoZXIiLCJyb3V0ZSIsIlJlZ0V4cCIsInNob3J0aGFuZCIsImV4cGVjdGVkVXJsIiwiaWRlbnRpZmllciIsIm1vZHVsZSIsImV4cG9ydHMiLCJtYXRjaGVycyIsImZpbHRlciIsIm9wdGlvbnMiLCJyZXF1ZXN0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFNQSxLQUFJLEdBQUdDLE9BQU8sQ0FBQyxnQkFBRCxDQUFwQjs7QUFD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TEYsRUFNaEJELGFBQWEsQ0FBQ0MsS0FBRCxDQU5HLEVBT2ZRLE1BUGUsQ0FPUixVQUFBdkIsT0FBTztBQUFBLFdBQUksQ0FBQyxDQUFDQSxPQUFOO0FBQUEsR0FQQyxDQUFqQjtBQVNBLFNBQU8sVUFBQy9CLEdBQUQ7QUFBQSxRQUFNdUQsT0FBTix1RUFBZ0IsRUFBaEI7QUFBQSxRQUFvQkMsT0FBcEI7QUFBQSxXQUNOSCxRQUFRLENBQUNwQyxLQUFULENBQWUsVUFBQWMsT0FBTztBQUFBLGFBQUlBLE9BQU8sQ0FBQy9CLEdBQUQsRUFBTXVELE9BQU4sRUFBZUMsT0FBZixDQUFYO0FBQUEsS0FBdEIsQ0FETTtBQUFBLEdBQVA7QUFFQSxDQVpEIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZ2xvYiA9IHJlcXVpcmUoJ2dsb2ItdG8tcmVnZXhwJyk7XG5jb25zdCBwYXRoVG9SZWdleHAgPSByZXF1aXJlKCdwYXRoLXRvLXJlZ2V4cCcpO1xuY29uc3QgcXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZycpO1xuY29uc3Qge1xuXHRoZWFkZXJzOiBoZWFkZXJVdGlscyxcblx0Z2V0UGF0aCxcblx0Z2V0UXVlcnksXG5cdG5vcm1hbGl6ZVVybFxufSA9IHJlcXVpcmUoJy4vcmVxdWVzdC11dGlscycpO1xuXG5jb25zdCBzdHJpbmdNYXRjaGVycyA9IHtcblx0YmVnaW46IHRhcmdldFN0cmluZyA9PiB1cmwgPT4gdXJsLmluZGV4T2YodGFyZ2V0U3RyaW5nKSA9PT0gMCxcblx0ZW5kOiB0YXJnZXRTdHJpbmcgPT4gdXJsID0+IHVybC5zdWJzdHIoLXRhcmdldFN0cmluZy5sZW5ndGgpID09PSB0YXJnZXRTdHJpbmcsXG5cdGdsb2I6IHRhcmdldFN0cmluZyA9PiB7XG5cdFx0Y29uc3QgdXJsUlggPSBnbG9iKHRhcmdldFN0cmluZyk7XG5cdFx0cmV0dXJuIHVybCA9PiB1cmxSWC50ZXN0KHVybCk7XG5cdH0sXG5cdGV4cHJlc3M6IHRhcmdldFN0cmluZyA9PiB7XG5cdFx0Y29uc3QgdXJsUlggPSBwYXRoVG9SZWdleHAodGFyZ2V0U3RyaW5nKTtcblx0XHRyZXR1cm4gdXJsID0+IHVybFJYLnRlc3QoZ2V0UGF0aCh1cmwpKTtcblx0fSxcblx0cGF0aDogdGFyZ2V0U3RyaW5nID0+IHVybCA9PiBnZXRQYXRoKHVybCkgPT09IHRhcmdldFN0cmluZ1xufTtcblxuY29uc3QgZ2V0SGVhZGVyTWF0Y2hlciA9ICh7IGhlYWRlcnM6IGV4cGVjdGVkSGVhZGVycyB9KSA9PiB7XG5cdGNvbnN0IGV4cGVjdGF0aW9uID0gaGVhZGVyVXRpbHMudG9Mb3dlckNhc2UoZXhwZWN0ZWRIZWFkZXJzKTtcblx0cmV0dXJuICh1cmwsIHsgaGVhZGVycyA9IHt9IH0pID0+IHtcblx0XHRjb25zdCBsb3dlckNhc2VIZWFkZXJzID0gaGVhZGVyVXRpbHMudG9Mb3dlckNhc2UoXG5cdFx0XHRoZWFkZXJVdGlscy5ub3JtYWxpemUoaGVhZGVycylcblx0XHQpO1xuXG5cdFx0cmV0dXJuIE9iamVjdC5rZXlzKGV4cGVjdGF0aW9uKS5ldmVyeShoZWFkZXJOYW1lID0+XG5cdFx0XHRoZWFkZXJVdGlscy5lcXVhbChsb3dlckNhc2VIZWFkZXJzW2hlYWRlck5hbWVdLCBleHBlY3RhdGlvbltoZWFkZXJOYW1lXSlcblx0XHQpO1xuXHR9O1xufTtcblxuY29uc3QgZ2V0TWV0aG9kTWF0Y2hlciA9ICh7IG1ldGhvZDogZXhwZWN0ZWRNZXRob2QgfSkgPT4ge1xuXHRyZXR1cm4gKHVybCwgeyBtZXRob2QgfSkgPT5cblx0XHRleHBlY3RlZE1ldGhvZCA9PT0gKG1ldGhvZCA/IG1ldGhvZC50b0xvd2VyQ2FzZSgpIDogJ2dldCcpO1xufTtcblxuY29uc3QgZ2V0UXVlcnlTdHJpbmdNYXRjaGVyID0gKHsgcXVlcnk6IGV4cGVjdGVkUXVlcnkgfSkgPT4ge1xuXHRjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZXhwZWN0ZWRRdWVyeSk7XG5cdHJldHVybiB1cmwgPT4ge1xuXHRcdGNvbnN0IHF1ZXJ5ID0gcXVlcnlzdHJpbmcucGFyc2UoZ2V0UXVlcnkodXJsKSk7XG5cdFx0cmV0dXJuIGtleXMuZXZlcnkoa2V5ID0+IHF1ZXJ5W2tleV0gPT09IGV4cGVjdGVkUXVlcnlba2V5XSk7XG5cdH07XG59O1xuXG5jb25zdCBnZXRQYXJhbXNNYXRjaGVyID0gKHsgcGFyYW1zOiBleHBlY3RlZFBhcmFtcywgbWF0Y2hlciB9KSA9PiB7XG5cdGlmICghL2V4cHJlc3M6Ly50ZXN0KG1hdGNoZXIpKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0J2ZldGNoLW1vY2s6IG1hdGNoaW5nIG9uIHBhcmFtcyBpcyBvbmx5IHBvc3NpYmxlIHdoZW4gdXNpbmcgYW4gZXhwcmVzczogbWF0Y2hlcidcblx0XHQpO1xuXHR9XG5cdGNvbnN0IGV4cGVjdGVkS2V5cyA9IE9iamVjdC5rZXlzKGV4cGVjdGVkUGFyYW1zKTtcblx0Y29uc3Qga2V5cyA9IFtdO1xuXHRjb25zdCByZSA9IHBhdGhUb1JlZ2V4cChtYXRjaGVyLnJlcGxhY2UoL15leHByZXNzOi8sICcnKSwga2V5cyk7XG5cdHJldHVybiB1cmwgPT4ge1xuXHRcdGNvbnN0IHZhbHMgPSByZS5leGVjKGdldFBhdGgodXJsKSkgfHwgW107XG5cdFx0dmFscy5zaGlmdCgpO1xuXHRcdGNvbnN0IHBhcmFtcyA9IGtleXMucmVkdWNlKFxuXHRcdFx0KG1hcCwgeyBuYW1lIH0sIGkpID0+XG5cdFx0XHRcdHZhbHNbaV0gPyBPYmplY3QuYXNzaWduKG1hcCwgeyBbbmFtZV06IHZhbHNbaV0gfSkgOiBtYXAsXG5cdFx0XHR7fVxuXHRcdCk7XG5cdFx0cmV0dXJuIGV4cGVjdGVkS2V5cy5ldmVyeShrZXkgPT4gcGFyYW1zW2tleV0gPT09IGV4cGVjdGVkUGFyYW1zW2tleV0pO1xuXHR9O1xufTtcblxuY29uc3QgZ2V0RnVuY3Rpb25NYXRjaGVyID0gKHsgbWF0Y2hlciwgZnVuY3Rpb25NYXRjaGVyID0gKCkgPT4gdHJ1ZSB9KSA9PlxuXHR0eXBlb2YgbWF0Y2hlciA9PT0gJ2Z1bmN0aW9uJyA/IG1hdGNoZXIgOiBmdW5jdGlvbk1hdGNoZXI7XG5cbmNvbnN0IGdldFVybE1hdGNoZXIgPSByb3V0ZSA9PiB7XG5cdGNvbnN0IHsgbWF0Y2hlciwgcXVlcnkgfSA9IHJvdXRlO1xuXG5cdGlmICh0eXBlb2YgbWF0Y2hlciA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdHJldHVybiAoKSA9PiB0cnVlO1xuXHR9XG5cblx0aWYgKG1hdGNoZXIgaW5zdGFuY2VvZiBSZWdFeHApIHtcblx0XHRyZXR1cm4gdXJsID0+IG1hdGNoZXIudGVzdCh1cmwpO1xuXHR9XG5cblx0aWYgKG1hdGNoZXIgPT09ICcqJykge1xuXHRcdHJldHVybiAoKSA9PiB0cnVlO1xuXHR9XG5cblx0Zm9yIChjb25zdCBzaG9ydGhhbmQgaW4gc3RyaW5nTWF0Y2hlcnMpIHtcblx0XHRpZiAobWF0Y2hlci5pbmRleE9mKHNob3J0aGFuZCArICc6JykgPT09IDApIHtcblx0XHRcdGNvbnN0IHVybCA9IG1hdGNoZXIucmVwbGFjZShuZXcgUmVnRXhwKGBeJHtzaG9ydGhhbmR9OmApLCAnJyk7XG5cdFx0XHRyZXR1cm4gc3RyaW5nTWF0Y2hlcnNbc2hvcnRoYW5kXSh1cmwpO1xuXHRcdH1cblx0fVxuXG5cdC8vIGlmIG5vbmUgb2YgdGhlIHNwZWNpYWwgc3ludGF4ZXMgYXBwbHksIGl0J3MganVzdCBhIHNpbXBsZSBzdHJpbmcgbWF0Y2hcblx0Ly8gYnV0IHdlIGhhdmUgdG8gYmUgY2FyZWZ1bCB0byBub3JtYWxpemUgdGhlIHVybCB3ZSBjaGVjayBhbmQgdGhlIG5hbWVcblx0Ly8gb2YgdGhlIHJvdXRlIHRvIGFsbG93IGZvciBlLmcuIGh0dHA6Ly9pdC5hdC50aGVyZSBiZWluZyBpbmRpc3Rpbmd1aXNoYWJsZVxuXHQvLyBmcm9tIGh0dHA6Ly9pdC5hdC50aGVyZS8gb25jZSB3ZSBzdGFydCBnZW5lcmF0aW5nIFJlcXVlc3QvVXJsIG9iamVjdHNcblx0Y29uc3QgZXhwZWN0ZWRVcmwgPSBub3JtYWxpemVVcmwobWF0Y2hlcik7XG5cdGlmIChyb3V0ZS5pZGVudGlmaWVyID09PSBtYXRjaGVyKSB7XG5cdFx0cm91dGUuaWRlbnRpZmllciA9IGV4cGVjdGVkVXJsO1xuXHR9XG5cblx0cmV0dXJuIHVybCA9PiB7XG5cdFx0aWYgKHF1ZXJ5ICYmIGV4cGVjdGVkVXJsLmluZGV4T2YoJz8nKSkge1xuXHRcdFx0cmV0dXJuIHVybC5pbmRleE9mKGV4cGVjdGVkVXJsKSA9PT0gMDtcblx0XHR9XG5cdFx0cmV0dXJuIG5vcm1hbGl6ZVVybCh1cmwpID09PSBleHBlY3RlZFVybDtcblx0fTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gcm91dGUgPT4ge1xuXHRjb25zdCBtYXRjaGVycyA9IFtcblx0XHRyb3V0ZS5xdWVyeSAmJiBnZXRRdWVyeVN0cmluZ01hdGNoZXIocm91dGUpLFxuXHRcdHJvdXRlLm1ldGhvZCAmJiBnZXRNZXRob2RNYXRjaGVyKHJvdXRlKSxcblx0XHRyb3V0ZS5oZWFkZXJzICYmIGdldEhlYWRlck1hdGNoZXIocm91dGUpLFxuXHRcdHJvdXRlLnBhcmFtcyAmJiBnZXRQYXJhbXNNYXRjaGVyKHJvdXRlKSxcblx0XHRnZXRGdW5jdGlvbk1hdGNoZXIocm91dGUpLFxuXHRcdGdldFVybE1hdGNoZXIocm91dGUpXG5cdF0uZmlsdGVyKG1hdGNoZXIgPT4gISFtYXRjaGVyKTtcblxuXHRyZXR1cm4gKHVybCwgb3B0aW9ucyA9IHt9LCByZXF1ZXN0KSA9PlxuXHRcdG1hdGNoZXJzLmV2ZXJ5KG1hdGNoZXIgPT4gbWF0Y2hlcih1cmwsIG9wdGlvbnMsIHJlcXVlc3QpKTtcbn07XG4iXX0=