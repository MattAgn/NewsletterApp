15a7080d3d0c754e5fc6b3c3c111e460
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var invariant = require('invariant');

function elementsThatOverlapOffsets(offsets, itemCount, getFrameMetrics) {
  var out = [];
  var outLength = 0;

  for (var ii = 0; ii < itemCount; ii++) {
    var frame = getFrameMetrics(ii);
    var trailingOffset = frame.offset + frame.length;

    for (var kk = 0; kk < offsets.length; kk++) {
      if (out[kk] == null && trailingOffset >= offsets[kk]) {
        out[kk] = ii;
        outLength++;

        if (kk === offsets.length - 1) {
          invariant(outLength === offsets.length, 'bad offsets input, should be in increasing order: %s', JSON.stringify(offsets));
          return out;
        }
      }
    }
  }

  return out;
}

function newRangeCount(prev, next) {
  return next.last - next.first + 1 - Math.max(0, 1 + Math.min(next.last, prev.last) - Math.max(next.first, prev.first));
}

function computeWindowedRenderLimits(props, prev, getFrameMetricsApprox, scrollMetrics) {
  var data = props.data,
      getItemCount = props.getItemCount,
      maxToRenderPerBatch = props.maxToRenderPerBatch,
      windowSize = props.windowSize;
  var itemCount = getItemCount(data);

  if (itemCount === 0) {
    return prev;
  }

  var offset = scrollMetrics.offset,
      velocity = scrollMetrics.velocity,
      visibleLength = scrollMetrics.visibleLength;
  var visibleBegin = Math.max(0, offset);
  var visibleEnd = visibleBegin + visibleLength;
  var overscanLength = (windowSize - 1) * visibleLength;
  var leadFactor = 0.5;
  var fillPreference = velocity > 1 ? 'after' : velocity < -1 ? 'before' : 'none';
  var overscanBegin = Math.max(0, visibleBegin - (1 - leadFactor) * overscanLength);
  var overscanEnd = Math.max(0, visibleEnd + leadFactor * overscanLength);
  var lastItemOffset = getFrameMetricsApprox(itemCount - 1).offset;

  if (lastItemOffset < overscanBegin) {
    return {
      first: Math.max(0, itemCount - 1 - maxToRenderPerBatch),
      last: itemCount - 1
    };
  }

  var _elementsThatOverlapO = elementsThatOverlapOffsets([overscanBegin, visibleBegin, visibleEnd, overscanEnd], props.getItemCount(props.data), getFrameMetricsApprox),
      _elementsThatOverlapO2 = (0, _slicedToArray2.default)(_elementsThatOverlapO, 4),
      overscanFirst = _elementsThatOverlapO2[0],
      first = _elementsThatOverlapO2[1],
      last = _elementsThatOverlapO2[2],
      overscanLast = _elementsThatOverlapO2[3];

  overscanFirst = overscanFirst == null ? 0 : overscanFirst;
  first = first == null ? Math.max(0, overscanFirst) : first;
  overscanLast = overscanLast == null ? itemCount - 1 : overscanLast;
  last = last == null ? Math.min(overscanLast, first + maxToRenderPerBatch - 1) : last;
  var visible = {
    first: first,
    last: last
  };
  var newCellCount = newRangeCount(prev, visible);

  while (true) {
    if (first <= overscanFirst && last >= overscanLast) {
      break;
    }

    var maxNewCells = newCellCount >= maxToRenderPerBatch;
    var firstWillAddMore = first <= prev.first || first > prev.last;
    var firstShouldIncrement = first > overscanFirst && (!maxNewCells || !firstWillAddMore);
    var lastWillAddMore = last >= prev.last || last < prev.first;
    var lastShouldIncrement = last < overscanLast && (!maxNewCells || !lastWillAddMore);

    if (maxNewCells && !firstShouldIncrement && !lastShouldIncrement) {
      break;
    }

    if (firstShouldIncrement && !(fillPreference === 'after' && lastShouldIncrement && lastWillAddMore)) {
      if (firstWillAddMore) {
        newCellCount++;
      }

      first--;
    }

    if (lastShouldIncrement && !(fillPreference === 'before' && firstShouldIncrement && firstWillAddMore)) {
      if (lastWillAddMore) {
        newCellCount++;
      }

      last++;
    }
  }

  if (!(last >= first && first >= 0 && last < itemCount && first >= overscanFirst && last <= overscanLast && first <= visible.first && last >= visible.last)) {
    throw new Error('Bad window calculation ' + JSON.stringify({
      first: first,
      last: last,
      itemCount: itemCount,
      overscanFirst: overscanFirst,
      overscanLast: overscanLast,
      visible: visible
    }));
  }

  return {
    first: first,
    last: last
  };
}

var VirtualizeUtils = {
  computeWindowedRenderLimits: computeWindowedRenderLimits,
  elementsThatOverlapOffsets: elementsThatOverlapOffsets,
  newRangeCount: newRangeCount
};
module.exports = VirtualizeUtils;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlZpcnR1YWxpemVVdGlscy5qcyJdLCJuYW1lcyI6WyJpbnZhcmlhbnQiLCJyZXF1aXJlIiwiZWxlbWVudHNUaGF0T3ZlcmxhcE9mZnNldHMiLCJvZmZzZXRzIiwiaXRlbUNvdW50IiwiZ2V0RnJhbWVNZXRyaWNzIiwib3V0Iiwib3V0TGVuZ3RoIiwiaWkiLCJmcmFtZSIsInRyYWlsaW5nT2Zmc2V0Iiwib2Zmc2V0IiwibGVuZ3RoIiwia2siLCJKU09OIiwic3RyaW5naWZ5IiwibmV3UmFuZ2VDb3VudCIsInByZXYiLCJuZXh0IiwibGFzdCIsImZpcnN0IiwiTWF0aCIsIm1heCIsIm1pbiIsImNvbXB1dGVXaW5kb3dlZFJlbmRlckxpbWl0cyIsInByb3BzIiwiZ2V0RnJhbWVNZXRyaWNzQXBwcm94Iiwic2Nyb2xsTWV0cmljcyIsImRhdGEiLCJnZXRJdGVtQ291bnQiLCJtYXhUb1JlbmRlclBlckJhdGNoIiwid2luZG93U2l6ZSIsInZlbG9jaXR5IiwidmlzaWJsZUxlbmd0aCIsInZpc2libGVCZWdpbiIsInZpc2libGVFbmQiLCJvdmVyc2Nhbkxlbmd0aCIsImxlYWRGYWN0b3IiLCJmaWxsUHJlZmVyZW5jZSIsIm92ZXJzY2FuQmVnaW4iLCJvdmVyc2NhbkVuZCIsImxhc3RJdGVtT2Zmc2V0Iiwib3ZlcnNjYW5GaXJzdCIsIm92ZXJzY2FuTGFzdCIsInZpc2libGUiLCJuZXdDZWxsQ291bnQiLCJtYXhOZXdDZWxscyIsImZpcnN0V2lsbEFkZE1vcmUiLCJmaXJzdFNob3VsZEluY3JlbWVudCIsImxhc3RXaWxsQWRkTW9yZSIsImxhc3RTaG91bGRJbmNyZW1lbnQiLCJFcnJvciIsIlZpcnR1YWxpemVVdGlscyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOzs7Ozs7QUFFQSxJQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQU9BLFNBQVNDLDBCQUFULENBQ0VDLE9BREYsRUFFRUMsU0FGRixFQUdFQyxlQUhGLEVB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LE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQkYsZUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbi8qKlxuICogVXNlZCB0byBmaW5kIHRoZSBpbmRpY2VzIG9mIHRoZSBmcmFtZXMgdGhhdCBvdmVybGFwIHRoZSBnaXZlbiBvZmZzZXRzLiBVc2VmdWwgZm9yIGZpbmRpbmcgdGhlXG4gKiBpdGVtcyB0aGF0IGJvdW5kIGRpZmZlcmVudCB3aW5kb3dzIG9mIGNvbnRlbnQsIHN1Y2ggYXMgdGhlIHZpc2libGUgYXJlYSBvciB0aGUgYnVmZmVyZWQgb3ZlcnNjYW5cbiAqIGFyZWEuXG4gKi9cbmZ1bmN0aW9uIGVsZW1lbnRzVGhhdE92ZXJsYXBPZmZzZXRzKFxuICBvZmZzZXRzOiBBcnJheTxudW1iZXI+LFxuICBpdGVtQ291bnQ6IG51bWJlcixcbiAgZ2V0RnJhbWVNZXRyaWNzOiAoaW5kZXg6IG51bWJlcikgPT4ge2xlbmd0aDogbnVtYmVyLCBvZmZzZXQ6IG51bWJlcn0sXG4pOiBBcnJheTxudW1iZXI+IHtcbiAgY29uc3Qgb3V0ID0gW107XG4gIGxldCBvdXRMZW5ndGggPSAwO1xuICBmb3IgKGxldCBpaSA9IDA7IGlpIDwgaXRlbUNvdW50OyBpaSsrKSB7XG4gICAgY29uc3QgZnJhbWUgPSBnZXRGcmFtZU1ldHJpY3MoaWkpO1xuICAgIGNvbnN0IHRyYWlsaW5nT2Zmc2V0ID0gZnJhbWUub2Zmc2V0ICsgZnJhbWUubGVuZ3RoO1xuICAgIGZvciAobGV0IGtrID0gMDsga2sgPCBvZmZzZXRzLmxlbmd0aDsga2srKykge1xuICAgICAgaWYgKG91dFtra10gPT0gbnVsbCAmJiB0cmFpbGluZ09mZnNldCA+PSBvZmZzZXRzW2trXSkge1xuICAgICAgICBvdXRba2tdID0gaWk7XG4gICAgICAgIG91dExlbmd0aCsrO1xuICAgICAgICBpZiAoa2sgPT09IG9mZnNldHMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIGludmFyaWFudChcbiAgICAgICAgICAgIG91dExlbmd0aCA9PT0gb2Zmc2V0cy5sZW5ndGgsXG4gICAgICAgICAgICAnYmFkIG9mZnNldHMgaW5wdXQsIHNob3VsZCBiZSBpbiBpbmNyZWFzaW5nIG9yZGVyOiAlcycsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShvZmZzZXRzKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIHJldHVybiBvdXQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuLyoqXG4gKiBDb21wdXRlcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBgbmV4dGAgcmFuZ2UgdGhhdCBhcmUgbmV3IGNvbXBhcmVkIHRvIHRoZSBgcHJldmAgcmFuZ2UuXG4gKiBIYW5keSBmb3IgY2FsY3VsYXRpbmcgaG93IG1hbnkgbmV3IGl0ZW1zIHdpbGwgYmUgcmVuZGVyZWQgd2hlbiB0aGUgcmVuZGVyIHdpbmRvdyBjaGFuZ2VzIHNvIHdlXG4gKiBjYW4gcmVzdHJpY3QgdGhlIG51bWJlciBvZiBuZXcgaXRlbXMgcmVuZGVyIGF0IG9uY2Ugc28gdGhhdCBjb250ZW50IGNhbiBhcHBlYXIgb24gdGhlIHNjcmVlblxuICogZmFzdGVyLlxuICovXG5mdW5jdGlvbiBuZXdSYW5nZUNvdW50KFxuICBwcmV2OiB7Zmlyc3Q6IG51bWJlciwgbGFzdDogbnVtYmVyfSxcbiAgbmV4dDoge2ZpcnN0OiBudW1iZXIsIGxhc3Q6IG51bWJlcn0sXG4pOiBudW1iZXIge1xuICByZXR1cm4gKFxuICAgIG5leHQubGFzdCAtXG4gICAgbmV4dC5maXJzdCArXG4gICAgMSAtXG4gICAgTWF0aC5tYXgoXG4gICAgICAwLFxuICAgICAgMSArIE1hdGgubWluKG5leHQubGFzdCwgcHJldi5sYXN0KSAtIE1hdGgubWF4KG5leHQuZmlyc3QsIHByZXYuZmlyc3QpLFxuICAgIClcbiAgKTtcbn1cblxuLyoqXG4gKiBDdXN0b20gbG9naWMgZm9yIGRldGVybWluaW5nIHdoaWNoIGl0ZW1zIHNob3VsZCBiZSByZW5kZXJlZCBnaXZlbiB0aGUgY3VycmVudCBmcmFtZSBhbmQgc2Nyb2xsXG4gKiBtZXRyaWNzLCBhcyB3ZWxsIGFzIHRoZSBwcmV2aW91cyByZW5kZXIgc3RhdGUuIFRoZSBhbGdvcml0aG0gbWF5IGV2b2x2ZSBvdmVyIHRpbWUsIGJ1dCBnZW5lcmFsbHlcbiAqIHByaW9yaXRpemVzIHRoZSB2aXNpYmxlIGFyZWEgZmlyc3QsIHRoZW4gZXhwYW5kcyB0aGF0IHdpdGggb3ZlcnNjYW4gcmVnaW9ucyBhaGVhZCBhbmQgYmVoaW5kLFxuICogYmlhc2VkIGluIHRoZSBkaXJlY3Rpb24gb2Ygc2Nyb2xsLlxuICovXG5mdW5jdGlvbiBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHMoXG4gIHByb3BzOiB7XG4gICAgZGF0YTogYW55LFxuICAgIGdldEl0ZW1Db3VudDogKGRhdGE6IGFueSkgPT4gbnVtYmVyLFxuICAgIG1heFRvUmVuZGVyUGVyQmF0Y2g6IG51bWJlcixcbiAgICB3aW5kb3dTaXplOiBudW1iZXIsXG4gIH0sXG4gIHByZXY6IHtmaXJzdDogbnVtYmVyLCBsYXN0OiBudW1iZXJ9LFxuICBnZXRGcmFtZU1ldHJpY3NBcHByb3g6IChpbmRleDogbnVtYmVyKSA9PiB7bGVuZ3RoOiBudW1iZXIsIG9mZnNldDogbnVtYmVyfSxcbiAgc2Nyb2xsTWV0cmljczoge1xuICAgIGR0OiBudW1iZXIsXG4gICAgb2Zmc2V0OiBudW1iZXIsXG4gICAgdmVsb2NpdHk6IG51bWJlcixcbiAgICB2aXNpYmxlTGVuZ3RoOiBudW1iZXIsXG4gIH0sXG4pOiB7Zmlyc3Q6IG51bWJlciwgbGFzdDogbnVtYmVyfSB7XG4gIGNvbnN0IHtkYXRhLCBnZXRJdGVtQ291bnQsIG1heFRvUmVuZGVyUGVyQmF0Y2gsIHdpbmRvd1NpemV9ID0gcHJvcHM7XG4gIGNvbnN0IGl0ZW1Db3VudCA9IGdldEl0ZW1Db3VudChkYXRhKTtcbiAgaWYgKGl0ZW1Db3VudCA9PT0gMCkge1xuICAgIHJldHVybiBwcmV2O1xuICB9XG4gIGNvbnN0IHtvZmZzZXQsIHZlbG9jaXR5LCB2aXNpYmxlTGVuZ3RofSA9IHNjcm9sbE1ldHJpY3M7XG5cbiAgLy8gU3RhcnQgd2l0aCB2aXNpYmxlIGFyZWEsIHRoZW4gY29tcHV0ZSBtYXhpbXVtIG92ZXJzY2FuIHJlZ2lvbiBieSBleHBhbmRpbmcgZnJvbSB0aGVyZSwgYmlhc2VkXG4gIC8vIGluIHRoZSBkaXJlY3Rpb24gb2Ygc2Nyb2xsLiBUb3RhbCBvdmVyc2NhbiBhcmVhIGlzIGNhcHBlZCwgd2hpY2ggc2hvdWxkIGNhcCBtZW1vcnkgY29uc3VtcHRpb25cbiAgLy8gdG9vLlxuICBjb25zdCB2aXNpYmxlQmVnaW4gPSBNYXRoLm1heCgwLCBvZmZzZXQpO1xuICBjb25zdCB2aXNpYmxlRW5kID0gdmlzaWJsZUJlZ2luICsgdmlzaWJsZUxlbmd0aDtcbiAgY29uc3Qgb3ZlcnNjYW5MZW5ndGggPSAod2luZG93U2l6ZSAtIDEpICogdmlzaWJsZUxlbmd0aDtcblxuICAvLyBDb25zaWRlcmluZyB2ZWxvY2l0eSBzZWVtcyB0byBpbnRyb2R1Y2UgbW9yZSBjaHVybiB0aGFuIGl0J3Mgd29ydGguXG4gIGNvbnN0IGxlYWRGYWN0b3IgPSAwLjU7IC8vIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZlbG9jaXR5IC8gMjUgKyAwLjUpKTtcblxuICBjb25zdCBmaWxsUHJlZmVyZW5jZSA9XG4gICAgdmVsb2NpdHkgPiAxID8gJ2FmdGVyJyA6IHZlbG9jaXR5IDwgLTEgPyAnYmVmb3JlJyA6ICdub25lJztcblxuICBjb25zdCBvdmVyc2NhbkJlZ2luID0gTWF0aC5tYXgoXG4gICAgMCxcbiAgICB2aXNpYmxlQmVnaW4gLSAoMSAtIGxlYWRGYWN0b3IpICogb3ZlcnNjYW5MZW5ndGgsXG4gICk7XG4gIGNvbnN0IG92ZXJzY2FuRW5kID0gTWF0aC5tYXgoMCwgdmlzaWJsZUVuZCArIGxlYWRGYWN0b3IgKiBvdmVyc2Nhbkxlbmd0aCk7XG5cbiAgY29uc3QgbGFzdEl0ZW1PZmZzZXQgPSBnZXRGcmFtZU1ldHJpY3NBcHByb3goaXRlbUNvdW50IC0gMSkub2Zmc2V0O1xuICBpZiAobGFzdEl0ZW1PZmZzZXQgPCBvdmVyc2NhbkJlZ2luKSB7XG4gICAgLy8gRW50aXJlIGxpc3QgaXMgYmVmb3JlIG91ciBvdmVyc2NhbiB3aW5kb3dcbiAgICByZXR1cm4ge1xuICAgICAgZmlyc3Q6IE1hdGgubWF4KDAsIGl0ZW1Db3VudCAtIDEgLSBtYXhUb1JlbmRlclBlckJhdGNoKSxcbiAgICAgIGxhc3Q6IGl0ZW1Db3VudCAtIDEsXG4gICAgfTtcbiAgfVxuXG4gIC8vIEZpbmQgdGhlIGluZGljZXMgdGhhdCBjb3JyZXNwb25kIHRvIHRoZSBpdGVtcyBhdCB0aGUgcmVuZGVyIGJvdW5kYXJpZXMgd2UncmUgdGFyZ2V0aW5nLlxuICBsZXQgW292ZXJzY2FuRmlyc3QsIGZpcnN0LCBsYXN0LCBvdmVyc2Nhbkxhc3RdID0gZWxlbWVudHNUaGF0T3ZlcmxhcE9mZnNldHMoXG4gICAgW292ZXJzY2FuQmVnaW4sIHZpc2libGVCZWdpbiwgdmlzaWJsZUVuZCwgb3ZlcnNjYW5FbmRdLFxuICAgIHByb3BzLmdldEl0ZW1Db3VudChwcm9wcy5kYXRhKSxcbiAgICBnZXRGcmFtZU1ldHJpY3NBcHByb3gsXG4gICk7XG4gIG92ZXJzY2FuRmlyc3QgPSBvdmVyc2NhbkZpcnN0ID09IG51bGwgPyAwIDogb3ZlcnNjYW5GaXJzdDtcbiAgZmlyc3QgPSBmaXJzdCA9PSBudWxsID8gTWF0aC5tYXgoMCwgb3ZlcnNjYW5GaXJzdCkgOiBmaXJzdDtcbiAgb3ZlcnNjYW5MYXN0ID0gb3ZlcnNjYW5MYXN0ID09IG51bGwgPyBpdGVtQ291bnQgLSAxIDogb3ZlcnNjYW5MYXN0O1xuICBsYXN0ID1cbiAgICBsYXN0ID09IG51bGxcbiAgICAgID8gTWF0aC5taW4ob3ZlcnNjYW5MYXN0LCBmaXJzdCArIG1heFRvUmVuZGVyUGVyQmF0Y2ggLSAxKVxuICAgICAgOiBsYXN0O1xuICBjb25zdCB2aXNpYmxlID0ge2ZpcnN0LCBsYXN0fTtcblxuICAvLyBXZSB3YW50IHRvIGxpbWl0IHRoZSBudW1iZXIgb2YgbmV3IGNlbGxzIHdlJ3JlIHJlbmRlcmluZyBwZXIgYmF0Y2ggc28gdGhhdCB3ZSBjYW4gZmlsbCB0aGVcbiAgLy8gY29udGVudCBvbiB0aGUgc2NyZWVuIHF1aWNrbHkuIElmIHdlIHJlbmRlcmVkIHRoZSBlbnRpcmUgb3ZlcnNjYW4gd2luZG93IGF0IG9uY2UsIHRoZSB1c2VyXG4gIC8vIGNvdWxkIGJlIHN0YXJpbmcgYXQgd2hpdGUgc3BhY2UgZm9yIGEgbG9uZyB0aW1lIHdhaXRpbmcgZm9yIGEgYnVuY2ggb2Ygb2Zmc2NyZWVuIGNvbnRlbnQgdG9cbiAgLy8gcmVuZGVyLlxuICBsZXQgbmV3Q2VsbENvdW50ID0gbmV3UmFuZ2VDb3VudChwcmV2LCB2aXNpYmxlKTtcblxuICB3aGlsZSAodHJ1ZSkge1xuICAgIGlmIChmaXJzdCA8PSBvdmVyc2NhbkZpcnN0ICYmIGxhc3QgPj0gb3ZlcnNjYW5MYXN0KSB7XG4gICAgICAvLyBJZiB3ZSBmaWxsIHRoZSBlbnRpcmUgb3ZlcnNjYW4gcmFuZ2UsIHdlJ3JlIGRvbmUuXG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY29uc3QgbWF4TmV3Q2VsbHMgPSBuZXdDZWxsQ291bnQgPj0gbWF4VG9SZW5kZXJQZXJCYXRjaDtcbiAgICBjb25zdCBmaXJzdFdpbGxBZGRNb3JlID0gZmlyc3QgPD0gcHJldi5maXJzdCB8fCBmaXJzdCA+IHByZXYubGFzdDtcbiAgICBjb25zdCBmaXJzdFNob3VsZEluY3JlbWVudCA9XG4gICAgICBmaXJzdCA+IG92ZXJzY2FuRmlyc3QgJiYgKCFtYXhOZXdDZWxscyB8fCAhZmlyc3RXaWxsQWRkTW9yZSk7XG4gICAgY29uc3QgbGFzdFdpbGxBZGRNb3JlID0gbGFzdCA+PSBwcmV2Lmxhc3QgfHwgbGFzdCA8IHByZXYuZmlyc3Q7XG4gICAgY29uc3QgbGFzdFNob3VsZEluY3JlbWVudCA9XG4gICAgICBsYXN0IDwgb3ZlcnNjYW5MYXN0ICYmICghbWF4TmV3Q2VsbHMgfHwgIWxhc3RXaWxsQWRkTW9yZSk7XG4gICAgaWYgKG1heE5ld0NlbGxzICYmICFmaXJzdFNob3VsZEluY3JlbWVudCAmJiAhbGFzdFNob3VsZEluY3JlbWVudCkge1xuICAgICAgLy8gV2Ugb25seSB3YW50IHRvIHN0b3AgaWYgd2UndmUgaGl0IG1heE5ld0NlbGxzIEFORCB3ZSBjYW5ub3QgaW5jcmVtZW50IGZpcnN0IG9yIGxhc3RcbiAgICAgIC8vIHdpdGhvdXQgcmVuZGVyaW5nIG5ldyBpdGVtcy4gVGhpcyBsZXQncyB1cyBwcmVzZXJ2ZSBhcyBtYW55IGFscmVhZHkgcmVuZGVyZWQgaXRlbXMgYXNcbiAgICAgIC8vIHBvc3NpYmxlLCByZWR1Y2luZyByZW5kZXIgY2h1cm4gYW5kIGtlZXBpbmcgdGhlIHJlbmRlcmVkIG92ZXJzY2FuIHJhbmdlIGFzIGxhcmdlIGFzXG4gICAgICAvLyBwb3NzaWJsZS5cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBmaXJzdFNob3VsZEluY3JlbWVudCAmJlxuICAgICAgIShmaWxsUHJlZmVyZW5jZSA9PT0gJ2FmdGVyJyAmJiBsYXN0U2hvdWxkSW5jcmVtZW50ICYmIGxhc3RXaWxsQWRkTW9yZSlcbiAgICApIHtcbiAgICAgIGlmIChmaXJzdFdpbGxBZGRNb3JlKSB7XG4gICAgICAgIG5ld0NlbGxDb3VudCsrO1xuICAgICAgfVxuICAgICAgZmlyc3QtLTtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgbGFzdFNob3VsZEluY3JlbWVudCAmJlxuICAgICAgIShmaWxsUHJlZmVyZW5jZSA9PT0gJ2JlZm9yZScgJiYgZmlyc3RTaG91bGRJbmNyZW1lbnQgJiYgZmlyc3RXaWxsQWRkTW9yZSlcbiAgICApIHtcbiAgICAgIGlmIChsYXN0V2lsbEFkZE1vcmUpIHtcbiAgICAgICAgbmV3Q2VsbENvdW50Kys7XG4gICAgICB9XG4gICAgICBsYXN0Kys7XG4gICAgfVxuICB9XG4gIGlmIChcbiAgICAhKFxuICAgICAgbGFzdCA+PSBmaXJzdCAmJlxuICAgICAgZmlyc3QgPj0gMCAmJlxuICAgICAgbGFzdCA8IGl0ZW1Db3VudCAmJlxuICAgICAgZmlyc3QgPj0gb3ZlcnNjYW5GaXJzdCAmJlxuICAgICAgbGFzdCA8PSBvdmVyc2Nhbkxhc3QgJiZcbiAgICAgIGZpcnN0IDw9IHZpc2libGUuZmlyc3QgJiZcbiAgICAgIGxhc3QgPj0gdmlzaWJsZS5sYXN0XG4gICAgKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnQmFkIHdpbmRvdyBjYWxjdWxhdGlvbiAnICtcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGZpcnN0LFxuICAgICAgICAgIGxhc3QsXG4gICAgICAgICAgaXRlbUNvdW50LFxuICAgICAgICAgIG92ZXJzY2FuRmlyc3QsXG4gICAgICAgICAgb3ZlcnNjYW5MYXN0LFxuICAgICAgICAgIHZpc2libGUsXG4gICAgICAgIH0pLFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIHtmaXJzdCwgbGFzdH07XG59XG5cbmNvbnN0IFZpcnR1YWxpemVVdGlscyA9IHtcbiAgY29tcHV0ZVdpbmRvd2VkUmVuZGVyTGltaXRzLFxuICBlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cyxcbiAgbmV3UmFuZ2VDb3VudCxcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gVmlydHVhbGl6ZVV0aWxzO1xuIl19