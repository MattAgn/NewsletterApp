5185d6a6586f10fb346a6e847b74329a
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _require = require("./infra"),
    isASCIIHex = _require.isASCIIHex;

function strictlySplitByteSequence(buf, cp) {
  var list = [];
  var last = 0;
  var i = buf.indexOf(cp);

  while (i >= 0) {
    list.push(buf.slice(last, i));
    last = i + 1;
    i = buf.indexOf(cp, last);
  }

  if (last !== buf.length) {
    list.push(buf.slice(last));
  }

  return list;
}

function replaceByteInByteSequence(buf, from, to) {
  var i = buf.indexOf(from);

  while (i >= 0) {
    buf[i] = to;
    i = buf.indexOf(from, i + 1);
  }

  return buf;
}

function percentEncode(c) {
  var hex = c.toString(16).toUpperCase();

  if (hex.length === 1) {
    hex = "0" + hex;
  }

  return "%" + hex;
}

function percentDecode(input) {
  var output = Buffer.alloc(input.byteLength);
  var ptr = 0;

  for (var i = 0; i < input.length; ++i) {
    if (input[i] !== 37 || !isASCIIHex(input[i + 1]) || !isASCIIHex(input[i + 2])) {
      output[ptr++] = input[i];
    } else {
      output[ptr++] = parseInt(input.slice(i + 1, i + 3).toString(), 16);
      i += 2;
    }
  }

  return output.slice(0, ptr);
}

function _parseUrlencoded(input) {
  var sequences = strictlySplitByteSequence(input, 38);
  var output = [];

  for (var _iterator = sequences, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[typeof Symbol === "function" ? Symbol.iterator : "@@iterator"]();;) {
    var _ref;

    if (_isArray) {
      if (_i >= _iterator.length) break;
      _ref = _iterator[_i++];
    } else {
      _i = _iterator.next();
      if (_i.done) break;
      _ref = _i.value;
    }

    var _bytes = _ref;

    if (_bytes.length === 0) {
      continue;
    }

    var name = void 0;
    var value = void 0;

    var indexOfEqual = _bytes.indexOf(61);

    if (indexOfEqual >= 0) {
      name = _bytes.slice(0, indexOfEqual);
      value = _bytes.slice(indexOfEqual + 1);
    } else {
      name = _bytes;
      value = Buffer.alloc(0);
    }

    name = replaceByteInByteSequence(Buffer.from(name), 43, 32);
    value = replaceByteInByteSequence(Buffer.from(value), 43, 32);
    output.push([percentDecode(name).toString(), percentDecode(value).toString()]);
  }

  return output;
}

function serializeUrlencodedByte(input) {
  var output = "";

  for (var _iterator2 = input, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[typeof Symbol === "function" ? Symbol.iterator : "@@iterator"]();;) {
    var _ref2;

    if (_isArray2) {
      if (_i2 >= _iterator2.length) break;
      _ref2 = _iterator2[_i2++];
    } else {
      _i2 = _iterator2.next();
      if (_i2.done) break;
      _ref2 = _i2.value;
    }

    var _byte = _ref2;

    if (_byte === 32) {
      output += "+";
    } else if (_byte === 42 || _byte === 45 || _byte === 46 || _byte >= 48 && _byte <= 57 || _byte >= 65 && _byte <= 90 || _byte === 95 || _byte >= 97 && _byte <= 122) {
      output += String.fromCodePoint(_byte);
    } else {
      output += percentEncode(_byte);
    }
  }

  return output;
}

function serializeUrlencoded(tuples) {
  var encodingOverride = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : undefined;
  var encoding = "utf-8";

  if (encodingOverride !== undefined) {
    encoding = encodingOverride;
  }

  var output = "";

  for (var _iterator3 = tuples.entries(), _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[typeof Symbol === "function" ? Symbol.iterator : "@@iterator"]();;) {
    var _ref5;

    if (_isArray3) {
      if (_i3 >= _iterator3.length) break;
      _ref5 = _iterator3[_i3++];
    } else {
      _i3 = _iterator3.next();
      if (_i3.done) break;
      _ref5 = _i3.value;
    }

    var _ref6 = _ref5;

    var _ref4 = (0, _slicedToArray2.default)(_ref6, 2);

    var _i4 = _ref4[0];
    var _tuple = _ref4[1];
    var name = serializeUrlencodedByte(Buffer.from(_tuple[0]));
    var value = _tuple[1];

    if (_tuple.length > 2 && _tuple[2] !== undefined) {
      if (_tuple[2] === "hidden" && name === "_charset_") {
        value = encoding;
      } else if (_tuple[2] === "file") {
        value = value.name;
      }
    }

    value = serializeUrlencodedByte(Buffer.from(value));

    if (_i4 !== 0) {
      output += "&";
    }

    output += name + "=" + value;
  }

  return output;
}

module.exports = {
  percentEncode: percentEncode,
  percentDecode: percentDecode,
  parseUrlencoded: function parseUrlencoded(input) {
    return _parseUrlencoded(Buffer.from(input));
  },
  serializeUrlencoded: serializeUrlencoded
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVybGVuY29kZWQuanMiXSwibmFtZXMiOlsicmVxdWlyZSIsImlzQVNDSUlIZXgiLCJzdHJpY3RseVNwbGl0Qnl0ZVNlcXVlbmNlIiwiYnVmIiwiY3AiLCJsaXN0IiwibGFzdCIsImkiLCJpbmRleE9mIiwicHVzaCIsInNsaWNlIiwibGVuZ3RoIiwicmVwbGFjZUJ5dGVJbkJ5dGVTZXF1ZW5jZSIsImZyb20iLCJ0byIsInBlcmNlbnRFbmNvZGUiLCJjIiwiaGV4IiwidG9TdHJpbmciLCJ0b1VwcGVyQ2FzZSIsInBlcmNlbnREZWNvZGUiLCJpbnB1dCIsIm91dHB1dCIsIkJ1ZmZlciIsImFsbG9jIiwiYnl0ZUxlbmd0aCIsInB0ciIsInBhcnNlSW50IiwicGFyc2VVcmxlbmNvZGVkIiwic2VxdWVuY2VzIiwiYnl0ZXMiLCJuYW1lIiwidmFsdWUiLCJpbmRleE9mRXF1YWwiLCJzZXJpYWxpemVVcmxlbmNvZGVkQnl0ZSIsImJ5dGUiLCJTdHJpbmciLCJmcm9tQ29kZVBvaW50Iiwic2VyaWFsaXplVXJsZW5jb2RlZCIsInR1cGxlcyIsImVuY29kaW5nT3ZlcnJpZGUiLCJ1bmRlZmluZWQiLCJlbmNvZGluZyIsImVudHJpZXMiLCJ0dXBsZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7ZUFDdUJBLE9BQU8sQ0FBQyxTQUFELEM7SUFBdEJDLFUsWUFBQUEsVTs7QUFFUixTQUFTQyx5QkFBVCxDQUFtQ0MsR0FBbkMsRUFBd0NDLEVBQXhDLEVBQTRDO0FBQzFDLE1BQU1DLElBQUksR0FBRyxFQUFiO0FBQ0EsTUFBSUMsSUFBSSxHQUFHLENBQVg7QUFDQSxNQUFJQyxDQUFDLEdBQUdKLEdBQUcsQ0FBQ0ssT0FBSixDQUFZSixFQUFaLENBQVI7O0FBQ0EsU0FBT0csQ0FBQyxJQUFJLENBQVosRUFBZTtBQUNiRixJQUFBQSxJQUFJLENBQUNJLElBQUwsQ0FBVU4sR0FBRyxDQUFDTyxLQUFKLENBQVVKLElBQVYsRUFBZ0JDLENBQWhCLENBQVY7QUFDQUQsSUFBQUEsSUFBSSxHQUFHQyxDQUFDLEdBQUcsQ0FBWDtBQUNBQSxJQUFBQSxDQUFDLEdBQUdKLEdBQUcsQ0FBQ0ssT0FBSixDQUFZSixFQUFaLEVBQWdCRSxJQUFoQixDQUFKO0FBQ0Q7O0FBQ0QsTUFBSUEsSUFBSSxLQUFLSCxHQUFHLENBQUNRLE1BQWpCLEVBQXlCO0FBQ3ZCTixJQUFBQSxJQUFJLENBQUNJLElBQUwsQ0FBVU4sR0FBRyxDQUFDTyxLQUFKLENBQVVKLElBQVYsQ0FBVjtBQUNEOztBQUNELFNBQU9ELElBQVA7QUFDRDs7QUFFRCxTQUFTTyx5QkFBVCxDQUFtQ1QsR0FBbkMsRUFBd0NVLElBQXhDLEVBQThDQyxFQUE5QyxFQUFrRDtBQUNoRCxNQUFJUCxDQUFDLEdBQUdKLEdBQUcsQ0FBQ0ssT0FBSixDQUFZSyxJQUFaLENBQVI7O0FBQ0EsU0FBT04sQ0FBQyxJQUFJLENBQVosRUFBZTtBQUNiSixJQUFBQSxHQUFHLENBQUNJLENBQUQsQ0FBSCxHQUFTTyxFQUFUO0FBQ0FQLElBQUFBLENBQUMsR0FBR0osR0FBRyxDQUFDSyxPQUFKLENBQVlLLElBQVosRUFBa0JOLENBQUMsR0FBRyxDQUF0QixDQUFKO0FBQ0Q7O0FBQ0QsU0FBT0osR0FBUDtBQUNEOztBQUVELFNBQVNZLGFBQVQsQ0FBdUJDLENBQXZCLEVBQTBCO0FBQ3hCLE1BQUlDLEdBQUcsR0FBR0QsQ0FBQyxDQUFDRSxRQUFGLENBQVcsRUFBWCxFQUFlQyxXQUFmLEVBQVY7O0FBQ0EsTUFBSUYsR0FBRyxDQUFDTixNQUFKLEtBQWUsQ0FBbkIsRUFBc0I7QUFDcEJNLElBQUFBLEdBQUcsR0FBRyxNQUFNQSxHQUFaO0FBQ0Q7O0FBRUQsU0FBTyxNQUFNQSxHQUFiO0FBQ0Q7O0FBRUQsU0FBU0csYUFBVCxDQUF1QkMsS0FBdkIsRUFBOEI7QUFDNUIsTUFBTUMsTUFBTSxHQUFHQyxNQUFNLENBQUNDLEtBQVAsQ0FBYUgsS0FBSyxDQUFDSSxVQUFuQixDQUFmO0FBQ0EsTUFBSUMsR0FBRyxHQUFHLENBQVY7O0FBQ0EsT0FBSyxJQUFJbkIsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR2MsS0FBSyxDQUFDVixNQUExQixFQUFrQyxFQUFFSixDQUFwQyxFQUF1QztBQUNyQyxRQUFJYyxLQUFLLENBQUNkLENBQUQsQ0FBTCxLQUFhLEVBQWIsSUFBbUIsQ0FBQ04sVUFBVSxDQUFDb0IsS0FBSyxDQUFDZCxDQUFDLEdBQUcsQ0FBTCxDQUFOLENBQTlCLElBQWdELENBQUNOLFVBQVUsQ0FBQ29CLEtBQUssQ0FBQ2QsQ0FBQyxHQUFHLENBQUwsQ0FBTixDQUEvRCxFQUErRTtBQUM3RWUsTUFBQUEsTUFBTSxDQUFDSSxHQUFHLEVBQUosQ0FBTixHQUFnQkwsS0FBSyxDQUFDZCxDQUFELENBQXJCO0FBQ0QsS0FGRCxNQUVPO0FBQ0xlLE1BQUFBLE1BQU0sQ0FBQ0ksR0FBRyxFQUFKLENBQU4sR0FBZ0JDLFFBQVEsQ0FBQ04sS0FBSyxDQUFDWCxLQUFOLENBQVlILENBQUMsR0FBRyxDQUFoQixFQUFtQkEsQ0FBQyxHQUFHLENBQXZCLEVBQTBCVyxRQUExQixFQUFELEVBQXVDLEVBQXZDLENBQXhCO0FBQ0FYLE1BQUFBLENBQUMsSUFBSSxDQUFMO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPZSxNQUFNLENBQUNaLEtBQVAsQ0FBYSxDQUFiLEVBQWdCZ0IsR0FBaEIsQ0FBUDtBQUNEOztBQUVELFNBQVNFLGdCQUFULENBQXlCUCxLQUF6QixFQUFnQztBQUM5QixNQUFNUSxTQUFTLEdBQUczQix5QkFBeUIsQ0FBQ21CLEtBQUQsRUFBUSxFQUFSLENBQTNDO0FBQ0EsTUFBTUMsTUFBTSxHQUFHLEVBQWY7O0FBQ0EsdUJBQW9CTyxTQUFwQixnS0FBK0I7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOztBQUFBLFFBQXBCQyxNQUFvQjs7QUFDN0IsUUFBSUEsTUFBSyxDQUFDbkIsTUFBTixLQUFpQixDQUFyQixFQUF3QjtBQUN0QjtBQUNEOztBQUVELFFBQUlvQixJQUFJLFNBQVI7QUFDQSxRQUFJQyxLQUFLLFNBQVQ7O0FBQ0EsUUFBTUMsWUFBWSxHQUFHSCxNQUFLLENBQUN0QixPQUFOLENBQWMsRUFBZCxDQUFyQjs7QUFFQSxRQUFJeUIsWUFBWSxJQUFJLENBQXBCLEVBQXVCO0FBQ3JCRixNQUFBQSxJQUFJLEdBQUdELE1BQUssQ0FBQ3BCLEtBQU4sQ0FBWSxDQUFaLEVBQWV1QixZQUFmLENBQVA7QUFDQUQsTUFBQUEsS0FBSyxHQUFHRixNQUFLLENBQUNwQixLQUFOLENBQVl1QixZQUFZLEdBQUcsQ0FBM0IsQ0FBUjtBQUNELEtBSEQsTUFHTztBQUNMRixNQUFBQSxJQUFJLEdBQUdELE1BQVA7QUFDQUUsTUFBQUEsS0FBSyxHQUFHVCxNQUFNLENBQUNDLEtBQVAsQ0FBYSxDQUFiLENBQVI7QUFDRDs7QUFFRE8sSUFBQUEsSUFBSSxHQUFHbkIseUJBQXlCLENBQUNXLE1BQU0sQ0FBQ1YsSUFBUCxDQUFZa0IsSUFBWixDQUFELEVBQW9CLEVBQXBCLEVBQXdCLEVBQXhCLENBQWhDO0FBQ0FDLElBQUFBLEtBQUssR0FBR3BCLHlCQUF5QixDQUFDVyxNQUFNLENBQUNWLElBQVAsQ0FBWW1CLEtBQVosQ0FBRCxFQUFxQixFQUFyQixFQUF5QixFQUF6QixDQUFqQztBQUVBVixJQUFBQSxNQUFNLENBQUNiLElBQVAsQ0FBWSxDQUFDVyxhQUFhLENBQUNXLElBQUQsQ0FBYixDQUFvQmIsUUFBcEIsRUFBRCxFQUFpQ0UsYUFBYSxDQUFDWSxLQUFELENBQWIsQ0FBcUJkLFFBQXJCLEVBQWpDLENBQVo7QUFDRDs7QUFDRCxTQUFPSSxNQUFQO0FBQ0Q7O0FBRUQsU0FBU1ksdUJBQVQsQ0FBaUNiLEtBQWpDLEVBQXdDO0FBQ3RDLE1BQUlDLE1BQU0sR0FBRyxFQUFiOztBQUNBLHdCQUFtQkQsS0FBbkIsdUtBQTBCO0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFBQSxRQUFmYyxLQUFlOztBQUN4QixRQUFJQSxLQUFJLEtBQUssRUFBYixFQUFpQjtBQUNmYixNQUFBQSxNQUFNLElBQUksR0FBVjtBQUNELEtBRkQsTUFFTyxJQUFJYSxLQUFJLEtBQUssRUFBVCxJQUNBQSxLQUFJLEtBQUssRUFEVCxJQUVBQSxLQUFJLEtBQUssRUFGVCxJQUdDQSxLQUFJLElBQUksRUFBUixJQUFjQSxLQUFJLElBQUksRUFIdkIsSUFJQ0EsS0FBSSxJQUFJLEVBQVIsSUFBY0EsS0FBSSxJQUFJLEVBSnZCLElBS0FBLEtBQUksS0FBSyxFQUxULElBTUNBLEtBQUksSUFBSSxFQUFSLElBQWNBLEtBQUksSUFBSSxHQU4zQixFQU1pQztBQUN0Q2IsTUFBQUEsTUFBTSxJQUFJYyxNQUFNLENBQUNDLGFBQVAsQ0FBcUJGLEtBQXJCLENBQVY7QUFDRCxLQVJNLE1BUUE7QUFDTGIsTUFBQUEsTUFBTSxJQUFJUCxhQUFhLENBQUNvQixLQUFELENBQXZCO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPYixNQUFQO0FBQ0Q7O0FBRUQsU0FBU2dCLG1CQUFULENBQTZCQyxNQUE3QixFQUFtRTtBQUFBLE1BQTlCQyxnQkFBOEIsdUVBQVhDLFNBQVc7QUFDakUsTUFBSUMsUUFBUSxHQUFHLE9BQWY7O0FBQ0EsTUFBSUYsZ0JBQWdCLEtBQUtDLFNBQXpCLEVBQW9DO0FBQ2xDQyxJQUFBQSxRQUFRLEdBQUdGLGdCQUFYO0FBQ0Q7O0FBRUQsTUFBSWxCLE1BQU0sR0FBRyxFQUFiOztBQUNBLHdCQUF5QmlCLE1BQU0sQ0FBQ0ksT0FBUCxFQUF6Qix1S0FBMkM7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOztBQUFBOztBQUFBOztBQUFBLFFBQS9CcEMsR0FBK0I7QUFBQSxRQUE1QnFDLE1BQTRCO0FBRXpDLFFBQU1iLElBQUksR0FBR0csdUJBQXVCLENBQUNYLE1BQU0sQ0FBQ1YsSUFBUCxDQUFZK0IsTUFBSyxDQUFDLENBQUQsQ0FBakIsQ0FBRCxDQUFwQztBQUNBLFFBQUlaLEtBQUssR0FBR1ksTUFBSyxDQUFDLENBQUQsQ0FBakI7O0FBQ0EsUUFBSUEsTUFBSyxDQUFDakMsTUFBTixHQUFlLENBQWYsSUFBb0JpQyxNQUFLLENBQUMsQ0FBRCxDQUFMLEtBQWFILFNBQXJDLEVBQWdEO0FBQzlDLFVBQUlHLE1BQUssQ0FBQyxDQUFELENBQUwsS0FBYSxRQUFiLElBQXlCYixJQUFJLEtBQUssV0FBdEMsRUFBbUQ7QUFDakRDLFFBQUFBLEtBQUssR0FBR1UsUUFBUjtBQUNELE9BRkQsTUFFTyxJQUFJRSxNQUFLLENBQUMsQ0FBRCxDQUFMLEtBQWEsTUFBakIsRUFBeUI7QUFFOUJaLFFBQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDRCxJQUFkO0FBQ0Q7QUFDRjs7QUFDREMsSUFBQUEsS0FBSyxHQUFHRSx1QkFBdUIsQ0FBQ1gsTUFBTSxDQUFDVixJQUFQLENBQVltQixLQUFaLENBQUQsQ0FBL0I7O0FBQ0EsUUFBSXpCLEdBQUMsS0FBSyxDQUFWLEVBQWE7QUFDWGUsTUFBQUEsTUFBTSxJQUFJLEdBQVY7QUFDRDs7QUFDREEsSUFBQUEsTUFBTSxJQUFPUyxJQUFQLFNBQWVDLEtBQXJCO0FBQ0Q7O0FBQ0QsU0FBT1YsTUFBUDtBQUNEOztBQUVEdUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBQ2YvQixFQUFBQSxhQUFhLEVBQWJBLGFBRGU7QUFFZkssRUFBQUEsYUFBYSxFQUFiQSxhQUZlO0FBS2ZRLEVBQUFBLGVBTGUsMkJBS0NQLEtBTEQsRUFLUTtBQUNyQixXQUFPTyxnQkFBZSxDQUFDTCxNQUFNLENBQUNWLElBQVAsQ0FBWVEsS0FBWixDQUFELENBQXRCO0FBQ0QsR0FQYztBQVVmaUIsRUFBQUEsbUJBQW1CLEVBQW5CQTtBQVZlLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5jb25zdCB7IGlzQVNDSUlIZXggfSA9IHJlcXVpcmUoXCIuL2luZnJhXCIpO1xuXG5mdW5jdGlvbiBzdHJpY3RseVNwbGl0Qnl0ZVNlcXVlbmNlKGJ1ZiwgY3ApIHtcbiAgY29uc3QgbGlzdCA9IFtdO1xuICBsZXQgbGFzdCA9IDA7XG4gIGxldCBpID0gYnVmLmluZGV4T2YoY3ApO1xuICB3aGlsZSAoaSA+PSAwKSB7XG4gICAgbGlzdC5wdXNoKGJ1Zi5zbGljZShsYXN0LCBpKSk7XG4gICAgbGFzdCA9IGkgKyAxO1xuICAgIGkgPSBidWYuaW5kZXhPZihjcCwgbGFzdCk7XG4gIH1cbiAgaWYgKGxhc3QgIT09IGJ1Zi5sZW5ndGgpIHtcbiAgICBsaXN0LnB1c2goYnVmLnNsaWNlKGxhc3QpKTtcbiAgfVxuICByZXR1cm4gbGlzdDtcbn1cblxuZnVuY3Rpb24gcmVwbGFjZUJ5dGVJbkJ5dGVTZXF1ZW5jZShidWYsIGZyb20sIHRvKSB7XG4gIGxldCBpID0gYnVmLmluZGV4T2YoZnJvbSk7XG4gIHdoaWxlIChpID49IDApIHtcbiAgICBidWZbaV0gPSB0bztcbiAgICBpID0gYnVmLmluZGV4T2YoZnJvbSwgaSArIDEpO1xuICB9XG4gIHJldHVybiBidWY7XG59XG5cbmZ1bmN0aW9uIHBlcmNlbnRFbmNvZGUoYykge1xuICBsZXQgaGV4ID0gYy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTtcbiAgaWYgKGhleC5sZW5ndGggPT09IDEpIHtcbiAgICBoZXggPSBcIjBcIiArIGhleDtcbiAgfVxuXG4gIHJldHVybiBcIiVcIiArIGhleDtcbn1cblxuZnVuY3Rpb24gcGVyY2VudERlY29kZShpbnB1dCkge1xuICBjb25zdCBvdXRwdXQgPSBCdWZmZXIuYWxsb2MoaW5wdXQuYnl0ZUxlbmd0aCk7XG4gIGxldCBwdHIgPSAwO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKGlucHV0W2ldICE9PSAzNyB8fCAhaXNBU0NJSUhleChpbnB1dFtpICsgMV0pIHx8ICFpc0FTQ0lJSGV4KGlucHV0W2kgKyAyXSkpIHtcbiAgICAgIG91dHB1dFtwdHIrK10gPSBpbnB1dFtpXTtcbiAgICB9IGVsc2Uge1xuICAgICAgb3V0cHV0W3B0cisrXSA9IHBhcnNlSW50KGlucHV0LnNsaWNlKGkgKyAxLCBpICsgMykudG9TdHJpbmcoKSwgMTYpO1xuICAgICAgaSArPSAyO1xuICAgIH1cbiAgfVxuICByZXR1cm4gb3V0cHV0LnNsaWNlKDAsIHB0cik7XG59XG5cbmZ1bmN0aW9uIHBhcnNlVXJsZW5jb2RlZChpbnB1dCkge1xuICBjb25zdCBzZXF1ZW5jZXMgPSBzdHJpY3RseVNwbGl0Qnl0ZVNlcXVlbmNlKGlucHV0LCAzOCk7XG4gIGNvbnN0IG91dHB1dCA9IFtdO1xuICBmb3IgKGNvbnN0IGJ5dGVzIG9mIHNlcXVlbmNlcykge1xuICAgIGlmIChieXRlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGxldCBuYW1lO1xuICAgIGxldCB2YWx1ZTtcbiAgICBjb25zdCBpbmRleE9mRXF1YWwgPSBieXRlcy5pbmRleE9mKDYxKTtcblxuICAgIGlmIChpbmRleE9mRXF1YWwgPj0gMCkge1xuICAgICAgbmFtZSA9IGJ5dGVzLnNsaWNlKDAsIGluZGV4T2ZFcXVhbCk7XG4gICAgICB2YWx1ZSA9IGJ5dGVzLnNsaWNlKGluZGV4T2ZFcXVhbCArIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBuYW1lID0gYnl0ZXM7XG4gICAgICB2YWx1ZSA9IEJ1ZmZlci5hbGxvYygwKTtcbiAgICB9XG5cbiAgICBuYW1lID0gcmVwbGFjZUJ5dGVJbkJ5dGVTZXF1ZW5jZShCdWZmZXIuZnJvbShuYW1lKSwgNDMsIDMyKTtcbiAgICB2YWx1ZSA9IHJlcGxhY2VCeXRlSW5CeXRlU2VxdWVuY2UoQnVmZmVyLmZyb20odmFsdWUpLCA0MywgMzIpO1xuXG4gICAgb3V0cHV0LnB1c2goW3BlcmNlbnREZWNvZGUobmFtZSkudG9TdHJpbmcoKSwgcGVyY2VudERlY29kZSh2YWx1ZSkudG9TdHJpbmcoKV0pO1xuICB9XG4gIHJldHVybiBvdXRwdXQ7XG59XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZVVybGVuY29kZWRCeXRlKGlucHV0KSB7XG4gIGxldCBvdXRwdXQgPSBcIlwiO1xuICBmb3IgKGNvbnN0IGJ5dGUgb2YgaW5wdXQpIHtcbiAgICBpZiAoYnl0ZSA9PT0gMzIpIHtcbiAgICAgIG91dHB1dCArPSBcIitcIjtcbiAgICB9IGVsc2UgaWYgKGJ5dGUgPT09IDQyIHx8XG4gICAgICAgICAgICAgICBieXRlID09PSA0NSB8fFxuICAgICAgICAgICAgICAgYnl0ZSA9PT0gNDYgfHxcbiAgICAgICAgICAgICAgIChieXRlID49IDQ4ICYmIGJ5dGUgPD0gNTcpIHx8XG4gICAgICAgICAgICAgICAoYnl0ZSA+PSA2NSAmJiBieXRlIDw9IDkwKSB8fFxuICAgICAgICAgICAgICAgYnl0ZSA9PT0gOTUgfHxcbiAgICAgICAgICAgICAgIChieXRlID49IDk3ICYmIGJ5dGUgPD0gMTIyKSkge1xuICAgICAgb3V0cHV0ICs9IFN0cmluZy5mcm9tQ29kZVBvaW50KGJ5dGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXRwdXQgKz0gcGVyY2VudEVuY29kZShieXRlKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG91dHB1dDtcbn1cblxuZnVuY3Rpb24gc2VyaWFsaXplVXJsZW5jb2RlZCh0dXBsZXMsIGVuY29kaW5nT3ZlcnJpZGUgPSB1bmRlZmluZWQpIHtcbiAgbGV0IGVuY29kaW5nID0gXCJ1dGYtOFwiO1xuICBpZiAoZW5jb2RpbmdPdmVycmlkZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgZW5jb2RpbmcgPSBlbmNvZGluZ092ZXJyaWRlO1xuICB9XG5cbiAgbGV0IG91dHB1dCA9IFwiXCI7XG4gIGZvciAoY29uc3QgW2ksIHR1cGxlXSBvZiB0dXBsZXMuZW50cmllcygpKSB7XG4gICAgLy8gVE9ETzogaGFuZGxlIGVuY29kaW5nIG92ZXJyaWRlXG4gICAgY29uc3QgbmFtZSA9IHNlcmlhbGl6ZVVybGVuY29kZWRCeXRlKEJ1ZmZlci5mcm9tKHR1cGxlWzBdKSk7XG4gICAgbGV0IHZhbHVlID0gdHVwbGVbMV07XG4gICAgaWYgKHR1cGxlLmxlbmd0aCA+IDIgJiYgdHVwbGVbMl0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKHR1cGxlWzJdID09PSBcImhpZGRlblwiICYmIG5hbWUgPT09IFwiX2NoYXJzZXRfXCIpIHtcbiAgICAgICAgdmFsdWUgPSBlbmNvZGluZztcbiAgICAgIH0gZWxzZSBpZiAodHVwbGVbMl0gPT09IFwiZmlsZVwiKSB7XG4gICAgICAgIC8vIHZhbHVlIGlzIGEgRmlsZSBvYmplY3RcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5uYW1lO1xuICAgICAgfVxuICAgIH1cbiAgICB2YWx1ZSA9IHNlcmlhbGl6ZVVybGVuY29kZWRCeXRlKEJ1ZmZlci5mcm9tKHZhbHVlKSk7XG4gICAgaWYgKGkgIT09IDApIHtcbiAgICAgIG91dHB1dCArPSBcIiZcIjtcbiAgICB9XG4gICAgb3V0cHV0ICs9IGAke25hbWV9PSR7dmFsdWV9YDtcbiAgfVxuICByZXR1cm4gb3V0cHV0O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgcGVyY2VudEVuY29kZSxcbiAgcGVyY2VudERlY29kZSxcblxuICAvLyBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQgc3RyaW5nIHBhcnNlclxuICBwYXJzZVVybGVuY29kZWQoaW5wdXQpIHtcbiAgICByZXR1cm4gcGFyc2VVcmxlbmNvZGVkKEJ1ZmZlci5mcm9tKGlucHV0KSk7XG4gIH0sXG5cbiAgLy8gYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIHNlcmlhbGl6ZXJcbiAgc2VyaWFsaXplVXJsZW5jb2RlZFxufTtcbiJdfQ==