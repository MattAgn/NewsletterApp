3a6429a640c7b600c065c8aba7f85643
'use strict';

var Systrace = require('../Performance/Systrace');

var infoLog = require('./infoLog');

var performanceNow = global.nativeQPLTimestamp || global.nativePerformanceNow || require('fbjs/lib/performanceNow');

var _cookies = {};
var PRINT_TO_CONSOLE = false;

function createPerformanceLogger() {
  var result = {
    _timespans: {},
    _extras: {},
    _points: {},
    addTimespan: function addTimespan(key, lengthInMs, description) {
      if (this._timespans[key]) {
        if (__DEV__) {
          infoLog('PerformanceLogger: Attempting to add a timespan that already exists ', key);
        }

        return;
      }

      this._timespans[key] = {
        description: description,
        totalTime: lengthInMs
      };
    },
    startTimespan: function startTimespan(key, description) {
      if (this._timespans[key]) {
        if (__DEV__) {
          infoLog('PerformanceLogger: Attempting to start a timespan that already exists ', key);
        }

        return;
      }

      this._timespans[key] = {
        description: description,
        startTime: performanceNow()
      };
      _cookies[key] = Systrace.beginAsyncEvent(key);

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'start: ' + key);
      }
    },
    stopTimespan: function stopTimespan(key) {
      var timespan = this._timespans[key];

      if (!timespan || !timespan.startTime) {
        if (__DEV__) {
          infoLog('PerformanceLogger: Attempting to end a timespan that has not started ', key);
        }

        return;
      }

      if (timespan.endTime) {
        if (__DEV__) {
          infoLog('PerformanceLogger: Attempting to end a timespan that has already ended ', key);
        }

        return;
      }

      timespan.endTime = performanceNow();
      timespan.totalTime = timespan.endTime - (timespan.startTime || 0);

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'end: ' + key);
      }

      Systrace.endAsyncEvent(key, _cookies[key]);
      delete _cookies[key];
    },
    clear: function clear() {
      this._timespans = {};
      this._extras = {};
      this._points = {};

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'clear');
      }
    },
    clearCompleted: function clearCompleted() {
      for (var _key in this._timespans) {
        if (this._timespans[_key].totalTime) {
          delete this._timespans[_key];
        }
      }

      this._extras = {};
      this._points = {};

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'clearCompleted');
      }
    },
    clearExceptTimespans: function clearExceptTimespans(keys) {
      this._timespans = Object.keys(this._timespans).reduce(function (previous, key) {
        if (keys.indexOf(key) !== -1) {
          previous[key] = this._timespans[key];
        }

        return previous;
      }, {});
      this._extras = {};
      this._points = {};

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'clearExceptTimespans', keys);
      }
    },
    currentTimestamp: function currentTimestamp() {
      return performanceNow();
    },
    getTimespans: function getTimespans() {
      return this._timespans;
    },
    hasTimespan: function hasTimespan(key) {
      return !!this._timespans[key];
    },
    logTimespans: function logTimespans() {
      for (var _key2 in this._timespans) {
        if (this._timespans[_key2].totalTime) {
          infoLog(_key2 + ': ' + this._timespans[_key2].totalTime + 'ms');
        }
      }
    },
    addTimespans: function addTimespans(newTimespans, labels) {
      for (var ii = 0, l = newTimespans.length; ii < l; ii += 2) {
        var label = labels[ii / 2];
        this.addTimespan(label, newTimespans[ii + 1] - newTimespans[ii], label);
      }
    },
    setExtra: function setExtra(key, value) {
      if (this._extras[key]) {
        if (__DEV__) {
          infoLog('PerformanceLogger: Attempting to set an extra that already exists ', {
            key: key,
            currentValue: this._extras[key],
            attemptedValue: value
          });
        }

        return;
      }

      this._extras[key] = value;
    },
    getExtras: function getExtras() {
      return this._extras;
    },
    removeExtra: function removeExtra(key) {
      var value = this._extras[key];
      delete this._extras[key];
      return value;
    },
    logExtras: function logExtras() {
      infoLog(this._extras);
    },
    markPoint: function markPoint(key, timestamp) {
      var _timestamp;

      if (this._points[key]) {
        if (__DEV__) {
          infoLog('PerformanceLogger: Attempting to mark a point that has been already logged ', key);
        }

        return;
      }

      this._points[key] = (_timestamp = timestamp) != null ? _timestamp : performanceNow();
    },
    getPoints: function getPoints() {
      return this._points;
    },
    logPoints: function logPoints() {
      for (var _key3 in this._points) {
        infoLog(_key3 + ': ' + this._points[_key3] + 'ms');
      }
    },
    logEverything: function logEverything() {
      this.logTimespans();
      this.logExtras();
      this.logPoints();
    }
  };
  return result;
}

module.exports = createPerformanceLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZVBlcmZvcm1hbmNlTG9nZ2VyLmpzIl0sIm5hbWVzIjpbIlN5c3RyYWNlIiwicmVxdWlyZSIsImluZm9Mb2ciLCJwZXJmb3JtYW5jZU5vdyIsImdsb2JhbCIsIm5hdGl2ZVFQTFRpbWVzdGFtcCIsIm5hdGl2ZVBlcmZvcm1hbmNlTm93IiwiX2Nvb2tpZXMiLCJQUklOVF9UT19DT05TT0xFIiwiY3JlYXRlUGVyZm9ybWFuY2VMb2dnZXIiLCJyZXN1bHQiLCJfdGltZXNwYW5zIiwiX2V4dHJhcyIsIl9wb2ludHMiLCJhZGRUaW1lc3BhbiIsImtleSIsImxlbmd0aEluTXMiLCJkZXNjcmlwdGlvbiIsIl9fREVWX18iLCJ0b3RhbFRpbWUiLCJzdGFydFRpbWVzcGFuIiwic3RhcnRUaW1lIiwiYmVnaW5Bc3luY0V2ZW50Iiwic3RvcFRpbWVzcGFuIiwidGltZXNwYW4iLCJlbmRUaW1lIiwiZW5kQXN5bmNFdmVudCIsImNsZWFyIiwiY2xlYXJDb21wbGV0ZWQiLCJjbGVhckV4Y2VwdFRpbWVzcGFucyIsImtleXMiLCJPYmplY3QiLCJyZWR1Y2UiLCJwcmV2aW91cyIsImluZGV4T2YiLCJjdXJyZW50VGltZXN0YW1wIiwiZ2V0VGltZXNwYW5zIiwiaGFzVGltZXNwYW4iLCJsb2dUaW1lc3BhbnMiLCJhZGRUaW1lc3BhbnMiLCJuZXdUaW1lc3BhbnMiLCJsYWJlbHMiLCJpaSIsImwiLCJsZW5ndGgiLCJsYWJlbCIsInNldEV4dHJhIiwidmFsdWUiLCJjdXJyZW50VmFsdWUiLCJhdHRlbXB0ZWRWYWx1ZSIsImdldEV4dHJhcyIsInJlbW92ZUV4dHJhIiwibG9nRXh0cmFzIiwibWFya1BvaW50IiwidGltZXN0YW1wIiwiZ2V0UG9pbnRzIiwibG9nUG9pbnRzIiwibG9nRXZlcnl0aGluZyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOztBQUVBLElBQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLHlCQUFELENBQXhCOztBQUVBLElBQU1DLE9B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Rm9ELElBQUFBLFNBckxFLHVCQXFMVTtBQUNWLGFBQU8sS0FBSzFDLE9BQVo7QUFDRCxLQXZMQztBQXlMRjJDLElBQUFBLFNBekxFLHVCQXlMVTtBQUNWLFdBQUssSUFBTXpDLEtBQVgsSUFBa0IsS0FBS0YsT0FBdkIsRUFBZ0M7QUFDOUJYLFFBQUFBLE9BQU8sQ0FBQ2EsS0FBRyxHQUFHLElBQU4sR0FBYSxLQUFLRixPQUFMLENBQWFFLEtBQWIsQ0FBYixHQUFpQyxJQUFsQyxDQUFQO0FBQ0Q7QUFDRixLQTdMQztBQStMRjBDLElBQUFBLGFBL0xFLDJCQStMYztBQUNkLFdBQUtuQixZQUFMO0FBQ0EsV0FBS2MsU0FBTDtBQUNBLFdBQUtJLFNBQUw7QUFDRDtBQW5NQyxHQUpKO0FBeU1BLFNBQU85QyxNQUFQO0FBQ0Q7O0FBRURnRCxNQUFNLENBQUNDLE9BQVAsR0FBaUJsRCx1QkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgU3lzdHJhY2UgPSByZXF1aXJlKCcuLi9QZXJmb3JtYW5jZS9TeXN0cmFjZScpO1xuXG5jb25zdCBpbmZvTG9nID0gcmVxdWlyZSgnLi9pbmZvTG9nJyk7XG5jb25zdCBwZXJmb3JtYW5jZU5vdyA9XG4gIGdsb2JhbC5uYXRpdmVRUExUaW1lc3RhbXAgfHxcbiAgZ2xvYmFsLm5hdGl2ZVBlcmZvcm1hbmNlTm93IHx8XG4gIHJlcXVpcmUoJ2ZianMvbGliL3BlcmZvcm1hbmNlTm93Jyk7XG5cbnR5cGUgVGltZXNwYW4gPSB7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nLFxuICB0b3RhbFRpbWU/OiBudW1iZXIsXG4gIHN0YXJ0VGltZT86IG51bWJlcixcbiAgZW5kVGltZT86IG51bWJlcixcbn07XG5cbmV4cG9ydCB0eXBlIElQZXJmb3JtYW5jZUxvZ2dlciA9IHtcbiAgYWRkVGltZXNwYW4oc3RyaW5nLCBudW1iZXIsIHN0cmluZyB8IHZvaWQpOiB2b2lkLFxuICBzdGFydFRpbWVzcGFuKHN0cmluZywgc3RyaW5nIHwgdm9pZCk6IHZvaWQsXG4gIHN0b3BUaW1lc3BhbihzdHJpbmcpOiB2b2lkLFxuICBjbGVhcigpOiB2b2lkLFxuICBjbGVhckNvbXBsZXRlZCgpOiB2b2lkLFxuICBjbGVhckV4Y2VwdFRpbWVzcGFucyhBcnJheTxzdHJpbmc+KTogdm9pZCxcbiAgY3VycmVudFRpbWVzdGFtcCgpOiBudW1iZXIsXG4gIGdldFRpbWVzcGFucygpOiB7W2tleTogc3RyaW5nXTogVGltZXNwYW59LFxuICBoYXNUaW1lc3BhbihzdHJpbmcpOiBib29sZWFuLFxuICBsb2dUaW1lc3BhbnMoKTogdm9pZCxcbiAgYWRkVGltZXNwYW5zKEFycmF5PG51bWJlcj4sIEFycmF5PHN0cmluZz4pOiB2b2lkLFxuICBzZXRFeHRyYShzdHJpbmcsIGFueSk6IHZvaWQsXG4gIGdldEV4dHJhcygpOiB7W2tleTogc3RyaW5nXTogYW55fSxcbiAgcmVtb3ZlRXh0cmEoc3RyaW5nKTogP2FueSxcbiAgbG9nRXh0cmFzKCk6IHZvaWQsXG4gIG1hcmtQb2ludChzdHJpbmcsIG51bWJlciB8IHZvaWQpOiB2b2lkLFxuICBnZXRQb2ludHMoKToge1trZXk6IHN0cmluZ106IG51bWJlcn0sXG4gIGxvZ1BvaW50cygpOiB2b2lkLFxuICBsb2dFdmVyeXRoaW5nKCk6IHZvaWQsXG59O1xuXG5jb25zdCBfY29va2llczoge1trZXk6IHN0cmluZ106IG51bWJlcn0gPSB7fTtcblxuY29uc3QgUFJJTlRfVE9fQ09OU09MRTogZmFsc2UgPSBmYWxzZTsgLy8gVHlwZSBhcyBmYWxzZSB0byBwcmV2ZW50IGFjY2lkZW50YWxseSBjb21taXR0aW5nIGB0cnVlYDtcblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGNyZWF0ZXMgcGVmb3JtYW5jZSBsb2dnZXJzIHRoYXQgY2FuIGJlIHVzZWQgdG8gY29sbGVjdCBhbmQgbG9nXG4gKiB2YXJpb3VzIHBlcmZvcm1hbmNlIGRhdGEgc3VjaCBhcyB0aW1lc3BhbnMsIHBvaW50cyBhbmQgZXh0cmFzLlxuICogVGhlIGxvZ2dlcnMgbmVlZCB0byBoYXZlIG1pbmltYWwgb3ZlcmhlYWQgc2luY2UgdGhleSdyZSB1c2VkIGluIHByb2R1Y3Rpb24uXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVBlcmZvcm1hbmNlTG9nZ2VyKCk6IElQZXJmb3JtYW5jZUxvZ2dlciB7XG4gIGNvbnN0IHJlc3VsdDogSVBlcmZvcm1hbmNlTG9nZ2VyICYge1xuICAgIF90aW1lc3BhbnM6IHtba2V5OiBzdHJpbmddOiBUaW1lc3Bhbn0sXG4gICAgX2V4dHJhczoge1trZXk6IHN0cmluZ106IGFueX0sXG4gICAgX3BvaW50czoge1trZXk6IHN0cmluZ106IG51bWJlcn0sXG4gIH0gPSB7XG4gICAgX3RpbWVzcGFuczoge30sXG4gICAgX2V4dHJhczoge30sXG4gICAgX3BvaW50czoge30sXG5cbiAgICBhZGRUaW1lc3BhbihrZXk6IHN0cmluZywgbGVuZ3RoSW5NczogbnVtYmVyLCBkZXNjcmlwdGlvbj86IHN0cmluZykge1xuICAgICAgaWYgKHRoaXMuX3RpbWVzcGFuc1trZXldKSB7XG4gICAgICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICAgICAgaW5mb0xvZyhcbiAgICAgICAgICAgICdQZXJmb3JtYW5jZUxvZ2dlcjogQXR0ZW1wdGluZyB0byBhZGQgYSB0aW1lc3BhbiB0aGF0IGFscmVhZHkgZXhpc3RzICcsXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX3RpbWVzcGFuc1trZXldID0ge1xuICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24sXG4gICAgICAgIHRvdGFsVGltZTogbGVuZ3RoSW5NcyxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIHN0YXJ0VGltZXNwYW4oa2V5OiBzdHJpbmcsIGRlc2NyaXB0aW9uPzogc3RyaW5nKSB7XG4gICAgICBpZiAodGhpcy5fdGltZXNwYW5zW2tleV0pIHtcbiAgICAgICAgaWYgKF9fREVWX18pIHtcbiAgICAgICAgICBpbmZvTG9nKFxuICAgICAgICAgICAgJ1BlcmZvcm1hbmNlTG9nZ2VyOiBBdHRlbXB0aW5nIHRvIHN0YXJ0IGEgdGltZXNwYW4gdGhhdCBhbHJlYWR5IGV4aXN0cyAnLFxuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl90aW1lc3BhbnNba2V5XSA9IHtcbiAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxuICAgICAgICBzdGFydFRpbWU6IHBlcmZvcm1hbmNlTm93KCksXG4gICAgICB9O1xuICAgICAgX2Nvb2tpZXNba2V5XSA9IFN5c3RyYWNlLmJlZ2luQXN5bmNFdmVudChrZXkpO1xuICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUpIHtcbiAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXIuanMnLCAnc3RhcnQ6ICcgKyBrZXkpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBzdG9wVGltZXNwYW4oa2V5OiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IHRpbWVzcGFuID0gdGhpcy5fdGltZXNwYW5zW2tleV07XG4gICAgICBpZiAoIXRpbWVzcGFuIHx8ICF0aW1lc3Bhbi5zdGFydFRpbWUpIHtcbiAgICAgICAgaWYgKF9fREVWX18pIHtcbiAgICAgICAgICBpbmZvTG9nKFxuICAgICAgICAgICAgJ1BlcmZvcm1hbmNlTG9nZ2VyOiBBdHRlbXB0aW5nIHRvIGVuZCBhIHRpbWVzcGFuIHRoYXQgaGFzIG5vdCBzdGFydGVkICcsXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAodGltZXNwYW4uZW5kVGltZSkge1xuICAgICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICAgIGluZm9Mb2coXG4gICAgICAgICAgICAnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gZW5kIGEgdGltZXNwYW4gdGhhdCBoYXMgYWxyZWFkeSBlbmRlZCAnLFxuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aW1lc3Bhbi5lbmRUaW1lID0gcGVyZm9ybWFuY2VOb3coKTtcbiAgICAgIHRpbWVzcGFuLnRvdGFsVGltZSA9IHRpbWVzcGFuLmVuZFRpbWUgLSAodGltZXNwYW4uc3RhcnRUaW1lIHx8IDApO1xuICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUpIHtcbiAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXIuanMnLCAnZW5kOiAnICsga2V5KTtcbiAgICAgIH1cblxuICAgICAgU3lzdHJhY2UuZW5kQXN5bmNFdmVudChrZXksIF9jb29raWVzW2tleV0pO1xuICAgICAgZGVsZXRlIF9jb29raWVzW2tleV07XG4gICAgfSxcblxuICAgIGNsZWFyKCkge1xuICAgICAgdGhpcy5fdGltZXNwYW5zID0ge307XG4gICAgICB0aGlzLl9leHRyYXMgPSB7fTtcbiAgICAgIHRoaXMuX3BvaW50cyA9IHt9O1xuICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUpIHtcbiAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXIuanMnLCAnY2xlYXInKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgY2xlYXJDb21wbGV0ZWQoKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLl90aW1lc3BhbnMpIHtcbiAgICAgICAgaWYgKHRoaXMuX3RpbWVzcGFuc1trZXldLnRvdGFsVGltZSkge1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLl90aW1lc3BhbnNba2V5XTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5fZXh0cmFzID0ge307XG4gICAgICB0aGlzLl9wb2ludHMgPSB7fTtcbiAgICAgIGlmIChQUklOVF9UT19DT05TT0xFKSB7XG4gICAgICAgIGluZm9Mb2coJ1BlcmZvcm1hbmNlTG9nZ2VyLmpzJywgJ2NsZWFyQ29tcGxldGVkJyk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIGNsZWFyRXhjZXB0VGltZXNwYW5zKGtleXM6IEFycmF5PHN0cmluZz4pIHtcbiAgICAgIHRoaXMuX3RpbWVzcGFucyA9IE9iamVjdC5rZXlzKHRoaXMuX3RpbWVzcGFucykucmVkdWNlKGZ1bmN0aW9uKFxuICAgICAgICBwcmV2aW91cyxcbiAgICAgICAga2V5LFxuICAgICAgKSB7XG4gICAgICAgIGlmIChrZXlzLmluZGV4T2Yoa2V5KSAhPT0gLTEpIHtcbiAgICAgICAgICBwcmV2aW91c1trZXldID0gdGhpcy5fdGltZXNwYW5zW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHByZXZpb3VzO1xuICAgICAgfSxcbiAgICAgIHt9KTtcbiAgICAgIHRoaXMuX2V4dHJhcyA9IHt9O1xuICAgICAgdGhpcy5fcG9pbnRzID0ge307XG4gICAgICBpZiAoUFJJTlRfVE9fQ09OU09MRSkge1xuICAgICAgICBpbmZvTG9nKCdQZXJmb3JtYW5jZUxvZ2dlci5qcycsICdjbGVhckV4Y2VwdFRpbWVzcGFucycsIGtleXMpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBjdXJyZW50VGltZXN0YW1wKCkge1xuICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlTm93KCk7XG4gICAgfSxcblxuICAgIGdldFRpbWVzcGFucygpIHtcbiAgICAgIHJldHVybiB0aGlzLl90aW1lc3BhbnM7XG4gICAgfSxcblxuICAgIGhhc1RpbWVzcGFuKGtleTogc3RyaW5nKSB7XG4gICAgICByZXR1cm4gISF0aGlzLl90aW1lc3BhbnNba2V5XTtcbiAgICB9LFxuXG4gICAgbG9nVGltZXNwYW5zKCkge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5fdGltZXNwYW5zKSB7XG4gICAgICAgIGlmICh0aGlzLl90aW1lc3BhbnNba2V5XS50b3RhbFRpbWUpIHtcbiAgICAgICAgICBpbmZvTG9nKGtleSArICc6ICcgKyB0aGlzLl90aW1lc3BhbnNba2V5XS50b3RhbFRpbWUgKyAnbXMnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG5cbiAgICBhZGRUaW1lc3BhbnMobmV3VGltZXNwYW5zOiBBcnJheTxudW1iZXI+LCBsYWJlbHM6IEFycmF5PHN0cmluZz4pIHtcbiAgICAgIGZvciAobGV0IGlpID0gMCwgbCA9IG5ld1RpbWVzcGFucy5sZW5ndGg7IGlpIDwgbDsgaWkgKz0gMikge1xuICAgICAgICBjb25zdCBsYWJlbCA9IGxhYmVsc1tpaSAvIDJdO1xuICAgICAgICB0aGlzLmFkZFRpbWVzcGFuKGxhYmVsLCBuZXdUaW1lc3BhbnNbaWkgKyAxXSAtIG5ld1RpbWVzcGFuc1tpaV0sIGxhYmVsKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgc2V0RXh0cmEoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICAgIGlmICh0aGlzLl9leHRyYXNba2V5XSkge1xuICAgICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICAgIGluZm9Mb2coXG4gICAgICAgICAgICAnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gc2V0IGFuIGV4dHJhIHRoYXQgYWxyZWFkeSBleGlzdHMgJyxcbiAgICAgICAgICAgIHtrZXksIGN1cnJlbnRWYWx1ZTogdGhpcy5fZXh0cmFzW2tleV0sIGF0dGVtcHRlZFZhbHVlOiB2YWx1ZX0sXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLl9leHRyYXNba2V5XSA9IHZhbHVlO1xuICAgIH0sXG5cbiAgICBnZXRFeHRyYXMoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fZXh0cmFzO1xuICAgIH0sXG5cbiAgICByZW1vdmVFeHRyYShrZXk6IHN0cmluZyk6ID9hbnkge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9leHRyYXNba2V5XTtcbiAgICAgIGRlbGV0ZSB0aGlzLl9leHRyYXNba2V5XTtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuXG4gICAgbG9nRXh0cmFzKCkge1xuICAgICAgaW5mb0xvZyh0aGlzLl9leHRyYXMpO1xuICAgIH0sXG5cbiAgICBtYXJrUG9pbnQoa2V5OiBzdHJpbmcsIHRpbWVzdGFtcD86IG51bWJlcikge1xuICAgICAgaWYgKHRoaXMuX3BvaW50c1trZXldKSB7XG4gICAgICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICAgICAgaW5mb0xvZyhcbiAgICAgICAgICAgICdQZXJmb3JtYW5jZUxvZ2dlcjogQXR0ZW1wdGluZyB0byBtYXJrIGEgcG9pbnQgdGhhdCBoYXMgYmVlbiBhbHJlYWR5IGxvZ2dlZCAnLFxuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5fcG9pbnRzW2tleV0gPSB0aW1lc3RhbXAgPz8gcGVyZm9ybWFuY2VOb3coKTtcbiAgICB9LFxuXG4gICAgZ2V0UG9pbnRzKCkge1xuICAgICAgcmV0dXJuIHRoaXMuX3BvaW50cztcbiAgICB9LFxuXG4gICAgbG9nUG9pbnRzKCkge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5fcG9pbnRzKSB7XG4gICAgICAgIGluZm9Mb2coa2V5ICsgJzogJyArIHRoaXMuX3BvaW50c1trZXldICsgJ21zJyk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIGxvZ0V2ZXJ5dGhpbmcoKSB7XG4gICAgICB0aGlzLmxvZ1RpbWVzcGFucygpO1xuICAgICAgdGhpcy5sb2dFeHRyYXMoKTtcbiAgICAgIHRoaXMubG9nUG9pbnRzKCk7XG4gICAgfSxcbiAgfTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjcmVhdGVQZXJmb3JtYW5jZUxvZ2dlcjtcbiJdfQ==